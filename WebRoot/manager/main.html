<!DOCTYPE html>
<html lang="cn">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <!-- Title and other stuffs -->
  <title>后台管理系统</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="keywords" content="DocSys" />
  <meta name="description" content="DocSys管理后台" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Rainy">
  <!-- Stylesheets -->
  <link href="./static/style/bootstrap.css" rel="stylesheet">
  <!-- Font awesome icon -->
  <link rel="stylesheet" href="./static/style/font-awesome.css">
  <!-- jQuery UI -->
  <link rel="stylesheet" href="./static/style/jquery-ui.css">
  <!-- Calendar -->
  <link rel="stylesheet" href="./static/style/fullcalendar.css">
  <!-- prettyPhoto -->
  <link rel="stylesheet" href="./static/style/prettyPhoto.css">
  <!-- Star rating -->
  <link rel="stylesheet" href="./static/style/rateit.css">
  <!-- Date picker -->
  <link rel="stylesheet" href="./static/style/bootstrap-datetimepicker.min.css">
  <!-- CLEditor -->
  <link rel="stylesheet" href="./static/style/jquery.cleditor.css">
  <!-- Bootstrap toggle -->
  <link rel="stylesheet" href="./static/style/bootstrap-switch.css">
  <!-- Main stylesheet -->
  <link href="./static/style/style.css" rel="stylesheet">
  <!-- Widgets stylesheet -->
  <link href="./static/style/widgets.css" rel="stylesheet">
  
  <!-- jQuery -->
  <script src="./static/js/jquery.js"></script>
  <script src="./static/js/bootstrap.js"></script> <!-- Bootstrap -->
  <script src="./static/js/jquery-ui-1.9.2.custom.min.js"></script> <!-- jQuery UI -->
  <script src="./static/js/fullcalendar.min.js"></script> <!-- Full Google Calendar - Calendar -->
  <script src="./static/js/jquery.rateit.min.js"></script> <!-- RateIt - Star rating -->
  <script src="./static/js/jquery.prettyPhoto.js"></script> <!-- prettyPhoto -->
  <script src="./static/js/ajaxfileupload.js"></script>

  <!-- jQuery Flot -->
  <script src="./static/js/excanvas.min.js"></script>
  <script src="./static/js/jquery.flot.js"></script>
  <script src="./static/js/jquery.flot.resize.js"></script>
  <script src="./static/js/jquery.flot.pie.js"></script>
  <script src="./static/js/jquery.flot.stack.js"></script>

  <!-- jQuery Notification - Noty -->
  <script src="./static/js/jquery.noty.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/themes/default.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/bottom.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/topRight.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/top.js"></script> <!-- jQuery Notify -->
  <!-- jQuery Notification ends -->


  <script src="./static/js/sparklines.js"></script> <!-- Sparklines -->
  <script src="./static/js/jquery.cleditor.min.js"></script> <!-- CLEditor -->
  <script src="./static/js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
  <script src="./static/js/bootstrap-switch.min.js"></script> <!-- Bootstrap Toggle -->

  <script src="./static/js/jquery.raty.js"></script>
  <script src="./static/js/jquery.toastmessage-min.js"></script>
  <script src="./static/js/filter.js"></script> <!-- Filter for support page -->
  <script src="./static/js/custom.js"></script> <!-- Custom codes -->
  <script src="./static/js/md5.js"></script>
  <script src="./static/js/config.js"></script>
  <script src="./static/js/tmpl.js"></script>
  
  <!-- bootstrapQ based on jquery and bootstrap-->
  <link href="./static/bootstrapQ/qiao.css" rel="stylesheet">
  <script type="text/javascript" src="./static/bootstrapQ/qiao.js"></script>  
  

  <!-- HTML5 Support for IE -->
  <!--[if lt IE 9]>
  <script src="./static/js/html5shim.js"></script>
  <![endif]-->

  <!-- Favicon -->
  <link rel="shortcut icon" href="./static/img/icons/metro.png">
</head>

<body>

<div class="navbar navbar-fixed-top bs-docs-nav" role="banner">

  <div class="conjtainer">
    <!-- Menu button for smallar screens -->
    <div class="navbar-header">
      <button class="navbar-toggle btn-navbar" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span>菜单</span>
      </button>
      <!-- Site name for smallar screens -->
      <a href="./" class="navbar-brand hidden-lg">首页</a>
    </div>



    <!-- Navigation starts -->
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

      <!-- Links -->
      <ul class="nav navbar-nav pull-right" id="headbar" data-tmpl="headbar">

      </ul>
    </nav>

  </div>
</div>


<!-- Header starts -->
<header>
  <div class="container">
    <div class="row">

      <!-- Logo section -->
      <div class="col-md-4">
        <!-- Logo. -->
        <div class="logo">
          <h1><a href="#">DocSys<span class="bold"></span></a></h1>
          <p class="meta">后台管理系统</p>
        </div>
        <!-- Logo ends -->
      </div>

      <!-- Data section -->

      <div class="col-md-5" style="float: right" id="metainfo">

      </div>

    </div>
  </div>
</header>

<!-- Header ends -->

<!-- Main content starts -->




<div class="content">
<div class="sidebar" id="sidebar" data-tmpl="sidebar">
</div>

<!-- Main bar -->
<div class="mainbar" >
    <!-- Page heading -->
    <div class="page-head" id="pagehead">
    </div>
    <!-- Page heading ends -->


  <!-- Matter -->
  <div class="matter">
    <div class="container" id="container">




    </div>
  </div>
  <!-- Matter ends -->

</div>



<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="zoom: 1.5;">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    拒绝原因
                </h4>
            </div>
            <div class="modal-body">
                <p><input name="reason" type="checkbox"  value="您提交的内容不完整，请补全。"  id="btn1"/> 您提交的内容不完整，请补全。</p>
                <p><input name="reason" type="checkbox"  value="您提交的内容与实际不符，请修改。" id="btn2"/> 您提交的内容与实际不符，请修改。</p>
                <p><input name="reason" type="checkbox" value="您提交的内容非法，请修改。" id="btn3"/> 您提交的内容非法，请修改。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="conExamine()">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


<!-- 模态框（Modal） -->
<div class="modal fade" id="addUser" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="zoom: 1.5;">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">
                    手动添加用户
                </h4>
            </div>
            <div class="modal-body">
                <p>昵称 ： <input style="width: 80%" id="nickname"/></p>
                <p>全称 ： <input style="width: 80%" id="realname"/></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="addUser()">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


<!-- Mainbar ends -->
<div class="clearfix"></div>

</div>
<!-- Content ends -->

<!-- Footer starts -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <!-- Copyright info -->
        <p class="copy">Copyright &copy; 2017 | <a href="http://dw.gofreeteam.com/DocSystem">DocSys</a> </p>
      </div>
    </div>
  </div>
</footer>

<!-- Footer ends -->

<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="icon-chevron-up"></i></a></span>

<script type="application/javascript">
	//通用函数接口
	function showErrorMessage($msg) {
		qiao.bs.alert($msg);
	}
	
  function addToUrlParam(key,value,url){
    var ref = "";
    if( url ){
      ref = url;
    }
    else
    {
      ref = location.href;
    }
    if( ref.endsWith("#") ){
      ref = ref.substr(0,ref.length -1);
    }
    if( ref.indexOf("?") > 0 ){
      var p = getQuery(key);
      if( p ){
        var end = ref.replace(key + "=" + p,key + "=" + value);
        return end;
      }else{
        return ref + "&"+ key +"=" + value;
      }
    }else{
      return ref + "?" + key + "=" + value;
    }
  }

  $(document).on("changePage",function(e,msg){
    location.href = addToUrlParam("page",msg.page);
  });
    
</script>

<script type="application/javascript">
  var curPage = 1;
  
</script>


<script type="application/javascript">
	pageInit();
	
	//页面初始化
	var loginUser = "";	//用来保存刚注册的用户、或刚才登录的用户
	function pageInit()
	{
		console.log("pageInit");
		//确定当前登录用户是否已登录
		$.ajax({
	        url : "/DocSystem/getLoginUser.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	//Get用户信息
					var user = ret.data;
					loginUser = user;
					console.log("user",user);
	            	//显示用户信息
	                $Func.render($("#headbar"),"headbar",user);
					//显示菜单
	            	$Func.render($("#sidebar"),"sidebar");	//用户crrent参数来渲染sidebar.html文件
					//显示内容部分
	            	showContentPage("user");	            	
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                window.location.href = "login.html";
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户信息失败");
	        }
	    });
	}

	//click event handler  for data-eb-event="content.refresh"
	$(document).on("click","[data-eb-event]", function () {
		console.log("data-eb-event click handler");
		
        var event = $(this).attr("data-eb-event");
        var params = $(this).attr("data-eb-params");
      	
        console.log("data-eb-event:"+ event + " " + params);
        
        //非回调方式更加容易被理解，so I give up the event bus 
        switch(event)
        {
        //菜单点击
        case "content.refresh":
        	showContentPage(params);
        	break;
        }
    });
	
	  //展开子项目
	  $(document).on("click",".has_sub",function(){
	      var title = $(this).children("a");
	      if( title.hasClass("subdrop") ){
	          title.removeClass("subdrop");
	          $(this).children("ul").hide();
	      }else{
	          title.addClass("subdrop");
	          $(this).children("ul").show();
	      }
	  });

	  //展开子目录
	  $(document).on("click","li.has_sublist",function(){
	      var $this = $(this);
	      if( ! $this.children("a").hasClass("open") ){
	          $this.children("ul.sublist").toggle();
	      }

	  });
	
	//显示对应菜单
	function showContentPage(curPath) {
	    console.log("showContentPage() " + curPath);
		var title = "载入中...";
	    var subtitle = "载入中...";
		
	    $("#container").html("载入中...");
	
	    $("#nav li>a").removeClass("open");
	    $("ul.sublist").hide();
	
	    switch ( curPath ){
	        case "user":
	            title = "用户管理";
	            showUserList();
	            $("#nav li[data-eb-params=ctrl]>a").addClass("open");
	            $("ul.sublist").show();
	            break;
	        case "group":
	            title = "用户组管理";
	            showGroupList();
	            $("#nav li[data-eb-params=ctrl]>a").addClass("open");
	            $("ul.sublist").show();
	            break;
	        case "suggest":
	            title = "意见建议";
	            $("#nav li[data-eb-params=suggest]>a").addClass("open");
	            bus.trigger("Suggest.refresh");
	            break;
	    }
	
	    $Func.render($("#pagehead"),"pagehead",{
	        title : title,
	        subtitle : title
	    });
	}



	//成员管理
	function showUserList(){
		
		$.ajax({
	        url : "/DocSystem/Manage/getUserList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	console.log("userList",ret.data);
	            	UserListDisplay(ret.data);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户列表失败");
	        }
	    });
	}
	
	function UserListDisplay(list)
    {
		$Func.render($("#container"),"user",{"list":list});
    }

	//角色管理
	function showGroupList(){
		$.ajax({
	        url : "/DocSystem/Manage/getGroupList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	GroupListDisplay(ret.data);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户列表失败");
	        }
	    });
	}

	function GroupListDisplay(list)
	{
		$Func.render($("#container"),"group",{"list":list});
	}
		
	// 快速查找指定的项
	function fastSearch(_this){
	    var $this = $(_this);
	    var event = $this.attr("data-eb-xevent");
	    var event2 = $("#examine").attr("data-eb-xparam");
	    var value = $this.val();
	    var type = $this.attr("data-type");
	
	    $Current.ajax(event,{name:value,type:type},function(ret){
	        console.log(ret);
	        ret.data.page.curExamine = "0";
	        bus.trigger(event2,ret.data.page);
	    });
	}


	function toPage(num){
	    var $this = $("#examine");
	    var event = $this.attr("data-eb-xevent");
	    var value = $this.val();
	    bus.trigger(event,value,num);
	
	}

	function examineChange(_this){
	    var $this = $(_this);
	    var event = $this.attr("data-eb-xevent");
	    var value = $this.val();
	    bus.trigger(event,value);
	}

	var msgServer = "//www.gofreeteam.com";
	var okTmpl = "1498000";
	var errTmpl = "1498002";
	function sendEmail(email,content){
	    try{
	        if(email){
	            $.get( msgServer +  "/email/sendEmail.do?token=$&toEmail=" + email + "&content=" + encodeURI(encodeURI(content)) + "&r=" + Math.random())
	        }
	    }catch (e){
	        console.log(e);
	    }
	
	}


	function sendSMS(tel,tmpl,type,content){
	    try{
	        if(tel){
	            var url = msgServer +  "/SMS/sendSms.do?token=$&code=&phone=" + tel
	                    +  "&tplId=" + tmpl + "&type=" + encodeURI(encodeURI(type)) + "&r=" + Math.random();
	            if( content ){
	                url += "&content=" + encodeURI(encodeURI(content));
	            }
	            $.get( url );
	        }
	    }
	    catch (e){
	        console.log(e);
	    }
	}

	function conExamine(){
	    $('#myModal').modal('hide')
	    var msg = ' ';
	    if ( $('#btn1').is(':checked') ){
	        msg += $('#btn1').val();
	    }
	    if ( $('#btn2').is(':checked') ){
	        msg += $('#btn2').val();
	    }
	    if ( $('#btn3').is(':checked') ){
	        msg += $('#btn3').val();
	    }
	    args[7] = msg;
	    //alert(msg);
	    $('#btn1').attr("checked",false);
	    $('#btn2').attr("checked",false);
	    $('#btn3').attr("checked",false);
	    examine.apply(this,args);
	}

	function examine(event,id,flag,nextEvent,tel,email,type,content){
	
	    if( flag != 2){
	        sendEmail(email,"您的" + type + "已通过审核");
	        sendSMS(tel,okTmpl,type,content);
	    }else {
	        if( ! content ){
	            // 保存参数
	            args = Array.prototype.slice.call(arguments);
	            return;
	        }else{
	            sendEmail(email,"您的" + type + "未通过审核,原因:" + content);
	            sendSMS(tel,errTmpl,type,content);
	        }
	    }
	
	    var dotIndex = event.indexOf(".");
	    var eventName = event;
	    if( dotIndex > 0 ){
	        eventName = event.substring(dotIndex+1);
	    }
	    $Current.ajax(event,{
	        id:id,
	        flag:flag,
	        event: eventName
	    },function(ret){
	        if( event.startsWith("Service") ){
	            bus.trigger("Service.refresh",$("#examine").val(),curPage);
	        }else if( event.startsWith("Project") ){
	            bus.trigger("Project.refresh",$("#examine").val(),curPage);
	        }else{
	            bus.trigger(nextEvent,$("#examine").val(),curPage);
	
	        }
	    });
	}

	function addUser(){
	    var name = $("#name").val();
	    var pwd = $("#password").val();
	    var role = $("#type").val();
	    $Current.ajax("Admin.add",{
	        name :name,
	        role : role,
	        pwd : MD5(pwd)
	    },function(ret){
	        bus.trigger("Admin.refresh");
	    });
	}
	
	
	function delUser(id){
	    $Current.ajax("Admin.delete",{
	        id :id
	    },function(ret){
	        bus.trigger("Admin.refresh");
	    });
	}

	function exit(){
	    $.post("./admin/logout", function () {
	        localStorage.session = '';
	        localStorage.curUser = '';
	        location.href = "./?r=" + Math.random();
	    });
	}


	function toedit(id) {
	    $Current.ajax("/admin/getToken",{},function(ret){
	        console.log(ret);
	        window.open($Current.editUrl + id + "&token="+ ret.data.token);
	    });
	}

</script>
</body>
</html>