<!DOCTYPE html>
<html lang="cn">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <!-- Title and other stuffs -->
  <title>后台管理系统</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="keywords" content="MxsDoc" />
  <meta name="description" content="MxsDoc管理后台" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Rainy">
  <!-- Stylesheets -->
  <link href="./static/style/bootstrap.css" rel="stylesheet">
  <!-- Font awesome icon -->
  <link rel="stylesheet" href="./static/style/font-awesome.css">
  <!-- jQuery UI -->
  <link rel="stylesheet" href="./static/style/jquery-ui.css">
  <!-- Calendar -->
  <link rel="stylesheet" href="./static/style/fullcalendar.css">
  <!-- prettyPhoto -->
  <link rel="stylesheet" href="./static/style/prettyPhoto.css">
  <!-- Star rating -->
  <link rel="stylesheet" href="./static/style/rateit.css">
  <!-- Date picker -->
  <link rel="stylesheet" href="./static/style/bootstrap-datetimepicker.min.css">
  <!-- CLEditor -->
  <link rel="stylesheet" href="./static/style/jquery.cleditor.css">
  <!-- Bootstrap toggle -->
  <link rel="stylesheet" href="./static/style/bootstrap-switch.css">
  <!-- Main stylesheet -->
  <link href="./static/style/style.css" rel="stylesheet">
  <!-- Widgets stylesheet -->
  <link href="./static/style/widgets.css" rel="stylesheet">
  
  <!-- jQuery -->
  <script src="./static/js/jquery.js"></script>
  <script src="./static/js/bootstrap.js"></script> <!-- Bootstrap -->
  <script src="./static/js/jquery-ui-1.9.2.custom.min.js"></script> <!-- jQuery UI -->
  <script src="./static/js/fullcalendar.min.js"></script> <!-- Full Google Calendar - Calendar -->
  <script src="./static/js/jquery.rateit.min.js"></script> <!-- RateIt - Star rating -->
  <script src="./static/js/jquery.prettyPhoto.js"></script> <!-- prettyPhoto -->
  <script src="./static/js/ajaxfileupload.js"></script>

  <!-- jQuery Flot -->
  <script src="./static/js/excanvas.min.js"></script>
  <script src="./static/js/jquery.flot.js"></script>
  <script src="./static/js/jquery.flot.resize.js"></script>
  <script src="./static/js/jquery.flot.pie.js"></script>
  <script src="./static/js/jquery.flot.stack.js"></script>

  <!-- jQuery Notification - Noty -->
  <script src="./static/js/jquery.noty.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/themes/default.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/bottom.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/topRight.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/top.js"></script> <!-- jQuery Notify -->
  <!-- jQuery Notification ends -->


  <script src="./static/js/sparklines.js"></script> <!-- Sparklines -->
  <script src="./static/js/jquery.cleditor.min.js"></script> <!-- CLEditor -->
  <script src="./static/js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
  <script src="./static/js/bootstrap-switch.min.js"></script> <!-- Bootstrap Toggle -->

  <script src="./static/js/jquery.raty.js"></script>
  <script src="./static/js/jquery.toastmessage-min.js"></script>
  <script src="./static/js/filter.js"></script> <!-- Filter for support page -->
  <script src="./static/js/custom.js"></script> <!-- Custom codes -->
  <script src="./static/js/config.js"></script>
  <script src="./static/js/tmpl.js"></script>
  
  <!-- bootstrapQ based on jquery and bootstrap-->
  <link href="./static/bootstrapQ/qiao.css" rel="stylesheet">
  <script type="text/javascript" src="./static/bootstrapQ/qiao.js"></script>
  <!-- Favicon -->
  <link rel="shortcut icon" href="./static/img/icons/metro.png">

    <!-- pagination -->
    <link rel="stylesheet" href="./static/pagination/pagination.css"/>
    <script type="text/javascript" src="./static/pagination/jquery.pagination.js"></script>
</head>

<body>

<div class="navbar navbar-fixed-top bs-docs-nav" role="banner">

  <div class="conjtainer">
    <!-- Menu button for smallar screens -->
    <div class="navbar-header">
      <button class="navbar-toggle btn-navbar" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span>菜单</span>
      </button>
      <!-- Site name for smallar screens -->
      <a href="./" class="navbar-brand hidden-lg">首页</a>
    </div>
    <!-- Navigation starts -->
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <!-- Links -->
      <ul class="nav navbar-nav pull-right" id="headbar" data-tmpl="headbar">
      </ul>
    </nav>
  </div>
</div>

<!-- Header starts -->
<header>
  <div class="container">
    <div class="row">
      <!-- Logo section -->
      <div class="col-md-4">
        <!-- Logo. -->
        <div class="logo">
          <h1><a href="/DocSystem">MxsDoc<span class="bold"></span></a></h1>
          <p class="meta">后台管理系统</p>
        </div>
        <!-- Logo ends -->
      </div>

      <!-- Data section -->

      <div class="col-md-5" style="float: right" id="metainfo">

      </div>

    </div>
  </div>
</header>

<!-- Header ends -->

<!-- Main content starts -->

<div class="content">
<div class="sidebar" id="sidebar" data-tmpl="sidebar">
</div>

<!-- Main bar -->
<div class="mainbar" >
    <!-- Page heading -->
    <div class="page-head" id="pagehead">
    </div>
    <!-- Page heading ends -->


  <!-- Matter -->
  <div class="matter">
    <div class="container" id="container">

    </div>
  </div>
  <!-- Matter ends -->

</div>

<!-- Mainbar ends -->
<div class="clearfix"></div>

</div>
<!-- Content ends -->

<!-- Footer starts -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <!-- Copyright info -->
        <p class="copy">Copyright &copy; 2017 | <a href="http://dw.gofreeteam.com/DocSystem">MxsDoc</a> </p>
      </div>
    </div>
  </div>
</footer>

<!-- Footer ends -->

<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="icon-chevron-up"></i></a></span>

<div style="display:none">
	<input id="importDBFiles" name="importDBFiles" type="file" onchange="importDBDataConfirm(event)" multiple="multiple"/>
	<input id="upgradeFiles" name="upgradeFiles" type="file" onchange="upgradeSystemConfirm(event)" multiple="multiple"/>
	<input id="importLicenseFiles" name="importLicenseFiles" type="file" onchange="importLicenseConfirm(event)" multiple="multiple"/>
	<input id="installSystemLicense" name="installSystemLicense" type="file" onchange="installSystemLicenseConfirm(event)" multiple="multiple"/>
	<input id="installOffice" name="installOffice" type="file" onchange="installOfficeConfirm(event)" multiple="multiple"/>
</div>

<script type="application/javascript">
  //通用函数接口
  function showErrorMessage($msg) {
	 qiao.bs.alert($msg);
  }
	
  function addToUrlParam(key,value,url){
    var ref = "";
    if( url ){
      ref = url;
    }
    else
    {
      ref = location.href;
    }
    if( ref.endsWith("#") ){
      ref = ref.substr(0,ref.length -1);
    }
    if( ref.indexOf("?") > 0 ){
      var p = getQuery(key);
      if( p ){
        var end = ref.replace(key + "=" + p,key + "=" + value);
        return end;
      }else{
        return ref + "&"+ key +"=" + value;
      }
    }else{
      return ref + "?" + key + "=" + value;
    }
  }

  $(document).on("changePage",function(e,msg){
    location.href = addToUrlParam("page",msg.page);
  });
    
</script>

<script type="application/javascript">
	var gDocSysConfig = null;
	var gPageIndex = 0;
	var gPageSize = 15;
	var gTotal = 0;

	pageInit();
	
	//页面初始化
	var loginUser = "";	//用来保存刚注册的用户、或刚才登录的用户
	function pageInit()
	{
		console.log("pageInit");
		getDocSysConfig();
		
		//确定当前登录用户是否已登录
		$.ajax({
	        url : "/DocSystem/User/getLoginUser.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
				console.log("getLoginUser ret",ret);
	        	if( "ok" == ret.status )
	            {
	            	//Get用户信息
					var user = ret.data;
					var total = ret.dataEx; //查询结果总数
					
	            	loginUser = user;
					if(!user.type || user.type < 1)
					{
		        		showErrorMessage("非管理员用户，请联系系统管理员");
					}
					else
					{
						//显示用户信息
		                $Func.render($("#headbar"),"headbar",user);

						//显示菜单
		            	$Func.render($("#sidebar"),"sidebar",user);

		            	//显示内容部分
		            	showContentPage("user");	           
					}
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                window.location.href = "login.html";
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户信息失败");
	        }
	    });
	}
	
	function getDocSysConfig()
    {
    	console.log("getDocSysConfig");
        $.ajax({
            url : "/DocSystem/Repos/getDocSysConfig.do",
            type :"post",
            dataType :"json",
            data : null,
            success : function (ret) {
                if(ret.status == "ok")
                {
                	gDocSysConfig = ret.data;
                	console.log("getDocSysConfig config:", gDocSysConfig);
	            }
	            else
	            {
	            	console.log(ret.msgInfo);
	            }
            },
            error : function () {
            	console.log('服务器异常:获取DocSysConfig失败');
            }
        });
    }
	
	//展开子项目
	$(document).on("click",".has_sub",function(){
		  console.log(".has_sub onclick()");
	      var title = $(this).children("a");
	      if( title.hasClass("subdrop") ){
	          title.removeClass("subdrop");
	          $(this).children("ul").hide();
	      }else{
	          title.addClass("subdrop");
	          $(this).children("ul").show();
	      }
	  });

	  //展开子目录
	  $(document).on("click","li.has_sublist",function(){
		  console.log("li.has_sublist onclick()");
		  var $this = $(this);
	      if( ! $this.children("a").hasClass("open") ){
	          $this.children("ul.sublist").toggle();
	      }
	  });
	  
	//click event handler  for data-eb-event="content.refresh"
	$(document).on("click","[data-eb-event]", function (e) {
		console.log("[data-eb-event] onclick()");
		stopBubble(e); //阻止冒泡

        var event = $(this).attr("data-eb-event");
        var params = $(this).attr("data-eb-params");
      	
        console.log("data-eb-event:"+ event + " " + params);
        
        //非回调方式更加容易被理解，so I give up the event bus 
        switch(event)
        {
        //菜单点击
        case "content.refresh":
        	showContentPage(params);
        	break;
        }
    });
	
	function stopBubble(e) { 
		//如果提供了事件对象，则这是一个非IE浏览器 
		if ( e && e.stopPropagation ) 
		    //因此它支持W3C的stopPropagation()方法 
		    e.stopPropagation(); 
		else 
		    //否则，我们需要使用IE的方式来取消事件冒泡 
		    window.event.cancelBubble = true; 
		}
	
	//显示对应菜单
	function showContentPage(curPath) {
	    console.log("showContentPage() " + curPath);
		var title = "载入中...";
	    var subtitle = "载入中...";
		
	    $("#container").html("载入中...");
	
	    $("#nav li>a").removeClass("open");
	    $("ul.sublist").hide();
	
	    switch ( curPath ){
	        case "user":
	            title = "用户管理";
	            userSearchWord = "";	//清除搜索关键字
	            showUserList();
	            $("#nav li[data-eb-params=user]>a").addClass("open");
	            break;
	        case "group":
	            title = "用户组管理";
	            showGroupList();
	            $("#nav li[data-eb-params=group]>a").addClass("open");
	            break;
	        case "repos":
	            title = "仓库管理";
	            showReposList();
	            $("#nav li[data-eb-params=repos]>a").addClass("open");
	            break;  
	        case "systemLog":
	            title = "日志管理";
	            $("#nav li[data-eb-params=systemLog]>a").addClass("open");
	            systemLogSearchWord = "";	//清除搜索关键字
	            showSystemLogList();
	            break;
	        case "system":
	        case "systemEmailConfig":
	        case "systemSmsConfig":
	        case "systemDbConfig":
	        case "systemUpgrade":
	        case "systemLicenses":
	        case "systemMigrate":
	        	title = "系统管理";
	            $("#nav li[data-eb-params=system]>a").addClass("open");
	            $("ul.sublist").show();	        	
	            showSystemPage(curPath);
	        	break;
	        case "license":
	            title = "证书管理";
	            $("#nav li[data-eb-params=license]>a").addClass("open");
	            licenseSearchWord = "";
	            showLicenseList();
	            break;
	        case "order":
	            title = "订单管理";
	            $("#nav li[data-eb-params=order]>a").addClass("open");
	            orderSearchWord = "";
	            showOrderList();
	            break;
	    }
	    
	    $Func.render($("#pagehead"),"pagehead",{
	        title : title,
	        subtitle : title
	    });
	}

	function showSystemPage(curPath)
    {
    	switch(curPath)
       	{
	   	case "system":
	   		showSystemUpgrade();
            break;
        case "systemUpgrade":
            showSystemUpgrade();
        	break;
        case "systemLicenses":
            showSystemLicenses();
        	break; 
	   	case "systemEmailConfig":
        	showSystemEmailConfig();
            break;
        case "systemSmsConfig":
        	showSystemSmsConfig();
            break;
        case "systemDbConfig":
        	showSystemDbConfig();
        	break;
        case "systemMigrate":
        	showSystemMigrate();
        	break;
       	}
    }
	
	//系统邮件服务设置
	var systemEmailConfig = {
			host: "",
			email: "",
			pwd: "",
	}
	function enableSystemEmailSet(){
		$("#btnEnableSystemEmailSet").hide();
		$("#btnCancelSystemEmailSet").show();
		$("#btnSaveSystemEmailSet").show();
		$("#systemEmailHost").val(systemEmailConfig.host);
		$("#systemEmailUser").val(systemEmailConfig.email);
		$("#systemEmailPwd").val(systemEmailConfig.pwd);
		$("#systemEmailHost").attr('disabled',false);
		$("#systemEmailUser").attr('disabled',false);
		$("#systemEmailPwd").attr('disabled',false);
	}
	
	function cancelSystemEmailSet(){
		$("#btnEnableSystemEmailSet").show();
		$("#btnCancelSystemEmailSet").hide();
		$("#btnSaveSystemEmailSet").hide();
		//revert the value
		$("#systemEmailHost").attr('disabled',true);
		$("#systemEmailUser").attr('disabled',true);
		$("#systemEmailPwd").attr('disabled',true);
		$("#systemEmailHost").val(systemEmailConfig.host);
		$("#systemEmailUser").val(systemEmailConfig.email);
		$("#systemEmailPwd").val(systemEmailConfig.pwd);
	}
	
	function saveSystemEmailSet(){
		$("#btnEnableSystemEmailSet").show();
		$("#btnCancelSystemEmailSet").hide();
		$("#btnSaveSystemEmailSet").hide();
		//revert the value
		$("#systemEmailHost").attr('disabled',true);
		$("#systemEmailUser").attr('disabled',true);
		$("#systemEmailPwd").attr('disabled',true);
		var host = $("#systemEmailHost").val();
		var user = $("#systemEmailUser").val();
		var pwd = $("#systemEmailPwd").val();
		updateSystemEmailConfig(host, user, pwd);
	}

	function showSystemEmailConfig(){
		$.ajax({
	        url : "/DocSystem/Manage/getSystemEmailConfig.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	//console.log("getSystemEmailConfig ret", ret);
					var config = ret.data; 	
					systemEmailConfig.host = config.host;
	            	systemEmailConfig.email = config.email;
	            	systemEmailConfig.pwd = config.pwd;
	            	console.log("getSystemEmailConfig systemEmailConfig",systemEmailConfig);
	            	$Func.render($("#container"),"systemEmailConfig",{"value":systemEmailConfig});
	            }
	            else 
	            {
	            	showErrorMessage("获取邮件服务配置信息失败:" + ret.msgInfo);
	            	console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取邮件服务配置信息失败");
	        }
	    });
	}
	
	function updateSystemEmailConfig(host, email, pwd){
		$.ajax({
	        url : "/DocSystem/Manage/setSystemEmailConfig.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	host: host,
	        	email: email,
	        	pwd: pwd,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	        		systemEmailConfig.host = host;
	            	systemEmailConfig.email = email;
	        		systemEmailConfig.pwd = pwd;
	        		showErrorMessage("更新邮件服务配置成功");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("更新邮件服务配置失败:" + ret.msgInfo);
	        		//restore the setting
	        		$("#systemEmailHost").val(systemEmailConfig.host);
	        		$("#systemEmailUser").val(systemEmailConfig.email);
	        		$("#systemEmailPwd").val(systemEmailConfig.pwd);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:更新邮件服务配置失败");
        		//restore the setting
	        	$("#systemEmailHost").val(systemEmailConfig.host);
        		$("#systemEmailUser").val(systemEmailConfig.email);
        		$("#systemEmailPwd").val(systemEmailConfig.pwd);
	        }
	    });
	}
	
	//系统短信服务设置
	var systemSmsConfig = {
			server: "",
			apikey: "",
			tplid: "",
	}
	function enableSystemSmsSet(){
		$("#btnEnableSystemSmsSet").hide();
		$("#btnCancelSystemSmsSet").show();
		$("#btnSaveSystemSmsSet").show();
		$("#systemSmsServer").val(systemSmsConfig.server);
		$("#systemSmsApikey").val(systemSmsConfig.apikey);
		$("#systemSmsTplid").val(systemSmsConfig.tplid);
		$("#systemSmsServer").attr('disabled',false);
		$("#systemSmsApikey").attr('disabled',false);
		$("#systemSmsTplid").attr('disabled',false);
	}
	
	function cancelSystemSmsSet(){
		$("#btnEnableSystemSmsSet").show();
		$("#btnCancelSystemSmsSet").hide();
		$("#btnSaveSystemSmsSet").hide();
		//revert the value
		$("#systemSmsServer").attr('disabled',true);
		$("#systemSmsApikey").attr('disabled',true);
		$("#systemSmsTplid").attr('disabled',true);
		$("#systemSmsServer").val(systemSmsConfig.server);
		$("#systemSmsApikey").val(systemSmsConfig.apikey);
		$("#systemSmsTplid").val(systemSmsConfig.tplid);
	}
	
	function saveSystemSmsSet(){
		$("#btnEnableSystemSmsSet").show();
		$("#btnCancelSystemSmsSet").hide();
		$("#btnSaveSystemSmsSet").hide();
		//revert the value
		$("#systemSmsServer").attr('disabled',true);
		$("#systemSmsApikey").attr('disabled',true);
		$("#systemSmsTplid").attr('disabled',true);
		var host = $("#systemSmsServer").val();
		var user = $("#systemSmsApikey").val();
		var pwd = $("#systemSmsTplid").val();
		updateSystemSmsConfig(host, user, pwd);
	}

	function showSystemSmsConfig(){
		$.ajax({
	        url : "/DocSystem/Manage/getSystemSmsConfig.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	//console.log("getSystemSmsConfig ret", ret);
					var config = ret.data; 	
					systemSmsConfig.server = config.server;
	            	systemSmsConfig.apikey = config.apikey;
	            	systemSmsConfig.tplid = config.tplid;
	            	console.log("getSystemSmsConfig systemSmsConfig",systemSmsConfig);
	            	$Func.render($("#container"),"systemSmsConfig",{"value":systemSmsConfig});
	            }
	            else 
	            {
	            	showErrorMessage("获取短信服务配置信息失败:" + ret.msgInfo);
	            	console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取短信服务配置信息失败");
	        }
	    });
	}
	
	function updateSystemSmsConfig(server, apikey, tplid){
		$.ajax({
	        url : "/DocSystem/Manage/setSystemSmsConfig.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	server: server,
	        	apikey: apikey,
	        	tplid: tplid,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	        		systemSmsConfig.server = server;
	            	systemSmsConfig.apikey = apikey;
	        		systemSmsConfig.tplid = tplid;
	        		showErrorMessage("更新短信服务配置成功");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("更新短信服务配置失败:" + ret.msgInfo);
	        		//restore the setting
	        		$("#systemSmsServer").val(systemSmsConfig.server);
	        		$("#systemSmsApikey").val(systemSmsConfig.apikey);
	        		$("#systemSmsTplid").val(systemSmsConfig.tplid);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:更新短信服务配置失败");
        		//restore the setting
	        	$("#systemSmsServer").val(systemSmsConfig.server);
        		$("#systemSmsApikey").val(systemSmsConfig.apikey);
        		$("#systemSmsTplid").val(systemSmsConfig.tplid);
	        }
	    });
	}

	//系统迁移
	var gMigrateReposList = [];
	function showSystemMigrate(){
		$.ajax({
	        url : "/DocSystem/Manage/getReposList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	var reposList = ret.data;
	        		for(var i=0; i<reposList.length; i++)
	        	 	{
	        	    	var node = reposList[i];
	        	       	node.formatedType = formateReposType(node.type);
	             	}
	        		gMigrateReposList = reposList;
	            	$Func.render($("#container"),"systemMigrate",{"list":reposList});
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取仓库列表失败");
	        }
	    });		
	}
	
	function selectAllReposMigrateEn()
	{
		console.log("selectAllReposMigrateEn()");
		var en = $("#allReposMigrateEn").is(':checked')? 1: 0;
		console.log("selectAllReposMigrateEn() allReposMigrateEn:" + en);
		
		if(en == 1)
		{
			console.log("selectAllReposMigrateEn() select all repos");
			$(".reposMigrateEn").prop("checked","checked");
			//$(".reposMigrateEn").attr("checked","checked");
		}
		else
		{
			console.log("selectAllReposMigrateEn() unselect all repos");
			$(".reposMigrateEn").prop("checked",false);
			//$(".reposMigrateEn").attr("checked",false);
		}
	}
	
	//showSystemMigratePanel
	function showSystemMigrateConfirmPanel(){
		console.log("showSystemMigrateConfirmPanel gMigrateReposList.length :" + gMigrateReposList.length);
		
		var selectedMigrateReposList = [];
		for(var i=0; i < gMigrateReposList.length; i++)
		{
			var node = gMigrateReposList[i];
			//console.log("showSystemMigrateConfirmPanel node:", node);
			var selected = $("#reposMigrateEn" + i).is(':checked')? 1: 0;
			if(selected == 1)
			{
				selectedMigrateReposList.push(gMigrateReposList[i]);
			}
		}
		
		console.log("showSystemMigrateConfirmPanel selectedMigrateReposList.length :" + selectedMigrateReposList.length);
		if(selectedMigrateReposList.length == 0)
		{
			showErrorMessage("请选择需要迁移的仓库！");
			return;
		}
		
		qiao.bs.dialog({
			url: 'systemMigrateConfirm.html',
			title: '系统迁移',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    SystemMigrateConfirmPageInit(selectedMigrateReposList);
			}
		}, null);
	}
	
	//系统数据库设置
	var systemDbSetting = {
			type: "",
			url: "",
			user: "",
			pwd: "",
	}
	function enableSystemDBSet(){
		$("#btnEnableSystemDBSet").hide();
		$("#btnCancelSystemDBSet").show();
		$("#btnSaveSystemDBSet").show();
		$("#systemDbType").val(systemDbSetting.type);
		$("#systemDbUrl").val(systemDbSetting.url);
		$("#systemDbUser").val(systemDbSetting.user);
		$("#systemDbPwd").val(systemDbSetting.pwd);
		
		$("#systemDbType").attr('disabled',false);
		$("#systemDbUrl").attr('disabled',false);
		$("#systemDbUser").attr('disabled',false);
		$("#systemDbPwd").attr('disabled',false);
	}
	
	function cancelSystemDBSet(){
		$("#btnEnableSystemDBSet").show();
		$("#btnCancelSystemDBSet").hide();
		$("#btnSaveSystemDBSet").hide();
		//revert the value
		$("#systemDbType").attr('disabled',true);
		$("#systemDbUrl").attr('disabled',true);
		$("#systemDbUser").attr('disabled',true);
		$("#systemDbPwd").attr('disabled',true);
		
		$("#systemDbType").val(systemDbSetting.type);
		$("#systemDbUrl").val(systemDbSetting.url);
		$("#systemDbUser").val(systemDbSetting.user);
		$("#systemDbPwd").val(systemDbSetting.pwd);
	}
	
	function saveSystemDBSet(){
		$("#btnEnableSystemDBSet").show();
		$("#btnCancelSystemDBSet").hide();
		$("#btnSaveSystemDBSet").hide();

		//save the value
		$("#systemDbType").attr('disabled',true);
		$("#systemDbUrl").attr('disabled',true);
		$("#systemDbUser").attr('disabled',true);
		$("#systemDbPwd").attr('disabled',true);
		
		var type = $("#systemDbType").val();
		var url = $("#systemDbUrl").val();
		var user = $("#systemDbUser").val();
		var pwd = $("#systemDbPwd").val();
		updateSystemDBConfig(type, url, user, pwd);
	}
	
	function doSelectDbType(){
		var type = $("#systemDbType").val();
		switch(type)
		{
		case "mysql":
			$("#systemDbUrl").val("jdbc:mysql://localhost:3307/DocSystem1?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC");
			$("#systemDbUser").val("root");
			$("#systemDbPwd").val("");
			break;
		case "sqlite":
			$("#systemDbUrl").val("jdbc:sqlite:${catalina.home}/DocSystem.db");
			$("#systemDbUser").val("");
			$("#systemDbPwd").val("");
			break;
		}
	}

	function showSystemDbConfig(){
		$.ajax({
	        url : "/DocSystem/Manage/getSystemDbConfig.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
					var config = ret.data; 	
					systemDbSetting.type = config.type;
					systemDbSetting.url = config.url;
					systemDbSetting.user = config.user;
					systemDbSetting.pwd = config.pwd;
	            	$Func.render($("#container"),"systemDbConfig",{"value":systemDbSetting});
	            }
	            else 
	            {
		        	showErrorMessage("获取数据库信息失败:" + ret.msgInfo);
	            	console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取数据库信息失败");
	        }
	    });
	}
	
	function updateSystemDBConfig(type, url, user, pwd){
		$.ajax({
	        url : "/DocSystem/Manage/setSystemDBConfig.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	type: type,
	        	url: url,
	        	user: user,
	        	pwd: pwd,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	      
	            	systemDbSetting.type = type;
	        		systemDbSetting.url = url;
	        		systemDbSetting.user = user;
	        		systemDbSetting.pwd = pwd;
	        		showErrorMessage("更新成功,重启服务后生效！");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("更新数据库配置信息失败:" + ret.msgInfo);
	        		//restore the setting
	        		$("#systemDbType").val(systemDbSetting.type);
	        		$("#systemDbUrl").val(systemDbSetting.url);
	        		$("#systemDbUser").val(systemDbSetting.user);
	        		$("#systemDbPwd").val(systemDbSetting.pwd);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:更新数据库配置信息失败");
        		//restore the setting
        		$("#systemDbType").val(systemDbSetting.type);
	    		$("#systemDbUrl").val(systemDbSetting.url);
	    		$("#systemDbUser").val(systemDbSetting.user);
	    		$("#systemDbPwd").val(systemDbSetting.pwd);
	        }
	    });
	}
	
	function testDatabase(){
		var dbType = $("#systemDbType").val();
		var dbUrl = $("#systemDbUrl").val();
		var dbUser = $("#systemDbUser").val();
		var dbPwd = $("#systemDbPwd").val();
		
		$.ajax({
	        url : "/DocSystem/Manage/testDatabase.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	type: dbType,
	        	url: dbUrl,
	        	user: dbUser,
	        	pwd: dbPwd,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	            	//设置成功
	            	showErrorMessage("数据库连接成功");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("数据库连接失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:数据库连接失败");
	        }
	    });
	}
	
	function deleteDatabaseConfirm()
	{
		console.log("deleteDatabaseConfirm()");
		
	    qiao.bs.confirm({
	    		id: "deleteDatabaseConfirmDialog",
		        title: "删除数据库",
		        msg: "是否删除数据库？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				deleteDatabase();
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function deleteDatabase(){
		var dbType = $("#systemDbType").val();
		var dbUrl = $("#systemDbUrl").val();
		var dbUser = $("#systemDbUser").val();
		var dbPwd = $("#systemDbPwd").val();
		
		$.ajax({
	        url : "/DocSystem/Manage/deleteDatabase.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	type: dbType,
	        	url: dbUrl,
	        	user: dbUser,
	        	pwd: dbPwd,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	            	//设置成功
	            	showErrorMessage("删除数据库成功");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("删除数据库失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:删除数据库失败");
	        }
	    });
	}
	
	function resetDatabaseConfirm()
	{
		console.log("resetDatabaseConfirm()");
	    qiao.bs.confirm({
	    		id: "resetDatabaseConfirmDialog",
		        title: "重置数据库",
		        msg: "是否重置数据库？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				resetDatabase();
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function resetDatabase(){
		var dbType = $("#systemDbType").val();
		var dbUrl = $("#systemDbUrl").val();
		var dbUser = $("#systemDbUser").val();
		var dbPwd = $("#systemDbPwd").val();
		
		$.ajax({
	        url : "/DocSystem/Manage/resetDatabase.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	type: dbType,
	        	url: dbUrl,
	        	user: dbUser,
	        	pwd: dbPwd,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	            	//设置成功
	            	showErrorMessage("重置数据库成功");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("重置数据库失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:重置数据库失败");
	        }
	    });
	}
	
	function exportDBData(){
		var dbType = $("#systemDbType").val();
		var dbUrl = $("#systemDbUrl").val();
		var dbUser = $("#systemDbUser").val();
		var dbPwd = $("#systemDbPwd").val();
		
		$.ajax({
	        url : "/DocSystem/Manage/exportDBData.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	type: dbType,
	        	url: dbUrl,
	        	user: dbUser,
	        	pwd: dbPwd,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	            	//设置成功
            	    console.log("exportDBData Ok:",ret);        	   		
	            	window.location.href = ret.data;
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("数据库导出失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:数据库导出失败");
	        }
	    });
	}
	
	function importDBData(){
		console.log("importDBData()");
  		//清除文件控件
		$("#importDBFiles").val("");
	    return $("#importDBFiles").click();
	}
	
	function importDBDataConfirm(e)
	{
		console.log("importDBDataConfirm()");
		
		var dbType = $("#systemDbType").val();
		var dbUrl = $("#systemDbUrl").val();
		var dbUser = $("#systemDbUser").val();
		var dbPwd = $("#systemDbPwd").val();
		
	    var files = e.target.files;
	    var firstFile;
	    if(files.length > 0)
	   	{
	    	console.log("files.length:" + files.length);
	    	for( var i = 0 ; i < files.length ; i++ )
	    	{  
	    		firstFile = files[i];
	    	   	if(typeof firstFile == 'object')
	    	   	{
	    	   		var relativePath = firstFile.webkitRelativePath;	//获取第一个文件的相对路径
	    	   		console.log("firstFile relativePath:"+firstFile.webkitRelativePath);
	    	   		break;
	    	   	}
	    	   	else
	    	   	{
	    	   		//This is something else 
	    	   		//console.log("it is not a file");
	    	   	}
	    	}
	    }
	    else
	   	{
	   		showErrorMessage("请选择文件");
	      	return false;
	   	}  
		
		var fileName = firstFile.name;
	    console.log("firstFile:"+fileName);
	    
	    qiao.bs.confirm({
	    		id: "importDBDataConfirmDialog",
		        title: "导入数据",
		        msg: "是否导入 " + fileName+ " ？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				//开始上传
				startImportDBData(firstFile, dbType, dbUrl, dbUser, dbPwd);
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startImportDBData(file, dbType, dbUrl, dbUser, dbPwd)
	{
		//新建文件上传表单
		var form = new FormData();
		form.append("type", dbType);
		form.append("url", dbUrl);
		form.append("user", dbUser);
		form.append("pwd", dbPwd);
		form.append("uploadFile", file);

		//新建http异步请求
		var xhr = new XMLHttpRequest();
		
		//设置异步上传状态变化回调处a理函数
		xhr.onreadystatechange = function() {				
			//文件上传状态
			console.log("xhr onreadystatechange() status:" + xhr.status + " readyState:" + xhr.readyState);
			if(xhr.status == 200) 
			{
				if(xhr.readyState != 4)
				{
					//文件上传未结束
					return;
				}
				
				//上传成功！
				var ret = JSON.parse(xhr.responseText);
				if("ok" == ret.status){
					showErrorMessage("导入成功");
				 }
				 else	//上传失败
				 {
					//上传失败
					console.log("上传失败：" + ret.msgInfo);
					showErrorMessage("导入失败:" + ret.msgInfo);
					return;
	             }
			}else{
				if(xhr.status < 300) 
				{
					//不是真正的异常
					return;
				}
				//上传失败
				console.log("系统异常: " + file.name + " 上传异常！");
				showErrorMessage("系统异常: 上传异常");
				return;
			}
		};
		
		//上传表单			
		xhr.open("post", "/DocSystem/Manage/importDBData.do");
		xhr.send(form);
	}
	
	var systemInfo = {
			version: "",
			tomcatPath: "",
			javaHome: "",
			openOfficePath:"",
			officeEditorApi:"",
			defaultReposStorePath:"",
			systemLogStorePath:"",
			indexDBStorePath:"",
			salesDataStorePath:"",			
			ldapConfig:"",
			logLevel: 1,	//default info
			logFile : "", //defualt not set
	}
	
	function enableSystemInfoSet(){
		$("#btnEnableSystemInfoSet").hide();
		$("#btnCancelSystemInfoSet").show();
		$("#btnSaveSystemInfoSet").show();
		$("#tomcatPath").val(systemInfo.tomcatPath);
		$("#javaHome").val(systemInfo.javaHome);
		$("#openOfficePath").val(systemInfo.openOfficePath);
		$("#officeEditorApi").val(systemInfo.officeEditorApi);
		$("#defaultReposStorePath").val(systemInfo.defaultReposStorePath);
		$("#systemLogStorePath").val(systemInfo.systemLogStorePath);
		$("#indexDBStorePath").val(systemInfo.indexDBStorePath);
		$("#salesDataStorePath").val(systemInfo.salesDataStorePath);
		$("#ldapConfig").val(systemInfo.ldapConfig);
		$("#logLevel option[value='"+systemInfo.logLevel+"']").attr("selected","selected");
		$("#logFile").val(systemInfo.logFile);
		
		$("#tomcatPath").attr('disabled',false);
		$("#javaHome").attr('disabled',false);
		$("#openOfficePath").attr('disabled',false);
		$("#officeEditorApi").attr('disabled',false);
		$("#defaultReposStorePath").attr('disabled',false);
		$("#systemLogStorePath").attr('disabled',false);
		$("#indexDBStorePath").attr('disabled',false);
		$("#salesDataStorePath").attr('disabled',false);
		$("#ldapConfig").attr('disabled',false);
		$("#logLevel").attr('disabled',false);
		$("#logFile").attr('disabled',false);
	}
	
	function cancelSystemInfoSet(){
		$("#btnEnableSystemInfoSet").show();
		$("#btnCancelSystemInfoSet").hide();
		$("#btnSaveSystemInfoSet").hide();
		//revert the value
		$("#tomcatPath").attr('disabled',true);
		$("#javaHome").attr('disabled',true);
		$("#openOfficePath").attr('disabled',true);
		$("#officeEditorApi").attr('disabled',true);
		$("#defaultReposStorePath").attr('disabled',true);
		$("#systemLogStorePath").attr('disabled',true);
		$("#indexDBStorePath").attr('disabled',true);
		$("#salesDataStorePath").attr('disabled',true);
		$("#ldapConfig").attr('disabled',true);
		$("#logLevel").attr('disabled',true);
		$("#logFile").attr('disabled',true);

		$("#tomcatPath").val(systemInfo.tomcatPath);
		$("#javaHome").val(systemInfo.javaHome);
		$("#openOfficePath").val(systemInfo.openOfficePath);
		$("#officeEditorApi").val(systemInfo.officeEditorApi);
		$("#defaultReposStorePath").val(systemInfo.defaultReposStorePath);
		$("#systemLogStorePath").val(systemInfo.systemLogStorePath);
		$("#indexDBStorePath").val(systemInfo.indexDBStorePath);
		$("#salesDataStorePath").val(systemInfo.salesDataStorePath);
		$("#ldapConfig").val(systemInfo.ldapConfig);
		$("#logLevel option[value='"+systemInfo.logLevel+"']").attr("selected","selected");
		$("#logFile").val(systemInfo.logFile);		
	}
	
	function saveSystemInfoSet(){
		$("#btnEnableSystemInfoSet").show();
		$("#btnCancelSystemInfoSet").hide();
		$("#btnSaveSystemInfoSet").hide();
		//revert the value
		$("#tomcatPath").attr('disabled',true);
		$("#javaHome").attr('disabled',true);
		$("#openOfficePath").attr('disabled',true);
		$("#officeEditorApi").attr('disabled',true);
		$("#defaultReposStorePath").attr('disabled',true);
		$("#systemLogStorePath").attr('disabled',true);
		$("#indexDBStorePath").attr('disabled',true);
		$("#salesDataStorePath").attr('disabled',true);
				
		$("#ldapConfig").attr('disabled',true);
		$("#logLevel").attr('disabled',true);
		$("#logFile").attr('disabled',true);


		var tomcatPath = $("#tomcatPath").val();
		var javaHome = $("#javaHome").val();
		var openOfficePath = $("#openOfficePath").val();
		var officeEditorApi = $("#officeEditorApi").val();
		var defaultReposStorePath = $("#defaultReposStorePath").val();
		var systemLogStorePath = $("#systemLogStorePath").val();
		var indexDBStorePath = $("#indexDBStorePath").val();
		var salesDataStorePath = $("#salesDataStorePath").val();
		var ldapConfig = $("#ldapConfig").val();
		var logLevel = $("#logLevel").val();
		var logFile =  $("#logFile").val();
		
		updateSystemInfo(tomcatPath, 
				javaHome, 
				openOfficePath, 
				officeEditorApi, 
				defaultReposStorePath,
				systemLogStorePath, 
				indexDBStorePath,
				salesDataStorePath,
				ldapConfig, 
				logLevel, 
				logFile);
	}
	
	function updateSystemInfo(tomcatPath, 
			javaHome, 
			openOfficePath, 
			officeEditorApi, 
			defaultReposStorePath, 
			systemLogStorePath, 
			indexDBStorePath,
			salesDataStorePath,
			ldapConfig, 
			logLevel, 
			logFile){
		$.ajax({
	        url : "/DocSystem/Manage/setSystemInfo.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	tomcatPath: tomcatPath,
	        	javaHome: javaHome,
	        	openOfficePath: openOfficePath,
	        	officeEditorApi: officeEditorApi,
	        	defaultReposStorePath: defaultReposStorePath,
	        	systemLogStorePath: systemLogStorePath,
	        	indexDBStorePath: indexDBStorePath,
	        	salesDataStorePath: salesDataStorePath,
	        	ldapConfig: ldapConfig,
	        	logLevel: logLevel,
	        	logFile: logFile,
	        },
	        success : function (ret) {
	        	console.log("setSystemInfo ret:",ret);
	            if( "ok" == ret.status )
	            {	        		
	        		systemInfo.tomcatPath = tomcatPath;
	        		systemInfo.javaHome = javaHome;
	        		systemInfo.openOfficePath = openOfficePath;
	        		systemInfo.officeEditorApi = officeEditorApi;
	        		systemInfo.defaultReposStorePath = defaultReposStorePath;
	        		systemInfo.systemLogStorePath = systemLogStorePath;
	        		systemInfo.indexDBStorePath = indexDBStorePath;
	        		systemInfo.salesDataStorePath = salesDataStorePath;
	        		systemInfo.ldapConfig = ldapConfig;
	        		systemInfo.logLevel = logLevel;
	        		systemInfo.logFile = logFile;
	        		showErrorMessage("更新成功！");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("更新数据库配置信息失败:" + ret.msgInfo);
	        		//restore the setting
	        		$("#tomcatPath").val(systemInfo.tomcatPath);
	        		$("#javaHome").val(systemInfo.javaHome);
	        		$("#openOfficePath").val(systemInfo.openOfficePath);
	        		$("#officeEditorApi").val(systemInfo.officeEditorApi);
	        		$("#defaultReposStorePath").val(systemInfo.defaultReposStorePath);
	        		$("#systemLogStorePath").val(systemInfo.systemLogStorePath);
	        		$("#indexDBStorePath").val(systemInfo.indexDBStorePath);
	        		$("#salesDataStorePath").val(systemInfo.salesDataStorePath);
	        		$("#ldapConfig").val(systemInfo.ldapConfig);
	        		$("#logLevel").val(systemInfo.logLevel);
	        		$("#logFile").val(systemInfo.logFile);
	            }
	        },
	        error : function () {
	        	showErrorMessage("更新数据库配置信息失败:服务器异常");
        		//restore the setting
        		$("#tomcatPath").val(systemInfo.tomcatPath);
        		$("#javaHome").val(systemInfo.javaHome);
        		$("#openOfficePath").val(systemInfo.openOfficePath);
        		$("#officeEditorApi").val(systemInfo.officeEditorApi);
        		$("#defaultReposStorePath").val(systemInfo.defaultReposStorePath);
        		$("#systemLogStorePath").val(systemInfo.systemLogStorePath);
        		$("#indexDBStorePath").val(systemInfo.indexDBStorePath);
        		$("#salesDataStorePath").val(systemInfo.salesDataStorePath);
        		$("#ldapConfig").val(systemInfo.ldapConfig);
        		$("#logLevel").val(systemInfo.logLevel);
        		$("#logFile").val(systemInfo.logFile);
	        }
	    });
	}
	
	function showSystemUpgrade(){
		$.ajax({
	        url : "/DocSystem/Manage/getSystemInfo.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            console.log("showSystemUpgrade() ret", ret);
	        	if( "ok" == ret.status )
	            {
	            	var config = ret.data; 	
	            	systemInfo = config;
	            	if(systemInfo.logLevel == undefined)
	            	{
	            		systemInfo.logLevel = 1;	//defulat info
	            	}
	            	if(systemInfo.logFile == undefined)
	            	{
	            		systemInfo.logFile = "";
	            	}
	            	$Func.render($("#container"),"systemUpgrade",{"value":systemInfo});
	            }
	            else 
	            {
		        	showErrorMessage("获取系统信息失败:" + ret.msgInfo);
	            	console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取系统信息失败");
	        }
	    });
	}
	
	function restartTomcat(){
		console.log("restartTomcat()");
	    qiao.bs.confirm({
	    		id: "restartTomcatConfirmDialog",
		        title: "重启服务",
		        msg: "是否重启服务？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				//开始上传
				var tomcatPath = $("#tomcatPath").val();
				var javaHome = $("#javaHome").val();
				doRestartTomcat(tomcatPath, javaHome);
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function doRestartTomcat(tomcatPath, javaHome)
	{
		console.log("doRestartTomcat tomcatPath:" + tomcatPath + " javaHome:" + javaHome);
		$.ajax({
	        url : "/DocSystem/Manage/restartServer.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	tomcatPath: tomcatPath,
	        	javaHome: javaHome,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	showErrorMessage("重启成功!");
	        	}
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("重启失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("重启失败:服务器异常");
	        }
	    });
	}
	
	function generateRootKey()
	{
        $.ajax({
            url : "/DocSystem/Sales/generateRootKey.do",
            type : "post",
            dataType : "json",
            data : {
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showErrorMessage("生成密钥成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("生成密钥失败:服务器异常");
            }
        });
	}
	
	function exportRootKey(){
		$.ajax({
	        url : "/DocSystem/Sales/exportRootKey.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	         	    console.log("exportRootKey Ok:",ret);	   		
	            	window.location.href = ret.data;
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("密钥导出失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("密钥导出失败:服务器异常");
	        }
	    });
	}
	
	function deleteRootKey()
	{
		deleteRootKeyConfirm();
	}
	
	function deleteRootKeyConfirm()
	{
		console.log("deleteRootKeyConfirm()");
	    qiao.bs.confirm({
	    		id: "deleteRootKeyConfirmDialog",
		        title: "删除密钥",
		        msg: "是否删除系统密钥？",
		        okbtn: "是",
		        qubtn: "否",
	    	},function () {
	    		startDeleteRootKey();
		    	return true;   //close dialog
	    	},function()
	    	{
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startDeleteRootKey()
	{
        $.ajax({
            url : "/DocSystem/Sales/deleteRootKey.do",
            type : "post",
            dataType : "json",
            data : {
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showErrorMessage("删除密钥成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("删除密钥失败:服务器异常");
            }
        });
	}
	
	function generateLicenseKeyPair()
	{
        $.ajax({
            url : "/DocSystem/Sales/generateLicenseKeyPair.do",
            type : "post",
            dataType : "json",
            data : {
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showErrorMessage("生成密钥成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("生成密钥失败:服务器异常");
            }
        });
	}
	
	function exportLicenseKeyPair(){
		$.ajax({
	        url : "/DocSystem/Sales/exportLicenseKeyPair.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        },
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {	        		
	         	    console.log("exportLicenseKeyPair Ok:",ret);	   		
	            	window.location.href = ret.data;
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                showErrorMessage("密钥导出失败:" + ret.msgInfo);
		        }
	        },
	        error : function () {
	        	showErrorMessage("密钥导出失败:服务器异常");
	        }
	    });
	}
	
	function deleteLicenseKeyPair()
	{
		deleteLicenseKeyPairConfirm();
	}
	
	function deleteLicenseKeyPairConfirm()
	{
		console.log("deleteLicenseKeyPairConfirm()");
	    qiao.bs.confirm({
	    		id: "deleteLicenseKeyPairConfirm",
		        title: "删除密钥",
		        msg: "是否删除证书密钥？",
		        okbtn: "是",
		        qubtn: "否",
	    	},function () {
				startDeleteLicenseKeyPair();
		    	return true;   //close dialog
	    	},function()
	    	{
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startDeleteLicenseKeyPair()
	{
        $.ajax({
            url : "/DocSystem/Sales/deleteLicenseKeyPair.do",
            type : "post",
            dataType : "json",
            data : {
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showErrorMessage("删除密钥成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("删除密钥失败:服务器异常");
            }
        });
	}
	
	function deleteSystemLicense(){
		console.log("deleteSystemLicense()");
		var systemLicense = systemLicenses.systemLicense;
		if(systemLicense.hasLicense == false)
		{
			return;
		}
		
		deleteSystemLicenseConfirm();
	}
	
	function deleteSystemLicenseConfirm()
	{
		console.log("deleteSystemLicenseConfirm()");
	    qiao.bs.confirm({
	    		id: "deleteSystemLicenseConfirmDialog",
		        title: "删除证书",
		        msg: "是否删除证书？",
		        okbtn: "是",
		        qubtn: "否",
	    	},function () {
				startDeleteSystemLicense();
		    	return true;   //close dialog
	    	},function()
	    	{
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startDeleteSystemLicense()
	{
        $.ajax({
            url : "/DocSystem/Bussiness/deleteSystemLicense.do",
            type : "post",
            dataType : "json",
            data : {
            },
            success : function (ret) {
                if( "ok" == ret.status ){
					updateSystemLicenseInfo(ret.data);
					showSystemLicenses(systemLicenses);
                   	showErrorMessage("删除成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}

	
	function installSystemLicense(){
		console.log("installSystemLicense()");
  		//清除文件控件
		$("#installSystemLicense").val("");
	    return $("#installSystemLicense").click();
	}
	
	
	function installSystemLicenseConfirm(e)
	{
		console.log("installSystemLicenseConfirm()");
	    var files = e.target.files;
	    var firstFile;
	    if(files.length > 0)
	   	{
	    	console.log("files.length:" + files.length);
	    	for( var i = 0 ; i < files.length ; i++ )
	    	{  
	    		firstFile = files[i];
	    	   	if(typeof firstFile == 'object')
	    	   	{
	    	   		//var relativePath = firstFile.webkitRelativePath;	//获取第一个文件的相对路径
	    	   		//console.log("firstFile relativePath:"+firstFile.webkitRelativePath);
	    	   		break;
	    	   	}
	    	   	else
	    	   	{
	    	   		//This is something else 
	    	   		//console.log("it is not a file");
	    	   	}
	    	}
	    }
	    else
	   	{
	   		showErrorMessage("请选择文件");
	      	return false;
	   	}  
		
		//var fileName = firstFile.name;
	    //console.log("firstFile:"+fileName);

	    qiao.bs.confirm({
	    		id: "installSystemLicenseConfirmDialog",
		        title: "安装证书",
		        msg: "是否安装证书？",
		        okbtn: "是",
		        qubtn: "否",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				//开始上传
				startInstallSystemLicense(firstFile);
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startInstallSystemLicense(file)
	{
		//新建文件上传表单
		var form = new FormData();
		form.append("uploadFile", file);

		//新建http异步请求
		var xhr = new XMLHttpRequest();
		
		//设置异步上传状态变化回调处a理函数
		xhr.onreadystatechange = function() {				
			//文件上传状态
			console.log("xhr onreadystatechange() status:" + xhr.status + " readyState:" + xhr.readyState);
			if(xhr.status == 200) 
			{
				if(xhr.readyState != 4)
				{
					//文件上传未结束
					return;
				}
				
				//上传成功！
				var ret = JSON.parse(xhr.responseText);
				if("ok" == ret.status){
					showErrorMessage("安装成功");
					updateSystemLicenseInfo(ret.data);
					showSystemLicenses(systemLicenses);
				 }
				 else	//上传失败
				 {
					//上传失败
					console.log("安装失败：" + ret.msgInfo);
					showErrorMessage("安装失败:" + ret.msgInfo);
					return;
	             }
			}else{
				if(xhr.status < 300) 
				{
					//不是真正的异常
					return;
				}
				//上传失败
				console.log("安装失败: " + file.name + " 上传异常！");
				showErrorMessage("安装失败: 上传异常");
				return;
			}
		};
		
		//上传表单			
		xhr.open("post", "/DocSystem/Bussiness/installSystemLicense.do");
		xhr.send(form);
	}
	
	function updateSystemLicenseInfo(licenseInfo)
	{
		var systemLicenseInfo = systemLicenses.systemLicense;
		systemLicenseInfo.hasLicense = licenseInfo.hasLicense;
		systemLicenseInfo.id = licenseInfo.id;
		systemLicenseInfo.customer = licenseInfo.customer;
		systemLicenseInfo.usersCount = licenseInfo.usersCount;
		systemLicenseInfo.expireTime = licenseInfo.expireTime;
		systemLicenseInfo.createTime = licenseInfo.createTime;
	}
	
	function upgradeSystem(){
		console.log("upgradeSystem()");
  		//清除文件控件
		$("#upgradeFiles").val("");
	    return $("#upgradeFiles").click();
	}

	function upgradeSystemConfirm(e)
	{
		console.log("upgradeSystemConfirm()");
	    var files = e.target.files;
	    var firstFile;
	    if(files.length > 0)
	   	{
	    	console.log("files.length:" + files.length);
	    	for( var i = 0 ; i < files.length ; i++ )
	    	{  
	    		firstFile = files[i];
	    	   	if(typeof firstFile == 'object')
	    	   	{
	    	   		var relativePath = firstFile.webkitRelativePath;	//获取第一个文件的相对路径
	    	   		console.log("firstFile relativePath:"+firstFile.webkitRelativePath);
	    	   		break;
	    	   	}
	    	   	else
	    	   	{
	    	   		//This is something else 
	    	   		//console.log("it is not a file");
	    	   	}
	    	}
	    }
	    else
	   	{
	   		showErrorMessage("请选择文件");
	      	return false;
	   	}  
		
		var fileName = firstFile.name;
	    console.log("firstFile:"+fileName);
	    if(fileName != "DocSystem.war")
	    {
	    	showErrorMessage("非法升级文件");
	    	return false;
	    }
	    
	    qiao.bs.confirm({
	    		id: "upgradeSystemConfirmDialog",
		        title: "系统升级",
		        msg: "是否升级系统？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				//开始上传
				startUpgradeSystem(firstFile);
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startUpgradeSystem(file)
	{
		//新建文件上传表单
		var form = new FormData();
		form.append("uploadFile", file);

		//新建http异步请求
		var xhr = new XMLHttpRequest();
		
		//设置异步上传状态变化回调处a理函数
		xhr.onreadystatechange = function() {				
			//文件上传状态
			console.log("xhr onreadystatechange() status:" + xhr.status + " readyState:" + xhr.readyState);
			if(xhr.status == 200) 
			{
				if(xhr.readyState != 4)
				{
					//文件上传未结束
					return;
				}
				
				//上传成功！
				var ret = JSON.parse(xhr.responseText);
				if("ok" == ret.status){
					showErrorMessage("升级成功");
				 }
				 else	//上传失败
				 {
					//上传失败
					console.log("升级失败：" + ret.msgInfo);
					showErrorMessage("升级失败:" + ret.msgInfo);
					return;
	             }
			}else{
				if(xhr.status < 300) 
				{
					//不是真正的异常
					return;
				}
				//上传失败
				console.log("升级失败: " + file.name + " 上传异常！");
				showErrorMessage("升级失败: 上传异常");
				return;
			}
		};
		
		//上传表单			
		xhr.open("post", "/DocSystem/Manage/upgradeSystem.do");
		xhr.send(form);
	}
	
	function installOffice(){
		console.log("installOffice()");
  		//清除文件控件
		$("#installOffice").val("");
	    return $("#installOffice").click();
	}
	
	function installOfficeConfirm(e)
	{
		console.log("installOfficeConfirm()");
	    var files = e.target.files;
	    var firstFile;
	    if(files.length > 0)
	   	{
	    	console.log("files.length:" + files.length);
	    	for( var i = 0 ; i < files.length ; i++ )
	    	{  
	    		firstFile = files[i];
	    	   	if(typeof firstFile == 'object')
	    	   	{
	    	   		//var relativePath = firstFile.webkitRelativePath;	//获取第一个文件的相对路径
	    	   		//console.log("firstFile relativePath:"+firstFile.webkitRelativePath);
	    	   		break;
	    	   	}
	    	   	else
	    	   	{
	    	   		//This is something else 
	    	   		//console.log("it is not a file");
	    	   	}
	    	}
	    	if(firstFile.name != "office-editor.zip")
	    	{
		   		showErrorMessage("请选择正确的Office安装文件!");
	      		return false;
	    	}
	    }
	    else
	   	{
	   		showErrorMessage("请选择文件");
	      	return false;
	   	}  
	    
	    
	    qiao.bs.confirm({
	    		id: "installOfficeConfirmDialog",
		        title: "安装Office",
		        msg: "是否安装Office？",
		        okbtn: "是",
		        qubtn: "否",
	    	},function () {
	    		OfficeUpload.startUploadOffice(firstFile);
		    	return true;   //close dialog
	    	},function()
	    	{
	    		return true;	//close dialog
	    	}
	    );
	}
	
	//OfficeUpload类
    var OfficeUpload = (function () {
    	var SubContext ={};   
	
    	function startUploadOffice(file)
		{
			//初始化SubContext
   		   	SubContext.file = file;
   		   	SubContext.size = file.size;
   		   	SubContext.name = file.name;
	    	
   		   	//Status Info
    		SubContext.state = 0;	//未开始上传
    	   	SubContext.status = "待上传";	//未开始上传
    	   	
    	   	//checkSum Init
    	   	SubContext.checkSumState = 0;
    	   	SubContext.checkSum = "";
    	   	
    	   	//StateMachine SMMain\SMSub
    	   	SubContext.SMState = "init";	//uploadDoc状态机的主状态
    	   	SubContext.SMSubState = 0;	//uploadDoc状态机的子状态
    	   	
    	   	//分片上传状态 
    	   	SubContext.cutFileState = 0;
    	   	SubContext.chunked = false;
    		
    	   	uploadDoc();
		}
    	
		//uploadDoc接口，该接口是个递归调用
    	function uploadDoc()
    	{
    		//设置上传状态
    		if(0 == SubContext.state)
    		{   
    			console.log("uploadOffice() 开始上传 fileName:" + SubContext.name, SubContext);
				SubContext.state = 1;	//上传中
    			var file = SubContext.file;
				if(!file) 
				{
					uploadErrorHandler("未知","不是文件");
					return; 
				}
    		}
   			
   			//该接口只对大于50M的文件进行切片，设置chunked标记
   			CutFile(SubContext); 
   			
   			if(false == SubContext.chunked) 
   			{
   	   			startUpload(SubContext);
   	   			return;
   			}
   			else
   			{
   				startChunkUpload(SubContext);	
   			}
    	}
		
    	
    	function startChunkUpload(SubContext)
    	{ 
    		if(SubContext.chunkIndex <  SubContext.chunkNum)
    		{
    	   			if(false == getChunkCheckSum(SubContext))
    	   			{
    	   				//checkSum for chunk is not ready, timer be called, callback will re-enter uploadDoc 100ms later
    	   				return;
    	   			}
       			
    	   			//检查Chunk是否存在且是否相同，return false 表示内部有异步调用
    	   			if(false == checkChunkUploaded(SubContext))
    	   			{
    	    			console.log("startChunkUpload() checkChunkUploaded be called, callback will re-enter uploadDoc");   				
    	   				return;
    	   			}
       			
    	   			//根据chunk.state决定是否上传
    	   			var chunk = SubContext.chunkList[SubContext.chunkIndex];
    				if(1 == chunk.uploadedState)	//current chunk not uploaded
    				{
       					startUpload(SubContext); //Do Upload the chunk
       					return;
    				}
    		}
    	}
    	
		function getChunkCheckSum(SubContext)
		{            
			console.log("getChunkCheckSum() chunkIndex:" + SubContext.chunkIndex)
			var chunk = SubContext.chunkList[SubContext.chunkIndex];
			switch(chunk.checkSumState)
			{
			case 0:
			case 1:
				//Start timer to wait for result
		        console.log("getChunkCheckSum() chunk checkSum not ready, wait for result 100 ms later"); 
				setTimeout(function () {
		            uploadDoc(); //reEnter uploadDoc
		        },100);	//check it one minute later
				return false;
			case 2:
				//CheckSum ok
				return true;
			default:
				//CheckSum Error
				SubContext.checkSum = "";
				return true;
			}
		}
    	
    	function startUpload(SubContext)
    	{
			console.log("startUpload() SubContext:" , SubContext);

			//新建文件上传表单
			var form = new FormData();
			if(false == SubContext.chunked)
			{
				form.append("name", SubContext.name);
				form.append("size", SubContext.size);
				form.append("uploadFile", SubContext.file);
			}
			else
			{
				form.append("name", SubContext.name);
				form.append("size", SubContext.size);

				var chunk = SubContext.chunkList[chunkIndex];
				var chunkData = SubContext.file.slice(chunk.start,chunk.end);
				
				console.log("startUpload() chunkIndex:" + chunkIndex + " chunkNum:" + chunkNum, chunk);

				form.append("chunkNum", SubContext.chunkNum);
				form.append("chunkIndex", SubContext.chunkIndex);
				form.append("cutSize",SubContext.cutSize);
				form.append("chunkSize",chunk.chunkSize);
				form.append("chunkHash", chunk.checkSum);
				form.append("uploadFile", chunkData);
			}
			
			var xhr = new XMLHttpRequest();
			
			//设置异步上传状态变化回调处a理函数
			xhr.onreadystatechange = function() {				
				//文件上传状态
				console.log("xhr onreadystatechange() status:" + xhr.status + " readyState:" + xhr.readyState);
				if(xhr.status == 200) 
				{
					if(xhr.readyState != 4)
					{
						//文件上传未结束
						return;
					}
					
					//上传成功！
					var ret = JSON.parse(xhr.responseText);
					if("ok" == ret.status){
						if(true == SubContext.chunked && false == isLastChunk(SubContext))
						{
							//分片上传未结束,re-enter uploadDoc to upload next chunk
							SubContext.chunkIndex++;
							uploadDoc();
							return;
						}
						showErrorMessage("安装成功");
					 }
					 else	//上传失败
					 {
						//上传失败
						showErrorMessage("安装失败:" + ret.msgInfo);
						return;
		             }
				}else{
					if(xhr.status < 300) 
					{
						//不是真正的异常
						return;
					}
					showErrorMessage("安装失败:服务器异常!");
					return;
				}
			};
			
			//上传表单			
			xhr.open("post", "/DocSystem/Bussiness/uploadOffice.do");
			xhr.send(form);
    	}
    	
    	
		//CutFile will cut file to dedicated size slice
		function CutFile(SubContext)
		{ 	
			if(0 == SubContext.cutFileState)
			{
				console.log("CutFile() for", SubContext);
				var cutSize = 2097152;
				var minCutSize = cutSize * 10;
				if(SubContext.size < minCutSize)	//< 20M do not cut
				{
					SubContext.cutFileState = 2;
					console.log("CutFile() file size less than minCutSize " + minCutSize);
					return true;
				}
				
				console.log("CutFile() start to cut file");
				SubContext.chunked = true;
				SubContext.cutSize = cutSize;
				SubContext.cutFileState = 1;
				SubContext.chunkIndex = 0;
				SubContext.chunkNum = Math.ceil(SubContext.size / cutSize);
				//Build ChunkList
				var chunkList = [];
				for(i=0; i< SubContext.chunkNum; i++)
				{
					var chunk = [];
					var start = i * cutSize;
					chunk.start= start;
					chunk.end =  start + cutSize >= SubContext.size ? SubContext.size : start + cutSize;
					chunk.chunkSize = chunk.end - chunk.start;
					chunk.checkSum = "";
					chunk.checkSumState = 0;
					chunk.uploadedState = 0;
					chunkList.push(chunk);
				}
				SubContext.chunkList = chunkList;
				console.log("CutFile() cut ok",SubContext);
			}
			else if(2 == SubContext.cutFileState)
 	      	{
 	      		//console.log("CutFile() completed for:",SubContext);
 	      		return true;
 	      	}
 	      	else
 	      	{
 	      		console.log("CutFile() is in processing for: ",SubContext);
	      		return false;
 	      	}
 	      		
 	      	//start to caculate the chunk checkSum
 	      	console.log("CutFile() start to caculate chunk checkSum for:" + SubContext.name);
 	      	var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
 	            	file = SubContext.file,
 	            	cutSize = cutSize,                           // read in chunks of 2MB
 	            	chunks = SubContext.chunkNum,
 	            	currentChunk = 0,
 	            	fileReader = new FileReader();
 	      		
        	fileReader.onload = function (e) {
            	if(stopUploadFlag == true || SubContext.stopUploadFlag == true)
            	{
            		console.log("CutFile() upload was stoped, stop caculate chunk checkSum");
                	return;
            	}
    	      	var hash = SparkMD5.hashBinary(e.target.result);   //compute Data Hash
    	      	SubContext.chunkList[currentChunk].checkSum = hash;
    	      	SubContext.chunkList[currentChunk].checkSumState = 2;		            	
            	console.log("CutFile() Chunk " + currentChunk + " data read ok, checkSum is " + hash);
            	
            	//Try to start read next chunk data
            	currentChunk ++;
            	if (currentChunk < chunks) {
                	loadNext();
            	}
            	else
            	{
            		console.log("CutFile() all chunks checkSum is ready ",SubContext);
                	SubContext.cutFileState = 2;
            		return;
            	}
            };
		        
		    function loadNext() {
		    	//console.log("loadNext()");
		    	SubContext.chunkList[currentChunk].checkSumState = 1;
		        var start = SubContext.chunkList[currentChunk].start;
		        var end = SubContext.chunkList[currentChunk].end;
		        //console.log("loadNext() ",start,end);
		        fileReader.readAsBinaryString(blobSlice.call(file, start, end));
		    }
		    
	      	//Trigger the fileRead
		    loadNext();
		    return false;
		}
    	
		//开放给外部的调用接口
        return {
        	startUploadOffice: function(file){
        		startUploadOffice(file);
            },
        };
    })();
	
	//在线安装
	function onlineInstallOfficeConfirm()
	{
		console.log("onlineInstallOfficeConfirm()");
	    qiao.bs.confirm({
	    		id: "onlineInstallOfficeConfirmDialog",
		        title: "安装Office",
		        msg: "是否安装Office？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
				startOnlineInstallOffice();
		    	return true;   //close dialog
	    	},function()
	    	{
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startOnlineInstallOffice()
	{
		console.log("startOnlineInstallOffice()");
		$.ajax({
	        url : "/DocSystem/Bussiness/onlineInstallOffice.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        },
	        success : function (ret) {
	        	console.log("startOnlineInstallOffice ret",ret);
	            if( "ok" == ret.status )
	            {
	            	showErrorMessage("安装成功");
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
		        	showErrorMessage("安装失败:" + ret.msgInfo);	                
	            }
	        },
	        error : function () {
	        	showErrorMessage("安装失败:服务器异常");
	        }
	    });
	}
	
	var systemLogSearchWord = "";
	function searchSystemLog()
	{
		systemLogSearchWord = $("#search-systemLog").val();
		showSystemLogList();
	}
	
	function showSystemLogList(pageIndex){
		var pageSize = gPageSize;
		pageIndex = pageIndex ? pageIndex : 0;
		gPageIndex = pageIndex;
		
		$.ajax({
	        url : "/DocSystem/Bussiness/getSystemLogList.do",
	        type : "post",
	        dataType : "json",
	        data : {
	            searchWord: systemLogSearchWord,
	        	pageIndex: pageIndex,
	        	pageSize: pageSize
	        },
	        success : function (ret) {
	        	console.log("getSystemLogList ret",ret);
	            if( "ok" == ret.status )
	            {
	            	SystemLogListDisplay(ret.data, pageIndex, pageSize, function(){
	
	                    // 渲染分页
	                    var total = ret.dataEx;
	                    $("#systemLogList-pagination").pagination({
	                        /*当前页码*/
	                        currentPage: pageIndex + 1,
	                        /*总共有多少页*/
	                        totalPage: Math.ceil(total/pageSize),
	                        /*是否显示首页、尾页 true：显示 false：不显示*/
	                        isShow:true,
	                        /*分页条显示可见页码数量*/
	                        count:5,
	                        /*第一页显示文字*/
	                        homePageText:'首页',
	                        /*最后一页显示文字*/
	                        endPageText:'尾页',
	                        /*上一页显示文字*/
	                        prevPageText:'上一页',
	                        /* 下一页显示文字*/
	                        nextPageText:'下一页',
	                        /*点击翻页绑定事件*/
	                        callback: function(newPageIndex) {
	                            // 分页插件的页码从1开始，减1处理
	                            showSystemLogList(newPageIndex - 1);
	                        }
	                    });
	                });
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
		        	showErrorMessage("查询失败:" + ret.msgInfo);	                
	            }
	        },
	        error : function () {
	        	showErrorMessage("查询失败:服务器异常");
	        }
	    });
	}
	
	function SystemLogListDisplay(list, pageIndex, pageSize, callback)
    {
		var index = pageIndex ? pageIndex : 0
		var offset = index * pageSize;
       	for(var i=0; i<list.length; i++)
 	    {
       		var node = list[i];
    	    node.pageIndex = pageIndex;
       		node.index = i + offset;
			node.formatedTime = formatTime(node.time);
			formatSystemLogContent(node);
 	    }
       	console.log("SystemLogListDisplay list", list);
        $Func.render($("#container"),"systemLog",{"list":list}, callback);
    }
	
	function formatSystemLogContent(node)
    {
		//console.log("formatSystemLogContent event:" + node.event);
		switch(node.event)
		{
		case "addRepos":
			node.formatedContent = "新建仓库:" + node.reposName;
			break;
		case "deleteRepos":
			node.formatedContent = "删除仓库:" + node.reposName;
			break;
		case "updateReposInfo":
			node.formatedContent = "修改仓库:" + node.reposName;
			break;
		case "configReposAuth":
			node.formatedContent = "设置仓库权限:" + node.reposName;
			break;
		case "deleteReposAuth":
			node.formatedContent = "删除仓库权限:" + node.reposName;
			break;
		case "addDoc":
			node.formatedContent = "新增文件:" + node.reposName + "::" + node.path + node.name;
			break;
		case "deleteDoc":
			node.formatedContent = "删除文件:" + node.reposName + "::" + node.path + node.name;
			break;
		case "uploadDoc":
			node.formatedContent = "上传文件:" + node.reposName + "::" + node.path + node.name;
			break;
		case "downloadDocPrepare":
			node.formatedContent = "下载文件:" + node.reposName + "::" + node.path + node.name;
			break;
		case "downloadDoc":
			node.formatedContent = "下载文件:" + node.path + node.name;
			break;
		case "copyDoc":
			node.formatedContent = "复制文件:" + node.path + node.name + " 到 " + node.newPath + node.newName;
			break;
		case "moveDoc":
			node.formatedContent = "移动文件:" + node.path + node.name + " 到 " + node.newPath + node.newName;
			break;
		case "renameDoc":
			node.formatedContent = "重命名文件:" + node.path + node.name + " 为 " + node.newPath + node.newName;
			break;
		case "updateDocContent":
			node.formatedContent = node.action + node.reposName + "::" + node.path + node.name;
			break;
		case "uploadMarkdownPic":
			node.formatedContent = "上传备注图片:" + node.reposName + "::" + node.path + node.name;
			break;	
		case "lockDoc":
			node.formatedContent = "锁定文件:" + node.reposName + "::" + node.path + node.name;
			break;
		case "unlockDoc":
			node.formatedContent = "解锁文件:" + node.reposName + "::" + node.path + node.name;
			break;
		case "setDocPwd":
			node.formatedContent = "设置文件访问密码:" + node.reposName + "::" + node.path + node.name;
			break;
		case "downloadHistoryDocPrepare":
			node.formatedContent = "下载历史文件:" + node.reposName + "::" + node.path + node.name + " " + node.content;
			break;
		case "revertDocHistory":
			node.formatedContent = "恢复文件历史版本:" + node.reposName + "::" + node.path + node.name + " " + node.content;
			break;
		case "addDocShare":
			node.formatedContent = "新建文件分享:" + node.reposName + "::" + node.path + node.name;
			break;
		case "updateDocShare":
			node.formatedContent = "修改文件分享:" + node.content;
			break;
		case "deleteDocShare":
			node.formatedContent = "删除文件分享:" + node.content;
			break;
		case "configDocAuth":
			node.formatedContent = "设置文件权限:" + node.reposName + "::" + node.path + node.name;
			break;
		case "deleteDocAuth":
			node.formatedContent = "删除文件权限:" + node.reposName + "::" + node.path + node.name;
			break;
		case "login":
			node.formatedContent = "登录系统" + node.content;
			break;
		case "logout":
			node.formatedContent = "退出登录" + node.content;
			break;
		case "register":
			node.formatedContent = "用户注册" + node.content;
			break;
		default:
			node.formatedContent = node.content;
			break;
		}
    }
	
	function delSystemLogConfirm(id, time, pageIndex, index)
	{	
		console.log("delSystemLogConfirm pageIndex:" + pageIndex);
		qiao.bs.confirm({
			id: "delSystemLogConfirm",
	        title: "删除日志",
	        msg: "是否删除日志？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	deleteSystemLog(id, time, pageIndex, index);
	    	return true;   
	    });
	}
	
	function deleteSystemLog(id, time, pageIndex, index){
		console.log("deleteSystemLog pageIndex:" + pageIndex);
        $.ajax({
            url : "/DocSystem/Bussiness/deleteSystemLog.do",
            type : "post",
            dataType : "json",
            data : {
            	logId : id,
            	time : time,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                	//if(index == 0 && pageIndex != 0)
                	//{
                	//	pageIndex -= 1;
                	//}
                	showSystemLogList(pageIndex);	//刷新list
                    showErrorMessage("删除成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}
	
	var orderSearchWord = "";
	function searchOrder()
	{
		orderSearchWord = $("#search-order").val();		
		showOrderList();		
	}
	function showOrderList(pageIndex){
		var pageSize = gPageSize;
		pageIndex = pageIndex ? pageIndex : 0;
		gPageIndex = pageIndex;

		$.ajax({
	        url : "/DocSystem/pay/getOrderList.do",
	        type : "post",
	        dataType : "json",
	        data : {
	            searchWord: orderSearchWord,
	        	pageIndex: pageIndex,
	        	pageSize: pageSize
	        },
	        success : function (ret) {
	        	console.log("getOrderList ret",ret);
	            if( "ok" == ret.status )
	            {
	            	OrderListDisplay(ret.data, pageIndex, pageSize, function(){
	
	                    // 渲染分页
	                    var total = ret.dataEx;
	                    $("#orderList-pagination").pagination({
	                        /*当前页码*/
	                        currentPage: pageIndex + 1,
	                        /*总共有多少页*/
	                        totalPage: Math.ceil(total/pageSize),
	                        /*是否显示首页、尾页 true：显示 false：不显示*/
	                        isShow:true,
	                        /*分页条显示可见页码数量*/
	                        count:5,
	                        /*第一页显示文字*/
	                        homePageText:'首页',
	                        /*最后一页显示文字*/
	                        endPageText:'尾页',
	                        /*上一页显示文字*/
	                        prevPageText:'上一页',
	                        /* 下一页显示文字*/
	                        nextPageText:'下一页',
	                        /*点击翻页绑定事件*/
	                        callback: function(newPageIndex) {
	                            // 分页插件的页码从1开始，减1处理
	                            showOrderList(newPageIndex - 1);
	                        }
	                    });
	            	});
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("获取订单列表失败:服务器异常");
	        }
	    });
	}
	
	function OrderListDisplay(list, pageIndex, pageSize, callback)
    {
		var index = pageIndex ? pageIndex : 0
		var offset = index * pageSize;
		       	
       	for(var i=0; i<list.length; i++)
 	    {
       		var node = list[i];
    	    node.pageIndex = pageIndex;
    	 	node.index = i + offset;
    		node.createDate = formatTime(node.createTime);
    		node.formatedState = formateOrderSatus(node);
    		node.formatedPayType = formatePayType(node);
			node.showRefund = needShowRefundBtn(node);
 	    }		
		$Func.render($("#container"),"order",{"list":list}, callback);
    }
	
	function needShowRefundBtn(node)
	{
		//没有退款成功的订单都可以继续退款
		if(node.payType == "Pay" && node.orderStatus != "Refunded")
		{
			var curTime = new Date().getTime();
			//console.log("needShowRefundBtn curTime:" + curTime + " createTime:" + node.createTime + " diff:" + (curTime - node.createTime));
			if(curTime <= node.createTime)
			{
				return true;
			}	
			
			//根据订单时间决定是否显示
			var diff = curTime - node.createTime;
		    switch(node.orderStatus)
		    {
		    case "Paid":
		    case "Success":
		    	//支付成功的订单一个月后不许退款
				return 	(diff < 30*24*60*60*1000);
			default:
				//支付异常的订单7天后不许退款
				return (diff < 7*24*60*60*1000);
		    }
		}
		return false;
	}
	
	function formatePayType(node)
	{
		switch(node.payType)
		{
		case "Pay":
			return "付款";
		case "Refund":
			return "退款";
		}
		return node.payType;
	}
	
	function formateOrderSatus(node)
	{
		switch(node.orderStatus)
		{
		case "Processing":
				return "未完成";
		case "Paid":
		case "Success":
				return "成功";
		case "Failed":
				return "失败";
		case "Refunded":
				return "已全额退款";		
		}
		return node.orderStatus;
	}
	
	function refundOrderConfirm(orderNo, pageIndex, index)
	{	
		console.log("refundLicenseConfirm pageIndex:" + pageIndex);
		qiao.bs.confirm({
			id: "refundLicenseConfirm",
	        title: "退款",
	        msg: "是否退款？",
	        okbtn: "退款",
	        qubtn: "取消",
	    },function () {
	    	refundOrder(orderNo, pageIndex, index);
	    	return true;   
	    });
	}
	
	function refundOrder(orderNo, pageIndex, index){
		console.log("refundOrder pageIndex:" + pageIndex);
		$.ajax({
            url : "/DocSystem/pay/refund/" + orderNo,
            type : "post",
            dataType : "json",
            data : {},
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showOrderList(pageIndex);
                    showErrorMessage("退款成功");
                }else {
                   	showOrderList(pageIndex);
                	showErrorMessage("退款失败：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("退款失败：服务器异常");
            }
        });
	}
	
	var licenseSearchWord = "";
	function searchLicense()
	{
		licenseSearchWord = $("#search-license").val();
		showLicenseList();
	}
	
	function showLicenseList(pageIndex){
		
		var pageSize = gPageSize;
		pageIndex = pageIndex ? pageIndex : 0;
		gPageIndex = pageIndex;
		
		$.ajax({
	        url : "/DocSystem/Sales/getLicenseList.do",
	        type : "post",
	        dataType : "json",
	        data : {
	            searchWord: licenseSearchWord,
	        	pageIndex: pageIndex,
	        	pageSize: pageSize
	        },
	        success : function (ret) {
	        	console.log("getLicenseList ret",ret);
	            if( "ok" == ret.status )
	            {
	            	LicenseListDisplay(ret.data, pageIndex, pageSize, function(){
	
	                    // 渲染分页
	                    var total = ret.dataEx;
	                    $("#licenseList-pagination").pagination({
	                        /*当前页码*/
	                        currentPage: pageIndex + 1,
	                        /*总共有多少页*/
	                        totalPage: Math.ceil(total/pageSize),
	                        /*是否显示首页、尾页 true：显示 false：不显示*/
	                        isShow:true,
	                        /*分页条显示可见页码数量*/
	                        count:5,
	                        /*第一页显示文字*/
	                        homePageText:'首页',
	                        /*最后一页显示文字*/
	                        endPageText:'尾页',
	                        /*上一页显示文字*/
	                        prevPageText:'上一页',
	                        /* 下一页显示文字*/
	                        nextPageText:'下一页',
	                        /*点击翻页绑定事件*/
	                        callback: function(newPageIndex) {
	                            // 分页插件的页码从1开始，减1处理
	                            showLicenseList(newPageIndex - 1);
	                        }
	                    });
	                });
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("获取证书列表失败:服务器异常");
	        }
	    });
	}
	
	function LicenseListDisplay(list, pageIndex, pageSize, callback)
    {
		var index = pageIndex ? pageIndex : 0
		var offset = index * pageSize;
		       	
       	for(var i=0; i<list.length; i++)
 	    {
       		var node = list[i];
    	    node.pageIndex = pageIndex;
      		node.index = i + offset;
    		node.createDate = formatTime(node.createTime);
			node.expireDate = "长期";
			if(node.expireTime)
			{
				node.expireDate = formatDate(node.expireTime);				
			}
			node.formatedState = "正常";
			if(node.state != undefined)
			{
				if(node.state == 0)
				{
					node.formatedState = "已作废";
				}
			}

			node.formatedType = getFormatedLicenseType(node.type, node.hasLicense);
			
			if(node.installedCount)
			{
				node.formatedInstallInfo = "已安装" + node.installedCount + "次, [" + node.installedMacList + "]";
			}
 	    }		
		$Func.render($("#container"),"license",{"list":list}, callback);
    }
	
	function downloadLicenseConfirm(id)
	{	
		console.log("downloadLicenseConfirm id:", id);
		qiao.bs.confirm({
			id: "downloadLicenseConfirm",
	        title: "下载证书",
	        msg: "是否下载证书？",
	        okbtn: "下载",
	        qubtn: "取消",
	    },function () {
	    	downloadLicense(id);
	    	return true;   
	    });
	}
	
	function downloadLicense(id){
        $.ajax({
            url : "/DocSystem/Sales/downloadLicense.do",
            type : "post",
            dataType : "json",
            data : {
            	licenseId : id,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
            	    console.log("downloadLicense Ok:",ret);        	   		
	            	window.location.href = ret.data;
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}
	
	function delLicenseConfirm(id, pageIndex, index)
	{	
		console.log("delLicenseConfirm pageIndex:" + pageIndex);
		qiao.bs.confirm({
			id: "delLicenseConfirm",
	        title: "删除证书",
	        msg: "是否删除证书？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	delLicense(id, pageIndex, index);
	    	return true;   
	    });
	}
	
	function delLicense(id, pageIndex, index){
		console.log("delLicense pageIndex:" + pageIndex);
		$.ajax({
            url : "/DocSystem/Sales/deleteLicense.do",
            type : "post",
            dataType : "json",
            data : {
            	licenseId : id,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                	//if(index == 0 && pageIndex != 0)
                	//{
                	//	pageIndex -= 1;
                	//}
                   	showLicenseList(pageIndex);
                    showErrorMessage("删除成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}
	
	function deperacateLicenseConfirm(id, pageIndex)
	{	
		console.log("deperacateLicenseConfirm pageIndex:" + pageIndex);
		qiao.bs.confirm({
			id: "deperacateLicenseConfirm",
	        title: "作废证书",
	        msg: "是否作废证书？",
	        okbtn: "作废",
	        qubtn: "取消",
	    },function () {
	    	deperacateLicense(id, pageIndex);
	    	return true;   
	    });
	}
	
	function deperacateLicense(id, pageIndex){
		console.log("deperacateLicense pageIndex:" + pageIndex);
		$.ajax({
            url : "/DocSystem/Sales/deperacateLicense.do",
            type : "post",
            dataType : "json",
            data : {
            	licenseId : id,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showLicenseList(pageIndex);
                    showErrorMessage("证书已作废");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("操作失败:服务器异常");
            }
        });
	}
	
	
	//成员管理
    var userSearchWord = "";	//清除搜索关键字
	function searchUser()
	{
		userSearchWord = $("#search-userName").val();
		showUserList();
	}
    
	function showUserList(pageIndex){
		console.log("showUserList pageIndex:" + pageIndex);
		
		var pageSize = gPageSize;
		pageIndex = pageIndex ? pageIndex : 0;
		gPageIndex = pageIndex; //所有分页都是用的同一个gPageIndex
				
		$.ajax({
	        url : "/DocSystem/Manage/getUserList.do",
	        type : "post",
	        dataType : "json",
	        data : {
	            // 新增用户名搜索条件
	            userName: userSearchWord,
	        	pageIndex: pageIndex,
	        	pageSize: pageSize
	        },
	        success : function (ret) {
	        	console.log("getUserList ret",ret);
	            if( "ok" == ret.status )
	            {
	            	UserListDisplay(ret.data, pageIndex, pageSize, function(){
	                    // 渲染分页
	                    var total = ret.dataEx;
	                    gTotal = total;
	                    $("#userList-pagination").pagination({
	                        /*当前页码*/
	                        currentPage: pageIndex + 1,
	                        /*总共有多少页*/
	                        totalPage: Math.ceil(total/pageSize),
	                        /*是否显示首页、尾页 true：显示 false：不显示*/
	                        isShow:true,
	                        /*分页条显示可见页码数量*/
	                        count:5,
	                        /*第一页显示文字*/
	                        homePageText:'首页',
	                        /*最后一页显示文字*/
	                        endPageText:'尾页',
	                        /*上一页显示文字*/
	                        prevPageText:'上一页',
	                        /* 下一页显示文字*/
	                        nextPageText:'下一页',
	                        /*点击翻页绑定事件*/
	                        callback: function(newPageIndex) {
	                            // 分页插件的页码从1开始，减1处理
	                            showUserList(newPageIndex - 1);
	                        }
	                    });
	                });
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户列表失败");
	        }
	    });
	}
	
	function UserListDisplay(list, pageIndex, pageSize, callback)
    {
		var index = pageIndex ? pageIndex : 0
		var offset = index * pageSize;
				       	
		for(var i=0; i<list.length; i++)
	 	{
	    	var node = list[i];
	       	node.pageIndex = pageIndex;
      		node.index = i + offset;
	 	}
		$Func.render($("#container"),"user",{"list":list}, callback);
    }
	
	function exportUserConfirm()
	{
		console.log("exportUserConfirm userSearchWord:" + userSearchWord);
		qiao.bs.confirm({
			id: "exportUserConfirmDialog",
	        title: "导出用户",
	        msg: "是否导出用户？",
	        okbtn: "导出",
	        qubtn: "取消",
	    },function () {
	    	exportUserList(userSearchWord);
	    	return true;   
	    });
	}
	
	function exportUserList(userSearchWord){
		console.log("exportUserList userSearchWord:" + userSearchWord);
		
		$.ajax({
	        url : "/DocSystem/Bussiness/exportUserList.do",
	        type : "post",
	        dataType : "json",
	        data : {
	            // 新增用户名搜索条件
	            searchWord: userSearchWord,
	        },
	        success : function (ret) {
	        	console.log("exportUserList ret",ret);
	            if( "ok" == ret.status )
	            {
            	    console.log("exportUserList Ok");        	   		
	            	window.location.href = ret.data;
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
		        	showErrorMessage("导出用户列表失败：" + ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("导出用户列表失败：服务器异常");
	        }
	    });
	}
	
	
	function delUserConfirm(userId, pageIndex, index)
	{	
		console.log("delUserConfirm userId:" + userId + " pageIndex:" + pageIndex);
		qiao.bs.confirm({
			id: "delUserConfirmDialog",
	        title: "删除用户",
	        msg: "是否删除用户？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	delUser(userId, pageIndex, index);
	    	return true;   
	    });
	}
	
	function delUser(userId, pageIndex, index){
		console.log("delUser userId:" + userId + " pageIndex:" + pageIndex);
        $.ajax({
            url : "/DocSystem/Manage/delUser.do",
            type : "post",
            dataType : "json",
            data : {
                 userId : userId,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                	showUserList(pageIndex);	//刷新UserList
                    showErrorMessage("删除成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}
	
	//showAddUserPanel
	function showAddUserPanel(){
		console.log("showAddUserPanel");
		qiao.bs.dialog({
			id: 'addUser',
			url: 'addUser.html',
			title: '新增用户',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		});
	}
	
	//showAddOfficeLicensePanel
	function showAddOfficeLicensePanel(){
		console.log("showAddOfficeLicensePanel");
		qiao.bs.dialog({
			id: 'addOfficeLicense',
			url: 'addOfficeLicense.html',
			title: '新增Office证书',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		});
	}
	
	function importLicense(){
		console.log("importLicense()");
  		//清除文件控件
		$("#importLicenseFiles").val("");
	    return $("#importLicenseFiles").click();
	}
	
	function importLicenseConfirm(e)
	{
		console.log("importLicenseConfirm()");
	    var files = e.target.files;
	    var firstFile;
	    if(files.length > 0)
	   	{
	    	console.log("files.length:" + files.length);
	    	for( var i = 0 ; i < files.length ; i++ )
	    	{  
	    		firstFile = files[i];
	    	   	if(typeof firstFile == 'object')
	    	   	{
	    	   		var relativePath = firstFile.webkitRelativePath;	//获取第一个文件的相对路径
	    	   		console.log("firstFile relativePath:"+firstFile.webkitRelativePath);
	    	   		break;
	    	   	}
	    	   	else
	    	   	{
	    	   		//This is something else 
	    	   		//console.log("it is not a file");
	    	   	}
	    	}
	    }
	    else
	   	{
	   		showErrorMessage("请选择文件");
	      	return false;
	   	}  
			    
	    qiao.bs.confirm({
	    		id: "importLicenseConfirmDialog",
		        title: "证书导入",
		        msg: "是否导入证书？",
		        okbtn: "确认",
		        qubtn: "取消",
	    	},function () {
		    	//showErrorMessage("点击了确定");
				//开始上传
				startImportLicense(firstFile);
		    	return true;   //close dialog
	    	},function()
	    	{
	    		//showErrorMessage("点击了取消")
	    		return true;	//close dialog
	    	}
	    );
	}
	
	function startImportLicense(file)
	{
		//新建文件上传表单
		var form = new FormData();
		form.append("uploadFile", file);

		//新建http异步请求
		var xhr = new XMLHttpRequest();
		
		//设置异步上传状态变化回调处a理函数
		xhr.onreadystatechange = function() {				
			//文件上传状态
			console.log("xhr onreadystatechange() status:" + xhr.status + " readyState:" + xhr.readyState);
			if(xhr.status == 200) 
			{
				if(xhr.readyState != 4)
				{
					//文件上传未结束
					return;
				}
				
				//上传成功！
				var ret = JSON.parse(xhr.responseText);
				if("ok" == ret.status){
					showLicenseList();	//刷新LicenseList
					showErrorMessage("导入成功");
				 }
				 else	//上传失败
				 {
					//上传失败
					console.log("导入失败：" + ret.msgInfo);
					showErrorMessage("导入失败:" + ret.msgInfo);
					return;
	             }
			}else{
				if(xhr.status < 300) 
				{
					//不是真正的异常
					return;
				}
				//上传失败
				console.log("导入失败: " + file.name + " 上传异常！");
				showErrorMessage("导入失败: 上传异常");
				return;
			}
		};
		
		//上传表单			
		xhr.open("post", "/DocSystem/Sales/importLicense.do");
		xhr.send(form);
	}
	
	
	//showAddLicensePanel
	function showAddLicensePanel(){
		console.log("showAddLicensePanel");
		qiao.bs.dialog({
			id: 'addLicense',
			url: 'addLicense.html',
			title: '新增证书',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		});
	}
	
	//showSystemLicensePanel
	function showSystemLicenseInfoPanel(){
		console.log("showSystemLicenseInfoPanel");
		qiao.bs.dialog({
			id: 'systemLicenseInfo',
			url: 'systemLicenseInfo.html',
			title: '系统证书',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    var systemLicenseInfo = systemLicenses.systemLicense;
			    systemLicenseInfo.formatedType = getFormatedLicenseType(systemLicenseInfo.type, systemLicenseInfo.hasLicense);
			    SystemLicenseInfoPageCallback(systemLicenseInfo);
			}
		});
	}

	function getFormatedLicenseType(type, hasLicense)
	{
		var formatedType = "未知";			
		if(type != undefined)
		{
			switch(type)
			{
			case 0: //开源版
				formatedType = "开源版";
				break;
			case 1: //企业版
				formatedType = "企业版";
				if(hasLicense != undefined && hasLicense == false)
				{
					formatedType = "企业版(试用)";
				}
				break;
			case 2: //专业版
				formatedType = "专业版";
				if(hasLicense != undefined && hasLicense == false)
				{
					formatedType = "专业版(试用)";
				}
				break;
			case 3: //个人版
				formatedType = "个人版";
				break;
			}
		}
		else
		{
			//老版证书都是企业版
			formatedType = "企业版";				
		}
		return formatedType;
	}
	
	//showOfficeLicenseInfoPanel
	function showOfficeLicenseInfoPanel(){
		console.log("showOfficeLicenseInfoPanel");
		//后台管理页面的对话框都需要指定id
		qiao.bs.dialog({
			id: 'officeLicenseInfo',
			url: 'officeLicenseInfo.html',
			title: 'Office证书',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    var officeLicenseInfo = systemLicenses.officeLicense;
			    OfficeLicenseInfoPageCallback(officeLicenseInfo);
			}
		});
	}

	function showEditUserPanel(e, userId, pageIndex, index)
	{
		console.log("showEditUserPanel() userId:" + userId + " pageIndex:" + pageIndex);
		gPageIndex = pageIndex;
		//TODO: 以下代码从显示元素里读取仓库信息存在风险,显示内容的顺序和含义修改会导致信息错误
		var Obj = e.target;
		var trObj =  $(e.target).parent().parent();
		var name = trObj.children("td:eq(2)").text();
		var type = trObj.children("td:eq(3)").text();
		var nickName = trObj.children("td:eq(4)").text();
		var realName = trObj.children("td:eq(5)").text();
		var tel = trObj.children("td:eq(6)").text();
		var email = trObj.children("td:eq(7)").text();
		
		qiao.bs.dialog({
			url: 'editUser.html',
			title: '编辑用户',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#userId").val(userId);
				$("#name").val(name);
			    $("#realName").val(realName);
			    //$("#pwd").val(pwd);
			    $("#type").val(type);
			}
		}, null);	
	}
	
	function randomPassword(size)
	{
	  var seed = new Array('A','B','C','D','E','F','G','H','I','J','K','L','M','N','P','Q','R','S','T','U','V','W','X','Y','Z',
	  'a','b','c','d','e','f','g','h','i','j','k','m','n','p','Q','r','s','t','u','v','w','x','y','z',
	  '2','3','4','5','6','7','8','9'
	  );//数组
	  seedlength = seed.length;//数组长度
	  var createPassword = '';
	  for (i=0;i<size;i++) {
	    j = Math.floor(Math.random()*seedlength);
	    createPassword += seed[j];
	  }
	  return createPassword;
	}
	
	function showResetPwdPanel(e, userId, pageIndex, index)
	{
		console.log("showResetPwdPanel() userId:" + userId + " pageIndex:" + pageIndex);
		gPageIndex = pageIndex;
		
		var Obj = e.target;
		var trObj =  $(e.target).parent().parent();
		var name = trObj.children("td:eq(2)").text();
		var pwd = randomPassword(8);
		
		qiao.bs.dialog({
			url: 'resetPwd.html',
			title: '重置密码',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#userId").val(userId);
				$("#name").val(name);
			    $("#pwd").val(pwd);
			}
		}, null);	
	}
	
	//证书安装
	var systemLicenses = {};
	function showSystemLicenses(){
		$.ajax({
	        url : "/DocSystem/Manage/getSystemLicenses.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	systemLicenses = ret.data;
	            	SystemLicensesDisplay(systemLicenses);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取证书列表失败");
	        }
	    });
	}
	
	function SystemLicensesDisplay(systemLicenses)
	{
		console.log("SystemLicensesDisplay", systemLicenses);
		var systemLicense = systemLicenses.systemLicense;
		if(systemLicense.hasLicense == false)
		{
			systemLicense.status = "未安装";
		}
		else
		{
			systemLicense.status = "已安装";	
			if(systemLicense.state != undefined)
			{
				if(systemLicense.state == 0)
				{
					systemLicense.status = "已失效";							
				}				
			}
		}
		
		var officeLicense = systemLicenses.officeLicense;
		if(officeLicense.hasLicense == false)
		{
			officeLicense.status = "未安装";
		}
		else{
			officeLicense.status = "已安装";		
			if(officeLicense.state != undefined)
			{
				if(officeLicense.state == 0)
				{
					officeLicense.status = "已失效";							
				}				
			}
		}
		
		$Func.render($("#container"),"systemLicenses",{"value":systemLicenses});
	}
	
	//仓库管理
	var gReposList = [];
	function showReposList(){
		$.ajax({
	        url : "/DocSystem/Manage/getReposList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	gReposList = ret.data;
	            	ReposListDisplay(ret.data);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取仓库列表失败");
	        }
	    });
	}

	function ReposListDisplay(list)
	{
		for(var i=0; i<list.length; i++)
	 	{
	    	var node = list[i];
	       	node.formatedType = formateReposType(node.type);
     	}
		console.log("ReposListDisplay", list);
		$Func.render($("#container"),"repos",{"list":list});
	}

   	function formateReposType(type)
   	{
   		switch(type)
   		{
   		case 1:
   		case 2:
   			return "文件管理系统";
 		default:
   			return "文件服务器前置";
   		}
   		return type;
   	}

	//showAddReposPanel
	function showAddReposPanel(){
		console.log("showAddReposPanel");
		qiao.bs.dialog({
			url: 'addRepos.html',
			title: '新增仓库',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		}, null);
	}
	
	function clearAllReposCacheConfirm()
	{	
		console.log("clearAllReposCacheConfirm");
		qiao.bs.confirm({
			id: "clearAllReposCacheConfirmDialog",
	        title: "清除缓存",
	        msg: "是否清除所有仓库缓存？",
	        okbtn: "确定",
	        qubtn: "取消",
	    },function () {
	    	clearAllReposCache();
	    	return true;   
	    });
	}
	
	function clearAllReposCache()
	{
		console.log("clearAllReposCache()");
	    $.ajax({
	        url : "/DocSystem/Repos/clearAllReposCache.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status ){
	            	// 普通消息提示条
					bootstrapQ.msg({
							msg : '清除成功！',
							type : 'success',
							time : 2000,
						    });
	            }
	            else
	            {
	            	showErrorMessage("清除失败:" + ret.msgInfo);
	            }
	        },
	        error : function () {
	           	showErrorMessage('清除失败:服务器异常！');
	        }
		});
	}
	
	function delReposConfirm(id)
	{	
		console.log("delReposConfirm");
		qiao.bs.confirm({
			id: "delReposConfirmDialog",
	        title: "删除仓库",
	        msg: "是否删除仓库，仓库数据将无法恢复？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	delRepos(id);
	    	return true;   
	    });
	}
	
	function delRepos(reposId){
        $.ajax({
            url : "/DocSystem/Repos/deleteRepos.do",
            type : "post",
            dataType : "json",
            data : {
                 vid : reposId,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showReposList();	//刷新ReposList
                    showErrorMessage("删除成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}
	
	function showEditReposPanel(e, reposId, type, index)
	{
		console.log("showEditReposPanel() " + reposId + " type:" + type + " index:" + index);
		
		var repos = gReposList[index];
		//TODO: 以下代码从显示元素里读取仓库信息存在风险,显示内容的顺序和含义修改会导致信息错误
		//var Obj = e.target;
		//var trObj =  $(e.target).parent().parent();
		//var name = trObj.children("td:eq(1)").text();
		//var info = trObj.children("td:eq(2)").text();		
		//var path = trObj.children("td:eq(3)").text();		
		
		qiao.bs.dialog({
			url: 'editRepos.html',
			title: '编辑仓库',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#reposId").val(reposId);
			    EditReposPageInit(repos);
			    
			    //$("#name").val(name);
			    //$("#info").val(info);
				//$("#path").val(path);
			   	//$("#type option[value='"+type+"']").attr("selected","selected");
			}
		}, null);	
	}
	
	//显示组成员管理页面
	function showManageReposMemberPanel(e,reposId){
		console.log("showManageReposMemberPanel reposId:" + reposId);
		
		//get current click the Repos Info
		var Obj = e.target;
		console.log(Obj);
		var trObj =  $(e.target).parent().parent();
		//var reposId = trObj.children("td:eq(0)").text();
		var ReposName = trObj.children("td:eq(1)").text();
		
		qiao.bs.dialog({
			title: '成员管理 -'+ ReposName,
			url: 'manageReposMember.html',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: true,
			callback: function(){
				manageReposMemberPageInit(reposId);
			},
		});
	}
	
	function showReposManagerPage(e, reposId){
		//open reposManager in new page
		window.open("/DocSystem/web/reposManager.html?vid=" + reposId);
	}
	
	//用户组管理
	function showGroupList(){
		$.ajax({
	        url : "/DocSystem/Manage/getGroupList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	GroupListDisplay(ret.data);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户组列表失败");
	        }
	    });
	}

	function GroupListDisplay(list)
	{
		console.log("GroupListDisplay", list);
		$Func.render($("#container"),"group",{"list":list});
	}
		
	
	//showAddGroupPanel
	function showAddGroupPanel(){
		console.log("showAddGroupPanel");
		qiao.bs.dialog({
			id: 'addGroup',
			url: 'addGroup.html',
			title: '新增用户组',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		}, null);
	}
	
	function delGroupConfirm(id)
	{	
		console.log("delGroupConfirm");
		qiao.bs.confirm({
			id: "delGroupConfirmDialog",
	        title: "删除用户组",
	        msg: "是否删除用户组？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	delGroup(id);
	    	return true;   
	    });
	}
	
	function delGroup(id){
        $.ajax({
            url : "/DocSystem/Manage/delGroup.do",
            type : "post",
            dataType : "json",
            data : {
                 id : id,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showGroupList();	//刷新GroupList
                    showErrorMessage("删除成功");
                }else {
                	showErrorMessage("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:删除失败");
            }
        });
	}
	
	function showEditGroupPanel(e, id)
	{
		console.log("showEditGroupPanel() " + id);
		var Obj = e.target;
		var trObj =  $(e.target).parent().parent();
		var groupId = trObj.children("td:eq(0)").text();
		var name = trObj.children("td:eq(1)").text();
		var info = trObj.children("td:eq(2)").text();		
		
		qiao.bs.dialog({
			url: 'editGroup.html',
			title: '编辑用户组',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#groupId").val(groupId);
				$("#name").val(name);
			    $("#info").val(info);
			}
		}, null);	
	}
	
	//显示组成员管理页面
	function showManageGroupMemberPanel(e,groupId){
		console.log("showManageGroupMemberPanel groupId:" + groupId);
		
		//get current click the Group Info
		var Obj = e.target;
		console.log(Obj);
		var trObj =  $(e.target).parent().parent();
		//var groupId = trObj.children("td:eq(0)").text();
		var groupName = trObj.children("td:eq(1)").text();
		
		qiao.bs.dialog({
			title: '成员管理 -'+ groupName,
			url: 'manageGroupMember.html',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: true,
			callback: function(){
				manageGroupMemberPageInit(groupId);
			},
		});
	}
	
	// 快速查找指定的项
	function fastSearch(_this){
	    var $this = $(_this);
	    var event = $this.attr("data-eb-xevent");
	    var event2 = $("#examine").attr("data-eb-xparam");
	    var value = $this.val();
	    var type = $this.attr("data-type");
	
	    $Current.ajax(event,{name:value,type:type},function(ret){
	        console.log(ret);
	        ret.data.page.curExamine = "0";
	        bus.trigger(event2,ret.data.page);
	    });
	}

	function exit(){
		console.log("logout");
        $.ajax({
            url : "/DocSystem/User/logout.do",
            type : "post",
            dataType : "json",
            data : {},
            success : function (ret) {
                if( "ok" == ret.status ){
                	console.log("已退出登录");
                	window.location.href = "login.html";
                }else {
                    showErrorMessage("错误："+ret.msgInfo);
                }
            },
            error : function () {
                showErrorMessage("服务器异常:退出登录失败");
            }
        });
	}
	
 	function formatDate(date) {
 		var now = new Date(date);
 		var year=now.getFullYear(); 
 		var month=now.getMonth()+1;
 		var date=now.getDate(); 
 		return year+"-"+month+"-"+date; 
 	}
 	
 	function formatTime(time){
 		var now = new Date(time);
 		var year=now.getFullYear(); 
 		var month=now.getMonth()+1;
 		var date=now.getDate(); 
 		var hh=now.getHours(); 
 		var mm=now.getMinutes(); 
 		var ss=now.getSeconds(); 
 		
 		return year+"-"+month+"-"+date + " " + hh+":"+mm+":"+ss; 
 	}
</script>
</body>
</html>