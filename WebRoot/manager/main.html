<!DOCTYPE html>
<html lang="cn">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <!-- Title and other stuffs -->
  <title>后台管理系统</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="keywords" content="DocSys" />
  <meta name="description" content="DocSys管理后台" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Rainy">
  <!-- Stylesheets -->
  <link href="./static/style/bootstrap.css" rel="stylesheet">
  <!-- Font awesome icon -->
  <link rel="stylesheet" href="./static/style/font-awesome.css">
  <!-- jQuery UI -->
  <link rel="stylesheet" href="./static/style/jquery-ui.css">
  <!-- Calendar -->
  <link rel="stylesheet" href="./static/style/fullcalendar.css">
  <!-- prettyPhoto -->
  <link rel="stylesheet" href="./static/style/prettyPhoto.css">
  <!-- Star rating -->
  <link rel="stylesheet" href="./static/style/rateit.css">
  <!-- Date picker -->
  <link rel="stylesheet" href="./static/style/bootstrap-datetimepicker.min.css">
  <!-- CLEditor -->
  <link rel="stylesheet" href="./static/style/jquery.cleditor.css">
  <!-- Bootstrap toggle -->
  <link rel="stylesheet" href="./static/style/bootstrap-switch.css">
  <!-- Main stylesheet -->
  <link href="./static/style/style.css" rel="stylesheet">
  <!-- Widgets stylesheet -->
  <link href="./static/style/widgets.css" rel="stylesheet">
  
  <!-- jQuery -->
  <script src="./static/js/jquery.js"></script>
  <script src="./static/js/bootstrap.js"></script> <!-- Bootstrap -->
  <script src="./static/js/jquery-ui-1.9.2.custom.min.js"></script> <!-- jQuery UI -->
  <script src="./static/js/fullcalendar.min.js"></script> <!-- Full Google Calendar - Calendar -->
  <script src="./static/js/jquery.rateit.min.js"></script> <!-- RateIt - Star rating -->
  <script src="./static/js/jquery.prettyPhoto.js"></script> <!-- prettyPhoto -->
  <script src="./static/js/ajaxfileupload.js"></script>

  <!-- jQuery Flot -->
  <script src="./static/js/excanvas.min.js"></script>
  <script src="./static/js/jquery.flot.js"></script>
  <script src="./static/js/jquery.flot.resize.js"></script>
  <script src="./static/js/jquery.flot.pie.js"></script>
  <script src="./static/js/jquery.flot.stack.js"></script>

  <!-- jQuery Notification - Noty -->
  <script src="./static/js/jquery.noty.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/themes/default.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/bottom.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/topRight.js"></script> <!-- jQuery Notify -->
  <script src="./static/js/layouts/top.js"></script> <!-- jQuery Notify -->
  <!-- jQuery Notification ends -->


  <script src="./static/js/sparklines.js"></script> <!-- Sparklines -->
  <script src="./static/js/jquery.cleditor.min.js"></script> <!-- CLEditor -->
  <script src="./static/js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
  <script src="./static/js/bootstrap-switch.min.js"></script> <!-- Bootstrap Toggle -->

  <script src="./static/js/jquery.raty.js"></script>
  <script src="./static/js/jquery.toastmessage-min.js"></script>
  <script src="./static/js/filter.js"></script> <!-- Filter for support page -->
  <script src="./static/js/custom.js"></script> <!-- Custom codes -->
  <script src="./static/js/config.js"></script>
  <script src="./static/js/tmpl.js"></script>
  
  <!-- bootstrapQ based on jquery and bootstrap-->
  <link href="./static/bootstrapQ/qiao.css" rel="stylesheet">
  <script type="text/javascript" src="./static/bootstrapQ/qiao.js"></script>  
  

  <!-- HTML5 Support for IE -->
  <!--[if lt IE 9]>
  <script src="./static/js/html5shim.js"></script>
  <![endif]-->

  <!-- Favicon -->
  <link rel="shortcut icon" href="./static/img/icons/metro.png">
</head>

<body>

<div class="navbar navbar-fixed-top bs-docs-nav" role="banner">

  <div class="conjtainer">
    <!-- Menu button for smallar screens -->
    <div class="navbar-header">
      <button class="navbar-toggle btn-navbar" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span>菜单</span>
      </button>
      <!-- Site name for smallar screens -->
      <a href="./" class="navbar-brand hidden-lg">首页</a>
    </div>



    <!-- Navigation starts -->
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

      <!-- Links -->
      <ul class="nav navbar-nav pull-right" id="headbar" data-tmpl="headbar">

      </ul>
    </nav>

  </div>
</div>


<!-- Header starts -->
<header>
  <div class="container">
    <div class="row">

      <!-- Logo section -->
      <div class="col-md-4">
        <!-- Logo. -->
        <div class="logo">
          <h1><a href="/DocSystem">DocSys<span class="bold"></span></a></h1>
          <p class="meta">后台管理系统</p>
        </div>
        <!-- Logo ends -->
      </div>

      <!-- Data section -->

      <div class="col-md-5" style="float: right" id="metainfo">

      </div>

    </div>
  </div>
</header>

<!-- Header ends -->

<!-- Main content starts -->




<div class="content">
<div class="sidebar" id="sidebar" data-tmpl="sidebar">
</div>

<!-- Main bar -->
<div class="mainbar" >
    <!-- Page heading -->
    <div class="page-head" id="pagehead">
    </div>
    <!-- Page heading ends -->


  <!-- Matter -->
  <div class="matter">
    <div class="container" id="container">




    </div>
  </div>
  <!-- Matter ends -->

</div>

<!-- Mainbar ends -->
<div class="clearfix"></div>

</div>
<!-- Content ends -->

<!-- Footer starts -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <!-- Copyright info -->
        <p class="copy">Copyright &copy; 2017 | <a href="http://dw.gofreeteam.com/DocSystem">DocSys</a> </p>
      </div>
    </div>
  </div>
</footer>

<!-- Footer ends -->

<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="icon-chevron-up"></i></a></span>

<script type="application/javascript">
	//通用函数接口
	function showErrorMessage($msg) {
		qiao.bs.alert($msg);
	}
	
  function addToUrlParam(key,value,url){
    var ref = "";
    if( url ){
      ref = url;
    }
    else
    {
      ref = location.href;
    }
    if( ref.endsWith("#") ){
      ref = ref.substr(0,ref.length -1);
    }
    if( ref.indexOf("?") > 0 ){
      var p = getQuery(key);
      if( p ){
        var end = ref.replace(key + "=" + p,key + "=" + value);
        return end;
      }else{
        return ref + "&"+ key +"=" + value;
      }
    }else{
      return ref + "?" + key + "=" + value;
    }
  }

  $(document).on("changePage",function(e,msg){
    location.href = addToUrlParam("page",msg.page);
  });
    
</script>

<script type="application/javascript">
  var curPage = 1;
  
</script>


<script type="application/javascript">
	pageInit();
	
	//页面初始化
	var loginUser = "";	//用来保存刚注册的用户、或刚才登录的用户
	function pageInit()
	{
		console.log("pageInit");
		//确定当前登录用户是否已登录
		$.ajax({
	        url : "/DocSystem/getLoginUser.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	//Get用户信息
					var user = ret.data;
					loginUser = user;
					console.log("user",user);
					if(!user.type || user.type < 1)
					{
		        		showErrorMessage("非管理员用户，请联系系统管理员");
					}
					else
					{
						//显示用户信息
		                $Func.render($("#headbar"),"headbar",user);
						//显示菜单
		            	$Func.render($("#sidebar"),"sidebar");	//用户crrent参数来渲染sidebar.html文件
						//显示内容部分
		            	showContentPage("user");	           
					}
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	                window.location.href = "login.html";
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户信息失败");
	        }
	    });
	}

	//click event handler  for data-eb-event="content.refresh"
	$(document).on("click","[data-eb-event]", function () {
		console.log("data-eb-event click handler");
		
        var event = $(this).attr("data-eb-event");
        var params = $(this).attr("data-eb-params");
      	
        console.log("data-eb-event:"+ event + " " + params);
        
        //非回调方式更加容易被理解，so I give up the event bus 
        switch(event)
        {
        //菜单点击
        case "content.refresh":
        	showContentPage(params);
        	break;
        }
    });
	
	  //展开子项目
	  $(document).on("click",".has_sub",function(){
	      var title = $(this).children("a");
	      if( title.hasClass("subdrop") ){
	          title.removeClass("subdrop");
	          $(this).children("ul").hide();
	      }else{
	          title.addClass("subdrop");
	          $(this).children("ul").show();
	      }
	  });

	  //展开子目录
	  $(document).on("click","li.has_sublist",function(){
	      var $this = $(this);
	      if( ! $this.children("a").hasClass("open") ){
	          $this.children("ul.sublist").toggle();
	      }

	  });
	
	//显示对应菜单
	function showContentPage(curPath) {
	    console.log("showContentPage() " + curPath);
		var title = "载入中...";
	    var subtitle = "载入中...";
		
	    $("#container").html("载入中...");
	
	    $("#nav li>a").removeClass("open");
	    $("ul.sublist").hide();
	
	    switch ( curPath ){
	        case "user":
	            title = "用户管理";
	            showUserList();
	            $("#nav li[data-eb-params=ctrl]>a").addClass("open");
	            $("ul.sublist").show();
	            break;
	        case "group":
	            title = "用户组管理";
	            showGroupList();
	            $("#nav li[data-eb-params=ctrl]>a").addClass("open");
	            $("ul.sublist").show();
	            break;
	        case "suggest":
	            title = "意见建议";
	            $("#nav li[data-eb-params=suggest]>a").addClass("open");
	            bus.trigger("Suggest.refresh");
	            break;
	    }
	
	    $Func.render($("#pagehead"),"pagehead",{
	        title : title,
	        subtitle : title
	    });
	}



	//成员管理
	function showUserList(){
		
		$.ajax({
	        url : "/DocSystem/Manage/getUserList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	console.log("userList",ret.data);
	            	UserListDisplay(ret.data);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户列表失败");
	        }
	    });
	}
	
	function UserListDisplay(list)
    {
		$Func.render($("#container"),"user",{"list":list});
    }
	
	function delUserConfirm(id)
	{	
		console.log("delUserConfirm");
		qiao.bs.confirm({
	        title: "删除用户",
	        msg: "是否删除用户？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	delUser(id);
	    	return true;   
	    });
	}
	
	function delUser(id){
        $.ajax({
            url : "/DocSystem/Manage/delUser.do",
            type : "post",
            dataType : "json",
            data : {
                 userId : id,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showUserList();	//刷新UserList
                    alert("删除成功");
                }else {
                	alert("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	alert("服务器异常:删除失败");
            }
        });
	}
	
	//showAddUserPanel
	function showAddUserPanel(){
		console.log("showAddUserPanel");
		qiao.bs.dialog({
			url: 'addUser.html',
			title: '新增用户',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		});
	}

	function showEditUserPanel(e, id)
	{
		console.log("showEditUserPanel");
		
		console.log("showEditUserPanel() " + id);
		//console.log("this", this); //this is not correct, so i get the current item from event
		//alert($(this).attr("data-id"));
		//console.log("event", e);
		var Obj = e.target;
		var trObj =  $(e.target).parent().parent();
		var userId = trObj.children("td:eq(0)").text();
		var name = trObj.children("td:eq(1)").text();
		var type = trObj.children("td:eq(2)").text();
		var nickName = trObj.children("td:eq(3)").text();
		var realName = trObj.children("td:eq(4)").text();
		var tel = trObj.children("td:eq(5)").text();
		var email = trObj.children("td:eq(6)").text();
		
		
		qiao.bs.dialog({
			url: 'editUser.html',
			title: '编辑用户',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#userId").val(userId);
				$("#name").val(name);
			    $("#realName").val(realName);
			    $("#pwd").val(pwd);
			    $("#type").val(type);
			}
		}, null);	
	}
	
	function randomPassword(size)
	{
	  var seed = new Array('A','B','C','D','E','F','G','H','I','J','K','L','M','N','P','Q','R','S','T','U','V','W','X','Y','Z',
	  'a','b','c','d','e','f','g','h','i','j','k','m','n','p','Q','r','s','t','u','v','w','x','y','z',
	  '2','3','4','5','6','7','8','9'
	  );//数组
	  seedlength = seed.length;//数组长度
	  var createPassword = '';
	  for (i=0;i<size;i++) {
	    j = Math.floor(Math.random()*seedlength);
	    createPassword += seed[j];
	  }
	  return createPassword;
	}
	
	function showResetPwdPanel(e, id)
	{
		console.log("showResetPwdPanel");
		
		console.log("showResetPwdPanel() " + id);
		var Obj = e.target;
		var trObj =  $(e.target).parent().parent();
		var userId = trObj.children("td:eq(0)").text();
		var name = trObj.children("td:eq(1)").text();
		var pwd = randomPassword(8);
		
		qiao.bs.dialog({
			url: 'resetPwd.html',
			title: '重置密码',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#userId").val(userId);
				$("#name").val(name);
			    $("#pwd").val(pwd);
			}
		}, null);	
	}
	
	//角色管理
	function showGroupList(){
		$.ajax({
	        url : "/DocSystem/Manage/getGroupList.do",
	        type : "post",
	        dataType : "json",
	        data : {},
	        success : function (ret) {
	            if( "ok" == ret.status )
	            {
	            	GroupListDisplay(ret.data);
	            }
	            else 
	            {
	                console.log(ret.msgInfo);
	            }
	        },
	        error : function () {
	        	showErrorMessage("服务器异常:获取用户列表失败");
	        }
	    });
	}

	function GroupListDisplay(list)
	{
		console.log("GroupListDisplay", list);
		$Func.render($("#container"),"group",{"list":list});
	}
		
	
	//showAddGroupPanel
	function showAddGroupPanel(){
		console.log("showAddGroupPanel");
		qiao.bs.dialog({
			url: 'addGroup.html',
			title: '新增用户组',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false
		}, null);
	}
	
	function delGroupConfirm(id)
	{	
		console.log("delGroupConfirm");
		qiao.bs.confirm({
	        title: "删除用户组",
	        msg: "是否删除用户组？",
	        okbtn: "删除",
	        qubtn: "取消",
	    },function () {
	    	delGroup(id);
	    	return true;   
	    });
	}
	
	function delGroup(id){
        $.ajax({
            url : "/DocSystem/Manage/delGroup.do",
            type : "post",
            dataType : "json",
            data : {
                 id : id,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                   	showGroupList();	//刷新GroupList
                    alert("删除成功");
                }else {
                	alert("错误：" + ret.msgInfo);
                }
            },
            error : function () {
            	alert("服务器异常:删除失败");
            }
        });
	}
	
	function showEditGroupPanel(e, id)
	{
		console.log("showEditGroupPanel() " + id);
		var Obj = e.target;
		var trObj =  $(e.target).parent().parent();
		var groupId = trObj.children("td:eq(0)").text();
		var name = trObj.children("td:eq(1)").text();
		var info = trObj.children("td:eq(2)").text();		
		
		qiao.bs.dialog({
			url: 'editGroup.html',
			title: '编辑用户组',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: false,
			callback: function(){
			    console.log("page loaded callback");
			    //Page Value Init
			    $("#groupId").val(groupId);
				$("#name").val(name);
			    $("#info").val(info);
			}
		}, null);	
	}
	
	//显示组成员管理页面
	function showManageGroupMemberPanel(e,groupId){
		console.log("showManageGroupMemberPanel groupId:" + groupId);
		
		//get current click the Group Info
		var Obj = e.target;
		console.log(Obj);
		var trObj =  $(e.target).parent().parent();
		//var groupId = trObj.children("td:eq(0)").text();
		var groupName = trObj.children("td:eq(1)").text();
		
		qiao.bs.dialog({
			title: '成员管理 -'+ groupName,
			url: 'manageGroupMember.html',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: true,
			callback: function(){
				manageGroupMemberPageInit(groupId);
			},
		});
	}
	
	// 快速查找指定的项
	function fastSearch(_this){
	    var $this = $(_this);
	    var event = $this.attr("data-eb-xevent");
	    var event2 = $("#examine").attr("data-eb-xparam");
	    var value = $this.val();
	    var type = $this.attr("data-type");
	
	    $Current.ajax(event,{name:value,type:type},function(ret){
	        console.log(ret);
	        ret.data.page.curExamine = "0";
	        bus.trigger(event2,ret.data.page);
	    });
	}

	function exit(){
		console.log("logout");
        $.ajax({
            url : "/DocSystem/logout.do",
            type : "post",
            dataType : "json",
            data : {},
            success : function (ret) {
                if( "ok" == ret.status ){
                	console.log("已退出登录");
                	window.location.href = "login.html";
                }else {
                    alert("错误："+ret.msgInfo);
                }
            },
            error : function () {
                alert("服务器异常:退出登录失败");
            }
        });
	}

</script>
</body>
</html>