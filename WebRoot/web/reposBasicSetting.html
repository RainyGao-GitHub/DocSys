<!-- Share Modal -->
<div id="reposBasicSetting">
        <div class="form-group">
            <label>名字</label>
            <input class="form-control" type="text" id="RBSname" value="" style="width: 100%"></input>
            <label>介绍</label>
            <input class="form-control" type="text" id="RBSinfo" value="" style="width: 100%"></input>
            <label>仓库类型</label>
            <select class="form-control" id="RBStype" onchange="doSelectFS();" style="width: 100%" disabled="disabled">   
            	<option value="0">虚拟文件系统</option>   
            	<option value="1"">实文件系统</option>   
            </select>
            <label>仓库位置</label>
            <input class="form-control" type="text" id="RBSpath"  value="" style="width: 100%"></input>
            <label>版本管理</label>
            <select class="form-control" id="RBSverCtrl" onchange="doSelectVerCtrl();" style="width: 100%">   
            	<option value="0">无</option>   
            	<option value="1">SVN</option>   
            	<option value="2">GIT</option>   
            </select>
            <label>svn路径</label>
            <input class="form-control" type="text" id="RBSsvnPath"  placeholder="如需系统新建版本仓库，请留空！" value="" style="width: 100%" disabled="disabled"></input>
            <label>svn用户名</label>
            <input class="form-control" type="text" id="RBSsvnUser"   placeholder="置空表明版本仓库可以由任意用户访问！" value="" style="width: 100%" disabled="disabled"></input>
            <label>svn密码</label>
            <input class="form-control" type="password" id="RBSsvnPwd" placeholder="置空表明版本仓库访问不需要密码！" value="" style="width: 100%" disabled="disabled"></input>          
        </div>
        <a href='javascript:void(0)' onclick="saveReposBasicSetting();" class='mybtn-primary'>保存</a>
</div>

<script type="text/javascript">
	function reposBasicSettingPageInit()
	{
	    console.log("reposBasicSettingPageInit");
		getReposBasicSetting();
	}
        
    //页面初始化代码    
    $(function(){
		reposBasicSettingPageInit();
	});

	//文件系统类型改变时需要根据文件系统类型，显示或者不显示svnPath等input
	function doSelectVerCtrl()
	{
		var verCtrl = $("#RBSverCtrl").val();
		//alert(verCtrl);
		if((verCtrl == 1) || (verCtrl == 2)) 			//show svn info
		{
			$("#RBSsvnPath").attr("disabled",false);
			$("#RBSsvnUser").attr("disabled",false);
			$("#RBSsvnPwd").attr("disabled",false);
		}
		else	//hide svn info
		{
			$("#RBSsvnPath").attr("disabled",true);
			$("#RBSsvnUser").attr("disabled",true);
			$("#RBSsvnPwd").attr("disabled",true);
		}   
	}
	
//显示仓库公开访问权限设置
var gReposBasicSetting = [];
function getReposBasicSetting()
{
	console.log("getReposBasicSetting");
	var vid = getQueryString("vid");
    $.ajax({
           url : "/DocSystem/Repos/getRepos.do",
           type : "post",
           dataType : "json",
           data : {
               vid : vid,
           },
           success : function (ret) {
               if( "ok" == ret.status ){
               		gReposBasicSetting = ret.data;
               		console.log(gReposBasicSetting);
               		showReposBasicSetting(ret.data);
               		doSelectVerCtrl();
               }else {
					showErrorMessage(ret.msgInfo);
               }
           },
           error : function () {
               showErrorMessage("服务器异常:获取仓库信息失败");
           }
    });
    
	function showReposBasicSetting(reposInfo)
	{
		console.log(reposInfo);
	   	$("#RBSname").val(reposInfo.name);
	   	$("#RBSinfo").val(reposInfo.info);
	   	$("#RBStype option[value='"+reposInfo.type+"']").attr("selected","selected");
	   	$("#RBSpath").val(reposInfo.path);
	   	$("#RBSverCtrl option[value='"+reposInfo.verCtrl+"']").attr("selected","selected");
	   	$("#RBSsvnPath").val(reposInfo.svnPath);
	   	$("#RBSsvnUser").val(reposInfo.svnUser);
	   	$("#RBSsvnPwd").val(reposInfo.svnPwd);
	}
}

function saveReposBasicSetting()
{
	console.log("saveReposBasicSetting");
	var newReposSetting = [];
	newReposSetting.vid = getQueryString("vid");
	newReposSetting.name = $("#RBSname").val();
	newReposSetting.info = $("#RBSinfo").val();
	newReposSetting.type = $("#RBStype").val();
	newReposSetting.path = $("#RBSpath").val();
	newReposSetting.verCtrl = $("#RBSverCtrl").val();
	newReposSetting.svnPath = $("#RBSsvnPath").val();
	newReposSetting.svnUser = $("#RBSsvnUser").val();
	newReposSetting.svnPwd = $("#RBSsvnPwd").val();
	console.log(newReposSetting);
	
	if(verifyReposSetting(gReposBasicSetting,newReposSetting) == true)
	{
   		$.ajax({
                url : "/DocSystem/Repos/updateReposInfo.do",
                type : "post",
                dataType : "json",
                data : {
                	reposId : newReposSetting.vid,
                    name : newReposSetting.name,
                    info : newReposSetting.info,
                    type : newReposSetting.type,
                    path : newReposSetting.path,
                    verCtrl: newReposSetting.verCtrl,
                    svnPath : newReposSetting.svnPath,
                    svnUser : newReposSetting.svnUser,
                    svnPwd : newReposSetting.svnPwd,
                },
                success : function (ret) {
                	if(ret.status == "ok")
                	{
                		console.log("更新仓库设置成功");
                		getReposBasicSetting();     
                		// 普通消息提示条
						bootstrapQ.msg({
						msg : '设置完成！',
						type : 'success',
						time : 2000,
					    });
	                }
                    else
                    {
                    	alert(ret.msgInfo);
                    }
                },
                error : function () {
                    alert('服务器异常: 设置失败');
                }
            });
            return true;
       }
       else
       {
            return false;
       }    
       
       function verifyReposSetting(oldSetting, newSetting)
       {
       		if(oldSetting.name != newSetting.name)
       		{
       			//alert("仓库名字不能修改");
       			return true;
       		}
       		
       		if(oldSetting.type != newSetting.type)
       		{
       			alert("仓库类型不能修改");
       			return false;
       		}
       		
       		if(oldSetting.path != newSetting.path)
       		{
       			return true;
       		}
       		if(oldSetting.info != newSetting.info)
       		{
       			return true;
       		}
       		if(oldSetting.verCtrl != newSetting.verCtrl)
       		{
       			return true;
       		}
       		if(oldSetting.svnPath != newSetting.svnPath)
       		{
       			return true;
       		}
       		if(oldSetting.svnUser != newSetting.svnUser)
       		{
       			return true;
       		}
       		if(oldSetting.svnPwd != newSetting.svnPwd)
       		{
       			return true;
       		}
       		alert("仓库信息未变化！");
       		return false;
       }  
}

</script>
