
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="author" content="Rainy" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit" />
    <link rel="shortcut icon"  href="static/SmartWiki/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>仓库详情-DocSys</title>
    <!-- BootStarp CSS -->
    <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="static/highlight/styles/default.css" rel="stylesheet">
    <link href="static/highlight/styles/zenburn.css" rel="stylesheet">
    <link href="static/fonts/font.css" rel="stylesheet">
    <link href="static/zTree/css/metroStyle/metroStyle.css" rel="stylesheet">
    <link href="static/nprogress/nprogress.css" rel="stylesheet">
    <link href="static/styles/kancloud.css" rel="stylesheet">
    <!-- bootStrapQ -->
	<link href="static/bootstrapQ/qiao.css" rel="stylesheet">
    <!-- editormd -->
	<link href="static/markdown/css/editormd.min.css" rel="stylesheet">
	<link href="static/markdown/css/add.css" rel="stylesheet">
	<!-- contextMenu -->
	<link rel="stylesheet" type="text/css" href="static/ContextJS/css/demo.css">
	<link rel="stylesheet" type="text/css" href="static/ContextJS/css/context.standalone.css">
	<link rel="stylesheet" type="text/css" href="css/zjp-css.css">
	<!-- FreeTeam CSS-->
	<link rel="stylesheet" href="static/freeTeam/css/resetV2.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="static/freeTeam/css/boot-css/bootstrap.custom.css" type="text/css" media="screen" /> 
	<link rel="stylesheet" type="text/css" href="css/style.css">
 	
     <style type="text/css">
        .editormd-preview{
            left: 0 !important;
            right: auto !important;
        }

        .editormd .CodeMirror {
            float: right !important;
        }

        .editor-content table thead tr {
            color: #111111 !important;
        }
        .manual-mask{
	        position: absolute;
		    left: 0;
		    right: 0;
		    background: #fafafa;
		    top: 0;
		    bottom: 0;
		    z-index: 19;
		    opacity: 0.5;
		    display:none;
        }
        .closeBtn{
        	position:absolute;
        	top:20px;
        	right:15px;
        	font-size:13px;
        	cursor: pointer;
        }
        
        .uploadFileName{
        	cursor: text;
        }
        .reuploadAllBtn{
        	position:absolute;
        	top:15px;
        	right:50px;
        	font-size:13px;
        	cursor: pointer;
        }
        
        .reuploadBtn{
        	position:absolute;
        	top:0px;
        	right:50px;
        	font-size:13px;
        	cursor: pointer;
        }
        
        .icon_add{
            background: url(images/sprite-4ce3c9eaa2.svg) no-repeat;
    		background-position: 74.78510028653295% 0;
    		width: 28px;
    		height: 28px;
    	}
    </style>

    <style>
        /* 强制不换行 */
        .nowrap{white-space:nowrap;}
        /* 允许单词内断句，首先会尝试挪到下一行，看看下一行的宽度够不够，
        不够的话就进行单词内的断句 */
        .breakword{word-wrap: break-word;}
        /* 断句时，不会把长单词挪到下一行，而是直接进行单词内的断句 */
        .breakAll{word-break:break-all;}            
        /* 超出部分显示省略号 */
        .ellipsis{text-overflow:ellipsis;overflow:hidden;}
    </style>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="static/bootstrap/js/html5shiv.min.js"></script>
    <script src="static/bootstrap/js/respond.min.js"></script>
    <![endif]-->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="static/scripts/jquery.min.js" type="text/javascript"></script>
    <script src="static/markdown/editormd.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/link-dialog/link-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/reference-link-dialog/reference-link-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/image-dialog/image-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/code-block-dialog/code-block-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/table-dialog/table-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/emoji-dialog/emoji-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/goto-line-dialog/goto-line-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/help-dialog/help-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/html-entities-dialog/html-entities-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/preformatted-text-dialog/preformatted-text-dialog.js" type="text/javascript"></script>
</head>
<body>
<div class="m-manual manual-reader">

    <header class="navbar navbar-static-top manual-head" role="banner">
        <div class="container-fluid">
            <div class="navbar-header pull-left manual-title">
  				<a class="navbar-brand" href="/DocSystem/web/projects.html"><i class="fa fa-paper-plane"></i> DocSys</a>
                <span class="slidebar" id="slidebar">
                    <i class="fa fa-align-justify"></i>
                </span>
                <a  id="projectName" class="navbar-brand" href="#">仓库名</a>
                <span style="font-size: 12px;font-weight: 100;" class="projectVersion"></span>
            </div>

            <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                <ul class="nav navbar-nav navbar-right">
				    <li id="userImgDiv" style="display:none"><img id="userImg" name="userImg" width="40px" height="40px" src="images/default/defaultHeadPic.png" onerror="UserImgErrHandler();" class="img-circle m5"/></li>
					<li id="userInfoDiv" style="display:none">
							<a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span>Rainy</span><span class="caret"></span></a>
							<ul class="dropdown-menu" role="menu">
								<li><a href="/DocSystem/web/myHostPage.html">个人中心</a></li>
								<li><a href="/DocSystem/web/reposManager.html">仓库管理</a></li>
								<li><a onclick="logout()">退出登录</a></li>
							</ul>
					</li>
					<li id="loginBtn">
                        <a onclick="showLoginPanel()"  title="用户登录">登录</a>
                    </li>
                </ul>
            </nav>
        </div>      
    </header>
    <article class="container-fluid manual-body">
        <div class="manual-left">
            <div class="manual-tab">
	            <div class="tab-navg" style="height:59px">
	         		<div style="padding:20px 0;position: relative; cursor: pointer; margin: 0 auto; width: 100px; display: block;">
	         			<a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
	         				<i class="glyphicon glyphicon-plus" style="zoom:1.2"></i>
	         				<span>新文档</span>
	         				<span class="caret"></span>
	         			</a>
						<ul class="dropdown-menu" role="menu">
							<li><a onclick="newDocEx(1)">新建文件</a></li>
							<li><a onclick="newDocEx(2)">新建文件夹</a></li>
							
							<li><a onclick="uploadFilesEx();">上传文件</a></li>
							<li><a onclick="uploadDirEx()">上传文件夹</a></li>
						</ul>
	         		</div>
	         	</div>
                <div id="treeBody" class="tab-wrap">
                    <div class="tab-item manual-catalog" id="uuz">

                        <div class="catalog-list read-book-preview" id="tree">
                            <ul id="doctree" class="ztree"></ul>
                        </div>

                    </div>
                </div>
                <div  class="uploadBox ">
		            <ul style="display:none" class="el-upload-list el-upload-list--text">
					</ul>
				</div>
            </div>

			<!-- 
            <div id="container" class="m-copyright">
                <p id="editTime">2017.7.7</p>   
            </div>
             -->
        </div>
        <div id="line" class="manual-line" ></div>
        <div class="second-table"  id="secondDropZone">
         	<div class="searchBox">
         		<div class="back" onclick="backToParentDoc();"> 
         			<i class="backicon glyphicon glyphicon-arrow-left"></i>
         		</div>
         		<div class="content">
         			<i class="glyphicon glyphicon-search icon" onclick="searchDoc();"></i>
         			<input placeholder="搜索..." type="text" id="searchWord"/>
         		</div>
         		<div class="dropdown">
         			<a class="selecticon glyphicon glyphicon-align-justify dropdown-toggle" data-toggle="dropdown" aria-expanded="false"></a>
         			<ul class="dropdown-menu" style="left:210px">
 		                    <li><a href="#">摘要</a>
 		                    </li>
 		                    <li><a  href="#">列表</a>
 		                    </li>
 		                    <li><a  href="#">创建时间</a>
 		                    </li>
 		                    <li><a  href="#">修改时间</a>
 		                    </li>
 		                    <li><a  href="#">文件名称</a>
 		                    </li>
 		                    <li><a  href="#">文件大小</a>
 		                    </li>
 		                </ul>
         		</div>
         	</div>
         	<div class="second-list">
         		<ul id="secondList">
         		</ul>
         	</div>
         </div>
        <div id="second-line" class="second-line" ></div>
        
        <div class="manual-right">
            <div class="searchBox" style="white-space:nowrap">
         		<div class="back" onclick="showCenterDiv();"> 
         			<i class="backicon glyphicon glyphicon-arrow-left"></i>
         		</div>
        		<div class="filetitle" id="filetitle"></div>
        		<div style="position:absolute; right:5px; top:10px">
        				<!-- <button id="btnViewDoc" class="btn btn-default" type="button" onclick="previewDoc()" style="display:none">预览
	                    </button> -->
	                    <button id="btnExitEdit" class="btn btn-default" type="button" onclick="exitEdit()" style="display:none">退出编辑
	                   	</button>
	                    <button id="btnEditWiki" class="btn btn-default" type="button" onclick="lockAndEditWiki()" style="display:none">编辑
	                    </button>
	                    <button id="btnSaveWiki" class="btn btn-default" type="button" onclick="saveWiki()" style="display:none">保存
	                    </button>
        		</div>
         	</div>
            <div class="manual-article">
                <div class="article-body editor-content"  id="doc" style="min-height: 650px">
                </div>
            </div>
        </div>
        <div class="manual-progress"><b class="progress-bar"></b></div>
    </article>
    <div class="manual-mask"></div>
</div>

<!-- 全屏遮罩 -->
<div id="statusDiv" style="display:none">
	<p>文件上传中...</p>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareProject" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">项目分享</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="col-sm-2 control-label">项目地址</label>
                    <div class="col-sm-10">
                        <input type="text" value="https://gpio.me/" class="form-control" onmouseover="this.select()" id="projectUrl" title="项目地址">
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div id="new-doc" style="display:none">
    <form class="form" onkeydown="if(event.keyCode==13)return false;">
		<div class="modal-body">
		   <div class="form-group">
		       <label class="col-sm-2 control-label">名字</label>
		       <div class="col-sm-10">
	 	           <input class="form-control" type="text" name="name" style="width: 100%"/>
		       </div>
		       <div class="clearfix"></div>
		   </div>
		   <div class="form-group">
		       <label class="col-sm-2 control-label">描述</label>
		       <div class="col-sm-10">
	 	           <input class="form-control" type="text" name="content" style="width: 100%"/>
		       </div>
		       <div class="clearfix"></div>
		   </div>
		</div>
   	  	<div class="modal-footer">
	    	<div class="form-group">
	            <label class="col-sm-2 control-label">当前目录</label>
	            <div class="col-sm-10">
	                <input type="text" value="" class="form-control" name="remoteDir" title="目标地址">
	            </div>
	            <div class="clearfix"></div>
	        </div>
	    </div>
    </form>
</div>

<div id="doc-detail" style="display:none">
	<div class="modal-body">
	   <div class="form-group">
	       <label class="col-sm-2 control-label">文件名</label>
	       <div class="col-sm-10">
 	           <input class="form-control" type="text" name="name" style="width: 100%"/>
	       </div>
	       <div class="clearfix"></div>
	   </div>
	   <div class="form-group">
	       <label class="col-sm-2 control-label">大小</label>
	       <div class="col-sm-10">
 	           <input class="form-control" type="text" name="size" style="width: 100%"/>
	       </div>
	       <div class="clearfix"></div>
	   </div>
	   <div class="form-group">
	       <label class="col-sm-2 control-label">位置</label>
	       <div class="col-sm-10">
 	           <input class="form-control" type="text" name="position" style="width: 100%"/>
	       </div>
	       <div class="clearfix"></div>
	   </div>
	   <div class="form-group">
	       <label class="col-sm-2 control-label">创建时间</label>
	       <div class="col-sm-10">
 	           <input class="form-control" type="text" name="createTime" style="width: 100%"/>
	       </div>
	       <div class="clearfix"></div>
	   </div>
	   <div class="form-group">
	       <label class="col-sm-2 control-label">修改时间</label>
	       <div class="col-sm-10">
 	           <input class="form-control" type="text" name="latestEditTime" style="width: 100%"/>
	       </div>
	       <div class="clearfix"></div>
	   </div>
	</div>
</div>

<div id="copyConflictConfirmDialog" style="display:none">
    <form class="form" onkeydown="if(event.keyCode==13)return false;">
        <div class="form-group">
            <label>请输入新的文件名/目录名</label>
            <input class="form-control" type="text" name="newDocName" style="width: 100%"/>
        </div>
    </form>
</div>

<div id="uploadConfirmDialog" style="display:none">
    <div class="modal-body">
        <div class="form-group">
            <label class="col-sm-2 control-label">文件：</label>
            <div class="col-sm-10">
                <input type="text" value="" class="form-control" name="uploadContent" title="上传文件">
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
  	<div class="modal-footer">
    	<div class="form-group">
            <label class="col-sm-2 control-label">上传至：</label>
            <div class="col-sm-10">
                <input type="text" value="" class="form-control" name="remoteDir" title="目标地址">
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<div id="fileCoverConfirmDialog" style="display:none">
    <div class="modal-body">
        <div class="form-group">
            <label class="col-sm-2 control-label">文件：</label>
            <div class="col-sm-10">
                <input type="text" value="" class="form-control" name="uploadContent" title="上传文件">
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<div id="renameConfirmDialog" style="display:none">
    <div class="modal-body">
        <div class="form-group">
            <label class="col-sm-2 control-label">文件名：</label>
            <div class="col-sm-10">
                <input type="text" value="" class="form-control" name="docName" title="rename">
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<!-- multiple file and dir upload triger div -->
<div style="display:none">
	<input id="checkInFile" name="checkInFile" type="file" onchange="checkInUploadConfirm(event)"/>
	<input id="uploadFiles" name="uploadFiles" type="file" onchange="selectUploadConfirm(event)" multiple="multiple"/>
	<input id="uploadDir" type="file" onchange="selectUploadConfirm(event)" webkitdirectory>
</div>
<div style="width:0;height:0;">
	<textarea id="copiedText"></textarea>
</div>	
<!-- single file upload form -->
<div style="display:none">
	<form id="FileUploadForm" action="/DocSystem/Doc/uploadDoc.do" method="post" enctype="multipart/form-data">  
		<input id="uploadFile" name="uploadFile" type="file" class="fLeft" style="margin-top: 90px;" multiple="multiple"/>
		<input type="text" value="0" id="reposId" name="reposId" title="所在仓库"/>
		<input type="text" value="0" id="parentId" name="parentId" title="父节点"/>	
		<input type="text" value="-1" id="docId" name="docId" title="文件节点"/>
		<input type="text" value="1" id="uploadType" name="uploadType" title="上传类型：1文件 2文件夹"/>
	</form>
</div>
           
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script type="text/javascript" src="static/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="static/layer/layer.js"></script>
<script type="text/javascript" src="static/nprogress/nprogress.js"></script>
<script type="text/javascript" src="static/highlight/highlight.js"></script>
<script type="text/javascript" src="static/highlight/highlightjs-line-numbers.min.js"></script>
<script type="text/javascript" src="static/bootstrapQ/qiao.js"></script>
<script type="text/javascript" src="js/logon.js"></script>
<script type="application/javascript" src="static/markdown/lib/raphael.min.js"></script>
<script type="application/javascript" src="static/scripts/jsonEscape.js"></script>
<!-- zTree -->
<script type="text/javascript" src="static/zTree/js/jquery.ztree.all.min.js"></script>
<!-- For ajax form submit -->
<script  type="text/javascript" src="static/scripts/jquery.form.js"></script>
<!-- context.js -->
<script type="text/javascript" src="static/ContextJS/js/context.js"></script>

<!-- DocSys Utils class -->
<script type="text/javascript" src="js/fileReader.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="static/js-spark-md5/spark-md5.min.js"></script>

<!-- DocSys class -->
<script type="text/javascript" src="js/DocUpload.js"></script>
<script type="text/javascript" src="js/DocDelete.js"></script>
<script type="text/javascript" src="js/DocCopy.js"></script>
<script type="text/javascript" src="js/DocMove.js"></script>
<script type="text/javascript" src="js/DocEdit.js"></script>
<script type="text/javascript" src="js/DocHistory.js"></script>

<script type="text/javascript">
	//初始化全局变量 //Repos Info
	var gReposId;
	var gReposInfo = [];
	var gReposType = 0;	//0: Unknown Type
	var gReposName = "";
	var gReposCreateTime = "";
	//Doc Info
	var gDocId;
	var gParentPath;
	var gDocName;
	var gDocContent;
	var gEdit; 
	
	//通用函数接口
	function showErrorMessage($msg) {
    	qiao.bs.alert($msg);
	}
	
	function closeBootstrapDialog(id){ 
		$("#"+id + "div").remove();	//删除全屏遮罩
		$("#"+id).remove();	//删除对话框
	}

	function getDeleteNodes()
	{
		var deleteNodes = [];
		
		var treeObj = $.fn.zTree.getZTreeObj("doctree");
		var selectedNodes = treeObj.getSelectedNodes();
		if(selectedNodes == null || selectedNodes.length < 2)
		{
			console.log("selectedNodes",selectedNodes);
			if(curRightClickedTreeNode != null)
			{
				deleteNodes.push(curRightClickedTreeNode);
			}
		}
		else
		{
			deleteNodes = selectedNodes;
		}
		
		return deleteNodes;
	}
	
	//callback is for success delete
	function DoDelete(treeNodes,callback)
	{
		if(treeNodes == null || treeNodes.length < 1)
		{
			bootstrapQ.alert("清选择需要删除的文件或目录");
		}
		else
		{
			var treeNode = treeNodes[0];
			var msg =  "是否删除文件 " + treeNode.name;
			if(treeNodes.length > 1)
		  	{
				msg =  "是否删除 " + treeNode.name + "等" + treeNodes.length  +"文件";	
		  	}
			else
			{
				if(treeNode.type == 2)
				{
					msg =  "是否删除整个目录 " + treeNode.name;	
				}
			}
			
			bootstrapQ.confirm({
				id: "deleteConfirm",
				title: "删除确认",
				msg : msg,
				},function () {
			    	//alert("点击了确定");
					DocDelete.deleteDocs(treeNodes,callback);
			    	return true;   
			 	});
		}
	}

	function showRenameDialog(node)
	{
		var docId = node.id;
		var parentPath = node.path;
		var docName = node.name;
		console.log("showRenameDialog docId:" + docId + " parentPath:" + parentPath + " docName:" + docName);
		
		//Show dialog
	    qiao.bs.dialog({
	        id: "dialog-renameDialog",
	        url: '#renameConfirmDialog',
	        title: '重命名',
	        okbtn: "确定",
	        callback: function () {
	            setTimeout(function () {
	                $("#dialog-renameDialog input[name='docName']").val(docName);	                 
	            },100);
	        }
	    },function () {
			var newName = $("#dialog-renameDialog input[name='docName']").val();
			doRenameDoc(docId,parentPath, docName,newName);
	    	return true;   
	    });
		return true;
	}
		
	function doRenameDoc(docId, pid, parentPath, docName, newName)
	{
		$.ajax({
            url : "/DocSystem/Doc/renameDoc.do",
            type : "post",
            dataType : "json",
            data : {
            	reposId: gReposId,
                docId : docId,
                pid	: pid,
                path: parentPath,
                name: docName,
                newName: newName,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                    //Rename NodeName in docList
                    var newDocId = ret.data.id;
			     	DocList.renameNode(docId, newDocId, newName);
		            
                    //Rename doc
                    renameTreeNode(docId, newDocId, newName);
                    
		            bootstrapQ.msg({
							msg : "重命名完成！",
							type : 'success',
							time : 2000,
					});
                }
                else
                {
                	showErrorMessage("重命名失败:" + ret.msgInfo);
                }
            },
            error : function () {
	               showErrorMessage("重命名失败:服务器异常！");
            }
    	});
	}
	
	function renameTreeNode(id, newDocId, newName)
	{
		var zTree = $.fn.zTree.getZTreeObj("doctree");
		var node = zTree.getNodeByParam("id",id);
		if(node && node != null)
		{
			node.name = newName;
			node.id = newDocId;
		}
		zTree.updateNode(node);
		
		if(node.isParent == true && parentNode.open == true) //刷新目录
		{
			//强制异步刷新子目录，以保证子目录的信息正确
			zTree.reAsyncChildNodes(node, "refresh",true);	
		}
	}
	

	function getCopiedNodes()
	{
		var treeNodes = [];
		
		var treeObj = $.fn.zTree.getZTreeObj("doctree");
		var selectedNodes = treeObj.getSelectedNodes();
		if(selectedNodes == null || selectedNodes.length < 2)
		{
			console.log("selectedNodes",selectedNodes);
			if(curRightClickedTreeNode != null)
			{
				treeNodes.push(curRightClickedTreeNode);
			}
		}
		else
		{
			treeNodes = selectedNodes;
		}
		
		return treeNodes;
	}

	function DoPaste(treeNodes,dstParentNode)
	{
		console.log("DoPaste()",treeNodes,dstParentNode);
		if(treeNodes == null || treeNodes.length < 1)
		{
			console.log("DoPaste nothing was copied");
			return;	
		}
		
		console.log("StartCopy");
		DocCopy.copyDocs(treeNodes,dstParentNode,gReposId);
	}

	function copyDocName(node){
		
		var id = 0;
		if(node == null)
		{
			bootstrapQ.alert("请选择文件或目录");
			return false;
		}
		id = node.id;
		var docName = node.name;
		console.log("copiedDocName:" + docName);
		//window.clipboardData.setData("Text",url);	//剪贴板存在兼容性问题
		var obj=document.getElementById("copiedText");
		obj.value=docName;	//修改其中的值
		obj.select(); // 选择对象
		document.execCommand("Copy"); // 执行浏览器复制命令
        // 普通消息提示条
		bootstrapQ.msg({
					msg : '复制成功！',
					type : 'success',
					time : 1000,
		});
	}
	
	function copyDocPath(node){
		var id = 0;
		if(node == null)
		{
			bootstrapQ.alert("请选择文件或目录");
			return false;
		}
		id = node.id;
		var docPath = getNodePath(node);
		console.log("docPath:" + docPath);
		
		//window.clipboardData.setData("Text",url);	//剪贴板存在兼容性问题
		var obj=document.getElementById("copiedText");
		obj.value=docPath;	//修改其中的值
		obj.select(); // 选择对象
		document.execCommand("Copy"); // 执行浏览器复制命令
        // 普通消息提示条
		bootstrapQ.msg({
					msg : '复制成功！',
					type : 'success',
					time : 1000,
		});
	}
	
	function copyUrl(node){
		var id = 0;
		if(node == null)
		{
			bootstrapQ.alert("请选择文件或目录");
			return false;
		}
		id = node.id;
		var vid = gReposId;
		var href = "/DocSystem/web/project.html?vid="+vid+"&doc="+id;
		console.log(href);
		var host = window.location.host;	//域名带端口
		//var host2=document.domain; 			//域名不带端口
		//var url = window.location.href;		//全路径
		console.log(host);
		//console.log(host2);
		//console.log(url);
		var url = host+href;
		console.log(url);
		
		//window.clipboardData.setData("Text",url);	//剪贴板存在兼容性问题
		var obj=document.getElementById("copiedText");
		obj.value=url;	//修改其中的值
		obj.select(); // 选择对象
		document.execCommand("Copy"); // 执行浏览器复制命令
        // 普通消息提示条
		bootstrapQ.msg({
					msg : '复制成功！',
					type : 'success',
					time : 1000,
		});
	}
	
	//文件下载接口
 	function downloadDoc(node,needConfirm)
	{
		console.log("downloadDoc node:", node);
		if(!node || node == null)
		{
			showErrorMessage("文件不存在！");
			return;
		}
		
		var reposId = node.vid;
		var docId = node.id;
		var pid = node.pid;
	   	var path = node.path;
	   	var name = node.name;
	   	
		if(needConfirm)
		{
			if(confirm("是否下载文件：" + name) == false)
			{
				return;
			}
		}
		
	   	var encPath = encodeURI(path);
	   	var encName = encodeURI(name);

	   	window.location.href = "/DocSystem/Doc/downloadDoc.do?reposId=" + reposId + "&docId=" + docId + "&pid=" + pid + "&path=" + encPath + "&name="+ encName;	

	}
	
    /*文件上传实现*/
   	function uploadFilesEx()
    {
    	var node = getNodeByNodeId(gDocId);
		gParentNodeForUpload = getParentNodeByNode(node);
	    uploadFiles();
    }
    
   	function uploadDirEx()
    {
    	var node = getNodeByNodeId(gDocId);
		gParentNodeForUpload = getParentNodeByNode(node);
	    uploadDir();
    }
    
	//文件上传入口
	function uploadFiles(){
		console.log("uploadFiles() gParentNodeForUpload:",gParentNodeForUpload);
  		//清除文件控件
		$("#uploadFiles").val("");

  		$("#uploadType").val(1); //文件	
	    return $("#uploadFiles").click();
	}
	
	//文件夹上传入口
	function uploadDir(){
		console.log("uploadDir() gParentNodeForUpload:",gParentNodeForUpload);
  		//清除文件控件
		$("#uploadDir").val("");
  		
		$("#uploadType").val(2);
	    return $("#uploadDir").click();
	}
	
	//文件chekcIn入口
	function checkInFile(){
		console.log("checkInFile() gParentNodeForUpload:",gParentNodeForUpload);
  		//清除文件控件
  		$("#checkInFile").val("");

  		return $("#checkInFile").click();
	}
	
	
	//get the filename 
	function getFileName(o){
	    var pos=o.lastIndexOf("\\");
	    return o.substring(pos+1);  
	}
	
	//upload file confirm dialog
	function selectUploadConfirm(e)
	{
		console.log("selectUploadConfirm",e,gParentNodeForUpload);
	    var entrys = e.target.files;
	    
		checkUserUploadRight(entrys,gParentNodeForUpload,uploadConfirm);		
	    return true;
	}
	
	function dragUploadConfirm(e,parentNode)
	{
		console.log("dragUploadConfirm",e);
        
		//getFileList
        var entrys = getFileList(e);
        //console.log("entrys",entrys);
        		
		//用户确认上传
		checkUserUploadRight(entrys,parentNode,uploadConfirm);
	    return true;
	}
	
	//CheckInUpload Confirm
	function checkInUploadConfirm(e)
	{
		console.log("checkInUploadConfirm",e,gParentNodeForUpload);
	    var entrys = e.target.files;
	    var fileName = entrys[0].name;
	    if(fileName != curCheckInDoc.name)
	    {
	    	bootstrapQ.alert("请选择文件：" + curCheckInDoc.name);
		    return false;	
	    }
	    
	    checkUserUploadRight(entrys,gParentNodeForUpload,uploadWithoutConfirm);		
	    return true;
	}
	
	//获取用户的权限
	function checkUserUploadRight(files,parentNode,callback)
	{
		console.log("checkUserUploadRight() parentNode:",parentNode);
		
		//get the parentInfo
	  	var parentPath = "";
	  	var parentId = 0;
	  	var level = 0;
		if(parentNode && parentNode != null)
		{
			parentPath = parentNode.path + parentNode.name+"/";
			parentId=parentNode.id;
			level = parentNode.level;
		}
		else
		{
			parentNode=null;
		}
		
		var vid = gReposId;
		var remoteDir = "/" + parentPath;	//only for display
		
		$.ajax({
			url : "/DocSystem/Repos/getUserDocAuth.do",
			type : "post",
			dataType : "json",
			data : {
				docId : parentId,
				reposId : vid
			},
			success : function (ret){
				if( "ok" == ret.status){
					var docAuth = ret.data;
					console.log(docAuth);
					if(docAuth.addEn == 1 || docAuth.editEn == 1)
					{
						callback && callback(files,parentNode);
					}
					else
					{
						showErrorMessage("您没有目录 "+remoteDir+" 的新增或修改权限");
					}
					return;
 				}
				else
				{
					showErrorMessage("Error:",ret.msgInfo);
					return;
				}
			},
			error : function () {
				showErrorMessage("获取用户权限异常");
				return;
			}
		});
	}
	
	//drag upload file confirm dialog（拖拽上传的确认对话框）
	function uploadConfirm(files,parentNode)
	{	
		console.log("uploadConfirm()");
		//build upload confirm text
	    if(files.length > 0)
	   	{
	    	console.log("files.length:" + files.length);
	    	for( var i = 0 ; i < files.length ; i++ )
	    	{  
	    		firstFile = files[i];
	    	   	if(typeof firstFile == 'object')
	    	   	{
	    	   		relativePath = firstFile.webkitRelativePath;	//获取第一个文件的相对路径
	    	   		console.log("firstFile relativePath:"+firstFile.webkitRelativePath);
	    	   		break;
	    	   	}
	    	   	else
	    	   	{
	    	   		//This is something else 
	    	   		//console.log("it is not a file");
	    	   	}
	    	}
	    }
	    else
	   	{
	   		bootstrapQ.alert("请选择文件");
	      	return false;
	   	}  
		
		var fileName = firstFile.name;
	    console.log("firstFile:"+fileName);
	  	
	  	var uploadDispInfo = fileName;
	  	if(files.length > 1)
	  	{
	  		uploadDispInfo = uploadDispInfo + " 等" + files.length + "个文件";
	  	}
	  	
		//get the parentInfo
	  	var parentPath = "";
	  	var parentId = 0;
	  	var level = 0;
		if(parentNode && parentNode != null)
		{
			parentPath = parentNode.path + parentNode.name+"/";
			parentId=parentNode.id;
			level = parentNode.level+1;
		}
		else
		{
			parentNode=null;
		}
		
		var vid = gReposId;

		var remoteDir = "/" + parentPath;	//only for display
		
	    qiao.bs.dialog({
	        id: "dialog-uploadDialog",
	        url: '#uploadConfirmDialog',
	        title: '文件上传',
	        okbtn: "开始上传",
	        callback: function () {
	            setTimeout(function () {
	                //alert("it works now");
	                //set the show name for uploadFiles
	                //$("#uploadContent").val(uploadContent);
	                $("#dialog-uploadDialog input[name='uploadContent']").val(uploadDispInfo);
	                //set the show name for destiontion remote directory
	                $("#dialog-uploadDialog input[name='remoteDir']").val(remoteDir);                
	                 
	            },100);
	        }
	    },function () {
	    	//alert("点击了确定");
			//开始上传
			DocUpload.uploadDocs(files,parentNode,parentPath,parentId,level,vid);
	    	return true;   
	    });
		return true;
	}
	
	function uploadWithoutConfirm(files,parentNode)
	{	
		console.log("uploadWithoutConfirm()");		
		
		//get the parentInfo
	  	var parentPath = "";
	  	var parentId = 0;
	  	var level = 0;
		if(parentNode && parentNode != null)
		{
			parentPath = parentNode.path + parentNode.name+"/";
			parentId=parentNode.id;
			level = parentNode.level;
		}
		else
		{
			parentNode=null;
		}
		
		var vid = gReposId;
		
		//开始上传
		DocUpload.uploadDocs(files,parentNode,parentPath,parentId,level,vid);
	    return true;   
	}



	//Re Upload Fail Docs
    function reuploadFailDocs(index)
    {
    	console.log("reuploadFailDocs() index:" + index);
    	DocUpload.reuploadFailDocs(index);    	
    }
    	
	//Stop Upload
	function stopUpload(index)
	{
    	//var index = $(this).attr('value');	//value 不是i的原生属性，所以不能用value
    	console.log("stopUpload " + index);
    	DocUpload.stopUpload(index);
    }
	
	//删除多余的treeNode
	function deleteDuplicatedTreeNode(name,parentNode)
    {
		console.log("deleteDuplicatedTreeNode",name,parentNode);
		var treeObj = $.fn.zTree.getZTreeObj("doctree");
		var nodes = treeObj.getNodesByParam("name", name, parentNode);
		console.log(nodes);
		if(nodes!=null && nodes.length > 1)
		{
			var size = nodes.length;
			var i = 1;
			//删除多余的treeNode
			for(i=1;i<size;i++)
			{
				Node = nodes[i];
				treeObj.removeNode(Node);
			}
		}
		return;
    }
	
	function deleteTreeNode(name,parentNode)
    {
		console.log("deleteTreeNode",name,parentNode);
		var NodeIndex = -1;
		var treeObj = $.fn.zTree.getZTreeObj("doctree");
		var Node = treeObj.getNodeByParam("name", name, parentNode); //找到新的目录下，id与被复制的节点相同id的Node(这是zTree自动产生的，我要删掉他)
		if(Node!=null)
		{
			NodeIndex = treeObj.getNodeIndex(Node);
			treeObj.removeNode(Node);
		}
		console.log(NodeIndex);
		return NodeIndex;
    }
</script>

<script>
	//上传进度框显示控制
	$(".el-upload-list").delegate(".closeBtn","click",function(){
		var uploadStatus = DocUpload.getUploadStatus();
		//uploadStatus = "busy";
		console.log("uploadStatus:" + uploadStatus);
		if(uploadStatus == "busy")
	    {
			qiao.bs.confirm({
		        id: 'bsconfirm',
		        msg: '上传还未结束，是否终止上传！'
		    },function(){
		        //alert('点击了确定！');
		    	DocUpload.stopAllUpload();
		    },function(){
		        //alert('点击了取消！');
		    });
	    }
	    else
	    {
	    	$(".el-upload-list").hide();
	    }
	});
	
	var showUploadList = true;
	$(".el-upload-list").delegate(".upload-list-title","click",function(){
		if(showUploadList == true)
		{
			showUploadList = false;
			//收起进度
			var height = - $(".el-upload-list").height()+"px";
			$(".el-upload-list").animate({bottom: height});
			$(".closeBtn").animate({opacity: 0});	//隐藏关闭按键
			//$(this).animate({opacity: 0});	//隐藏title，好像title不应该隐藏
		}
		else
		{
			showUploadList = true;
			$(".el-upload-list").animate({bottom: "0px"});
			$(".closeBtn").animate({opacity: 1});	//显示关闭按键
			//$(this).animate({opacity: 1});	//this 指向的是title，显示title
		}
	});
	
	/* 上传进度放在目录树的实现，不友好，代码放这里是可能给其他实现作参考
	$('.lookPro').on('click',function(){
		$(".el-upload-list").show();
		$('.main').removeClass('active');
		$(this).addClass('active');
	});
	$('.main').on('click',function(){
		$(".el-upload-list").hide();
		$('.lookPro').removeClass('active');
		$(this).addClass('active');
	});
	*/
	
    var zTree = jQuery.fn.zTree;

    $(document).keydown(function(e){
        // ctrl + s
        if( e.ctrlKey  == true && e.keyCode == 83 ){

            return false;
        }
    });

    // 从 url 中获取参数
    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }

	function getTime() {
        var now= new Date(),
        h=now.getHours(),
        m=now.getMinutes(),
        s=now.getSeconds(),
        ms=now.getMilliseconds();
        return (h+":"+m+":"+s+ " " +ms);
    }
</script>


<script type="text/javascript">



    var events = $("body");
    var catalog = null;
    /**
     * 初始化高亮插件
     */
    function initHighlighting() {
        $('pre code').each(function (i, block) {
            hljs.highlightBlock(block);
        });

        hljs.initLineNumbersOnLoad();
    }
    $(function () {
        initHighlighting();

        var windowHeight = $(window).height();
        var bodyHeight = $(document).height();

        $(window).resize(function(){
            var windowHeight = $(window).height();
            var bodyHeight = $(document).height();
        });

        /*
         catalog = $("#sidebar").jstree({
         'plugins':["wholerow","types"],
         "types": {
         "default" : {
         "icon" : false  // 删除默认图标
         }
         },
         'core' : {
         'check_callback' : false,
         "multiple" : false ,
         'animation' : 0
         }
         }).on('select_node.jstree',function (node,selected,event) {
         $(".m-manual").removeClass('manual-mobile-show-left');
         var url = selected.node.a_attr.href;

         if(url == window.location.href){
         return false;
         }


         $.ajax({
         url : url,
         type : "GET",
         beforeSend :function (xhr) {
         var body = events.data('body_' + selected.node.id);
         var title = events.data('title_' + selected.node.id);
         var doc_title = events.data('doc_title_' + selected.node.id);

         if(body && title && doc_title){

         $("#page-content").html(body);
         $("title").text(title);
         $("#article-title").text(doc_title);

         events.trigger('article.open',url,true);

         return false;
         }
         NProgress.start();
         },
         success : function (res) {
         if(res.errcode == 0){
         var body = res.data.body;
         var doc_title = res.data.doc_title;
         var title = res.data.title;

         $("#page-content").html(body);
         $("title").text(title);
         $("#article-title").text(doc_title);

         events.data('body_' + selected.node.id,body);
         events.data('title_' + selected.node.id,title);
         events.data('doc_title_' + selected.node.id,doc_title);

         events.trigger('article.open',url,false);

         }else{
         layer.msg("加载失败");
         }
         },
         complete : function () {
         NProgress.done();
         }
         });
         });*/

        $("#slidebar").on("click",function () {
            $(".m-manual").addClass('manual-mobile-show-left');
        });
        $(".manual-mask").on("click",function () {
            $(".m-manual").removeClass('manual-mobile-show-left');
        });
    });

    events.on('article.open', function (event, url,init) {
        if ('pushState' in history) {

            if (init == false) {
                history.replaceState({}, '', url);
                init = true;
            } else {
                history.pushState({}, '', url);
            }

        } else {
            location.hash = url;
        }
        initHighlighting();

    });

</script>


<script type="text/javascript">
	/******************************** Repos Interfaces***************************************/
    function getReposInfo(callback){
		console.log("getReposInfo");
        $.ajax({
            url : "/DocSystem/Repos/getRepos.do",
            type : "post",
            dataType : "json",
            data : {
                vid:gReposId
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                	gReposInfo = ret.data;
                    gReposName = gReposInfo.name;
                    gReposType = gReposInfo.type;
                    gReposCreateTime = gReposInfo.createTime;
                    $("#projectName").text(gReposName);
					//回调函数	
                    callback && callback();
                }else {
                    $("#projectName").text("仓库名");
                    alert(ret.msgInfo);
                }
            },
            error : function () {
                showErrorMessage("服务器异常:获取仓库信息失败");
            }
        });

    }
	
    function getNodeById(docId)
   	{
    	if(docId && docId != null)
    	{
			var zTree = $.fn.zTree.getZTreeObj("doctree");
			var node = zTree.getNodeByParam("id",docId);
			return node;
    	}
    	return null;
   	}

	//从后台获取zTree数据: callback1是成功后的回调函数1，需要后续处理的话加在这里处理
	function getInitMenu(docId, parentPath, docName) 
   	{
		console.log("getInitMenu docId:" + docId + " parentPath:" + parentPath + " docName:" + docName);
		
		$.ajax({
		    url : "/DocSystem/Repos/getReposInitMenu.do",
		    type : "post",
		    dataType : "json",
		    data : {
		        reposId : gReposId,  
		    	docId:  docId,
		    	path: parentPath,
		    	name: docName,
		    },
		    success : function (ret) {
		        	if( "ok" == ret.status ){
		        		console.log("getMenu() ret",ret);
		                reDrawMenu(ret.data);
		  
		                showDoc(docId);           	
		            }
		            else
		           	{
		           		showErrorMessage("Error:getReposMenu failed" + ret.MsgInfo);
		           	}
		        },
		        error : function () {
		            showErrorMessage("服务器异常:getReposMenu failed" + ret.MsgInfo);
		        }
		    });
	}

	/******************************** Doc Interfaces***************************************/
	//文件保存操作: callback是指成功后的回调函数
    function saveDoc(curDocId, content,newDocId)
	{
		console.log("saveDoc curDocId:" + curDocId + " newDocId" + newDocId);
        
		var curNode = getNodeById(curDocId);
		if(curNode && curNode == null)
		{
			bootstrapQ.alert("保存失败: 文件不存在");
			return;
		}
		
		$.ajax({
            url : "/DocSystem/Doc/updateDocContent.do",
            type : "post",
            dataType : "json",
            data : {
                reposId: gReposId,
            	docId : curDocId,
            	pid: curNode.pid,
                path: curNode.path,
                name: curNode.name,
            	content : content
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                    console.log("保存成功 : " , (new Date()).toLocaleDateString());
                    bootstrapQ.msg({
								msg : "保存成功 :" + (new Date()).toLocaleDateString(),
								type : 'success',
								time : 1000,
					});
					//清除debounce
					debounce.clear();
					
					if(newDocId)
					{
						unlockAndExitEditWiki(curDocId,newDocId);
					}
				}else {
                    bootstrapQ.alert("保存失败:"+ret.msgInfo);
                }
            },
            error : function () {
                bootstrapQ.alert("保存失败:服务器异常");
            }
        });

    }
    
    //文件临时保存操作
    function tmpSaveDoc(docId, content){
		console.log("tmpSaveDoc: docId:" + docId);
		
		var node = getNodeById(docId);
		if(node && node == null)
		{
            console.log("临时保存失败 :" , (new Date()).toLocaleDateString());
            bootstrapQ.msg({
				msg : "临时保存失败 : 文件不存在",
				type : 'danger',
				time : 1000,
			});	
            return;
		}
		
        $.ajax({
            url : "/DocSystem/Doc/tmpSaveDocContent.do",
            type : "post",
            dataType : "json",
            data : {
            	reposId: gReposId,
                docId : docId,
                pid: node.pid,
                path: node.path,
                name: node.name,
                content : content,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                    console.log("临时保存成功 :" , (new Date()).toLocaleDateString());
                    bootstrapQ.msg({
								msg : "临时保存成功 :" + (new Date()).toLocaleDateString(),
								type : 'success',
								time : 1000,
					});
                }else {
                    //bootstrapQ.alert("临时保存失败:"+ret.msgInfo);
                    bootstrapQ.msg({
						msg : "临时保存失败 :" + +ret.msgInfo,
						type : 'danger',
						time : 1000,
					});
                }
            },
            error : function () {
                //bootstrapQ.alert("临时保存异常");
                bootstrapQ.msg({
					msg : "临时保存失败 :服务器异常",
					type : 'danger',
					time : 1000,
				});
            }
        });

    }
    
    function updateUrl(reposId,docId,edit)
    {
    	console.log("updateUrl() reposId:" + reposId + " docId:" + docId + " edit:" + edit);
    	//Get Node by Id
    	var node = getNodeById(docId);
    	var path = "";
    	var name = "";
    	if(node && node != null)
    	{
    		path = node.path;
    		name = node.name;
    	}
    	
    	console.log("before encode path:" + path + " name:" + name);
    	
    	//避免取回来时乱码
	   	path = Base64.encode(path);
	   	name = Base64.encode(name);

	   	console.log("after encode path:" + path + " name:" + name);
	   	
	   	//path = decodeURI(path);
	   	//name = decodeURI(name);
	   	//console.log("after decode path:" + path + " name:" + name);
    	
        //Update URL 保证页面刷新后还是处于正确的状态
        var param = {
        	vid : reposId,
            doc : docId,
            path: path,
            name: name,
            edit: edit,   
        };
        var url = makeUrl(param);
		window.history.pushState({}, "wiki", url);
	}
    
	//读取文件信息
    function showVirtualDoc(node,edit) {
      	
		console.log("showVirtualDoc() edit:" + edit + " node:", node);
      	if(!node || node == null)	//undefine do clean the info of rightDiv
      	{
      		//Clean FileName
          	$('#filetitle').html("");
          		
          	//Clean the display content
          	DocEdit.stopAutoTmpSaver();
          	debounce.clear();
          	gDocContent = "";
          	gEdit = false;
          	DocEdit.loadmd(gDocContent,gEdit);
          	return;
        }
      	
      	//Update URL 保证页面刷新后还是处于正确的状态
		updateUrl(gReposId,node.id,edit);
      	
        //To get DocInfo and Show Content
    	$.ajax({
            url : "/DocSystem/Doc/getDoc.do",
            type : "post",
            dataType : "json",
            data : {
            	reposId: gReposId,
                docId : node.id,
                pid: node.pid,
                path: node.path,
                name: node.name,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                	console.log("showVirtualDoc ret",ret);
                	$('#filetitle').html(ret.data.name);
                    gDocId = ret.data.docId;
                    if(ret.data.content == "null")
                    {
                    	gDocContent = "";	//Convert it to empty String
                    }
                    else
                    {	
                    	gDocContent = JSON.parse(ret.data.content);
                    }
                    					
					DocEdit.loadmd(gDocContent,edit);
                    
                    WikiEditBtnCtrl(edit);		
					
                    //we need to clear debounce when a new doc was loaded
					debounce.clear();
					if(edit)
					{
						//start the autoTmpSaver
						DocEdit.startAutoTmpSaver();
					}
					else
					{
						DocEdit.stopAutoTmpSaver();
					}
                }
                else
                {
                	showErrorMessage("获取文件信息失败：" + ret.msgInfo);              	
                }
            },
            error : function () {
                showErrorMessage("获取文件信息失败：服务器异常");
                $btn.button('reset');
            }
        });
    }
	
	function showDocHistory(node, historyType)
	{
		console.log("showDocHistory()");

		var parentPath ="";
		var docName = "";
		var docId = 0;
		var pid = 0;
		var docType = 2;
			
		var treeNode = node;
		if(treeNode != null)
		{
			docId = treeNode.id;
			pid = treeNode.pid;
			parentPath = treeNode.path;
			docName = treeNode.name;
			docType = treeNode.type;
		}
		console.log("docId:" + docId + "parentPath:" + parentPath + " docName:"+docName);
		
		var title = "文件 " + docName + " 历史版本";
		if(historyType == 0)
		{
			if(docId == 0)
			{
				var title = "仓库 " + gReposName + " 历史版本";
			}
			else
			{
				if(docType == 2)
				{
					var title = "目录 " + docName + " 历史版本";				
				}
			}
		}
		else
		{
			if(docId == 0)
			{
				var title = "仓库 " + gReposName + " 备注历史版本";
			}
			else
			{
				var title = "文件 " + docName + " 备注历史版本";				
			}
		}
		
		//show HistoryLogs page
		bootstrapQ.dialog({
			title: title,
			url: 'historyLogs.html',
			msg: '页面正在加载，请稍等...',
			foot: false,
			big: true,
			callback: function(){
				DocHistory.historyLogsPageInit(gReposId, docId, pid, parentPath, docName, historyType);
			},
		});
	}
	
   	//addDoc接口	
   	function addDoc(name,type,content,parentNode,parentId,vid)
   	{
   		console.log("addDoc name:" + name + " type:" +  type + " content:" +  content + " parentNode:" +  parentNode + " vid:" +  vid);
   		var parentPath = "";
   		var level = 0;
   		if(parentNode && parentNode != null)
   		{
   			level = parentNode.level + 1;
   			parentPath = parentNode.path + parentNode.name + "/";
   	   		
   		}

    	$.ajax({
             url : "/DocSystem/Doc/addDoc.do",
             type : "post",
             dataType : "json",
             data : {
                reposId : vid, 
				level: level, 
				type : type, //文件类型
	            pid : parentId,
                path: parentPath,
                name : name,
             	content: content,
             },
             success : function (ret) {
             	if( "ok" == ret.status && ret.data.docId){
             		if(type == 2)
                    {
                    	isParent = true;
                    }
                    else
                    {
                    	isParent = false;                    	
                    }
                    //Add zTreeNode
             		addTreeNode(ret.data);
                    
             		// 普通消息提示条
					bootstrapQ.msg({
								msg : "新建完成！",
								type : 'success',
								time : 2000,
					});
                }
                else
                {
                	showErrorMessage("新建失败:" + ret.msgInfo);
                }
            },
            error : function () {
                showErrorMessage("新建失败:服务器异常！");
            }
        });
    }
</script>

<script type="text/javascript">
	/********************* 文件编辑接口 *********************************************/
	//退出文件编辑状态
    function exitEdit(curDocId,newDocId) {
    	console.log("exitEdit curDocId:" + curDocId + " newDocId:" + newDocId);
    	if(!curDocId)
    	{
    		curDocId = gDocId;
    	}
    	
    	if(debounce.getStatus() == 1)
    	{
    		qiao.bs.confirm({
  	 	    		id: 'saveDocConfirm',
  	 	    		msg: "修改未保存，是否保存？",
  	 	    		close: false,		
  	 	    		okbtn: "保存",
  	 	    		qubtn: "直接退出",
  	 	    	},function () {
  	 	    	    saveWikiAndExit(curDocId,newDocId);
  	  	 			return true;
  	 			},function(){
  	 				unlockAndExitEditWiki(curDocId,newDocId);
  	 				return true;
  	 		});
  	 	}
  	 	else
  	 	{
    		unlockAndExitEditWiki(curDocId,newDocId);
    	}
	}
	
	    //将编辑中的文件保存到后台
    function saveWikiAndExit(curDocId,newDocId) {
    	console.log("saveWikiAndExit  curDocId:" + curDocId + " newDocId:" + newDocId);
    	if(debounce.getStatus() == 1)
    	{
    		saveDoc(gDocId, debounce.get(),newDocId);
    	}
    }
	
	function unlockAndExitEditWiki(curDocId,newDocId)
	{
		console.log("unlockAndExitEditWiki()  curDocId:" + curDocId + " newDocId:" + newDocId);
		if(!curDocId)
		{
			showErrorMessage("文件不存在");
			exitEditWiki(curDocId,newDocId);
			return;
		}
		
		var node = getNodeById(curDocId);
		if(!node || node == null)
		{
			showErrorMessage("文件不存在");
			exitEditWiki(curDocId,newDocId);
			return;
		}
		
		var pid = node.pid;
		var path = node.path;
		var name = node.name;
		$.ajax({
			url : "/DocSystem/Doc/lockDoc.do",
			type : "post",
			dataType : "json",
			data : {
				lockType : 0, //unlock the doc
				reposId : gReposId, 
				docId : curDocId,
				pid: pid,
				path: path,
				name: name,
			},
			success : function (ret) {
				if( "ok" == ret.status){
					console.log(ret.data);
					$("[dataId='"+ curDocId +"']").children("div:first-child").css("color","black");
					exitEditWiki(curDocId,newDocId);
				    return;
 				}
				else
				{
					showErrorMessage("unlockDoc Error:" + ret.msgInfo);
					exitEditWiki(curDocId,newDocId);
					return;
				}
			},
			error : function () 
			{
				showErrorMessage("unlockDoc 异常");
				exitEditWiki(curDocId,newDocId);
				return;
			}
		});
	}
	
    function exitEditWiki(curDocId,newDocId) {  
      	console.log("exitEditWiki()  curDocId:" + curDocId + " newDocId:" + newDocId);
		//swith to preview state
        DocEdit.editorSwitch(false);
        //编辑等按键显示控制
        WikiEditBtnCtrl(false);
	    
	    //Stop autoSaver
	    debounce.clear();
	    DocEdit.stopAutoTmpSaver();
	            
        if(newDocId)
        {
        	var edit = false;
        	showVirtualDoc(newDocId,edit);	//
        }
        else
        {
        	updateUrl(gReposId,curDocId,false);
        }
    }
	
	//进入编辑状态
	function lockAndEditWiki()
	{
		console.log("lockAndEditWiki()");
		var vid = gReposId;
		var docId = gDocId;

		if(!docId)
		{
			showErrorMessage("文件不存在");
			return;
		}
		
		var node = getNodeById(docId);
		if(!node || node == null)
		{
			showErrorMessage("文件不存在");
			return;
		}
		
		var pid = node.pid;
		var path = node.path;
		var name = node.name;

		$.ajax({
			url : "/DocSystem/Doc/lockDoc.do",
			type : "post",
			dataType : "json",
			data : {
				lockType : 3, //LockType: VDoc Online Edit
				reposId : vid, 
				docId : docId,
				pid: pid,
				path: path,
				name: name,
			},
			success : function (ret) {
				if( "ok" == ret.status){
					console.log(ret.data);
					$("[dataId='"+ docId +"']").children("div:first-child").css("color","red");
				    editWiki(docId);
				    return;
 				}
				else
				{
					showErrorMessage("lockDoc Error:" + ret.msgInfo);
					return;
				}
			},
			error : function () 
			{
				showErrorMessage("lockDoc 异常");
				return;
			}
		});
	}
	
	function unlockDoc(docId)
	{
		console.log("unlockDoc()  docId:" + docId);
		
		if(!docId)
		{
			showErrorMessage("文件不存在");
			return;
		}
		
		var node = getNodeById(docId);
		if(!node || node == null)
		{
			showErrorMessage("文件不存在");
			return;
		}
		
		var pid = node.pid;
		var path = node.path;
		var name = node.name;
		
		$.ajax({
			url : "/DocSystem/Doc/lockDoc.do",
			type : "post",
			dataType : "json",
			data : {
				lockType : 0, //unlock the doc
				reposId : gReposId, 
				docId : docId,
				pid: pid,
				path: path,
				name: name,
			},
			success : function (ret) {
				if( "ok" == ret.status){
					console.log(ret.data);
					
					$("[dataId='"+ docId +"']").children("div:first-child").css("color","black");
				    return;
 				}
				else
				{
					showErrorMessage("unlockDoc Error:" + ret.msgInfo);
					return;
				}
			},
			error : function () 
			{
				showErrorMessage("unlockDoc 异常");
				return;
			}
		});
	}
	
	//进入文件编辑状态
    function editWiki(docId){
        
        DocEdit.editorSwitch(true);
        
        WikiEditBtnCtrl(true);
	    
        updateUrl(gReposId,docId,true);
        
        //start the autoTmpSaver
        debounce.clear();
	    DocEdit.startAutoTmpSaver();
    }
    
    //将编辑中的文件保存到后台
    function saveWiki() {
    	console.log("saveWiki");
    	if(debounce.getStatus() == 1)
    	{
    		saveDoc(gDocId, debounce.get());
    	}
    }
	
	//debounce文件编辑缓存类
    var debounce = (function () {
        //var cache = [];
        var latestcopy = "";
        var status = 0; //For save
        var status1 = 0; //For tmpSave
        
		function getLatestCopy()
		{
		    return latestcopy;
		}
		
		function getStatus()
		{
			if ( status == 1 ){	
            	return 1;
            }
            return 0;
		}
		
		function clearStatus()
		{
			status = 0;
		}
		
		function getStatus1()
		{
			if ( status1 == 1 ){	
            	return 1;
            }
            return 0;
		}
		
		function clearStatus1()
		{
			status1 = 0;
		}
		
        return {
            get: function(){
            	return getLatestCopy();
            },
            getStatus: function(){
            	return getStatus();
            },
            getStatus1: function(){
            	return getStatus1();
            },
            clearStatus: function(){
            	console.log("debounce clearStatus");
            	return clearStatus();
            },
            clearStatus1: function(){
	            console.log("debounce clearStatus1");
            	return clearStatus1();
            },
            call : function (c) {
            	console.log("debounce call");
                latestcopy = c;
                status = 1;
                status1 = 1;
            },
            clear : function () {
                console.log("debounce clear");
                status = 0;
                status1 = 0;
                latestcopy = "";
            }
        };
    })();
	
	
    function makeUrl(params) {
        var href = window.location.href;
        var i = href.indexOf("?");
        if ( i< 0 ){
            i = href.length;
        }

        href = href.substring(0,i);

        var str = ""
        for( k in params ){
            if ( params[k]){ //params[k]
              str += "&" + k + "=" + params[k];
            }
        }

        return href + "?" + str.substr(1);
    }

	function getParam(){
	    var url = location.search; // 获取url中"?"符后的字串
	    if (url.indexOf("?") != -1) { // 判断是否有参数
	        var str = url.substr(1); // 从第一个字符开始 因为第0个是?号 获取所有除问号的所有符串
	        var strs = str.split("="); // 用等号进行分隔 （因为知道只有一个参数 所以直接用等号进分隔 如果有多个参数 要用&号分隔
	        return strs[1]; // 返回第一个参数值
	    }
	
	}

   var getUrlParams = function() {
        "use strict";
        var url = location.search;
        var params = {};
        var strs;
        var _strs;
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            if (str.indexOf("&") != -1) {
                strs = str.split("&");
                for ( var i = 0; i < strs.length; i++) {
                    _strs = strs[i].split("=");
                    params[_strs[0]] = _strs[1];
                }
            } else {
                strs = str.split("=");
                params[strs[0]] = strs[1];
            }
        }
        return params;
    }


    //js动态改变url参数值
    function setUrlParam(para_name, para_value) {
        var strNewUrl = new String();
        var strUrl = new String();
        var url = new String();
        url= window.location.href;
        strUrl = window.location.href;
        //alert(strUrl);
        if (strUrl.indexOf("?") != -1) {
            strUrl = strUrl.substr(strUrl.indexOf("?") + 1);
            //alert(strUrl);
            if (strUrl.toLowerCase().indexOf(para_name.toLowerCase()) == -1) {
                strNewUrl = url + "&" + para_name + "=" + para_value;
                window.location = strNewUrl;
                //return strNewUrl;
            } else {
                var aParam = strUrl.split("&");
                //alert(aParam.length);
                for (var i = 0; i < aParam.length; i++) {
                    if (aParam[i].substr(0, aParam[i].indexOf("=")).toLowerCase() == para_name.toLowerCase()) {
                        aParam[i] = aParam[i].substr(0, aParam[i].indexOf("=")) + "=" + para_value;
                    }
                }
                strNewUrl = url.substr(0, url.indexOf("?") + 1) + aParam.join("&");
                //alert(strNewUrl);
                window.location = strNewUrl;
                //return strNewUrl;
            }
        } else {
            strUrl += "?" + para_name + "=" + para_value;
            //alert(strUrl);
            window.location=strUrl;
        }
    }


    function getDate(tm){
        var tt = new Date(tm).toLocaleString();
        return tt;
    }
</script>

<script type="text/javascript" >
//json obj compare
function isObj(object) {
    return object && typeof(object) == 'object' && Object.prototype.toString.call(object).toLowerCase() == "[object object]";
}

function isArray(object) {
    return object && typeof(object) == 'object' && object.constructor == Array;
}

function getLength(object) {
    var count = 0;
    for(var i in object) count++;
    return count;
}

function Compare(objA, objB) {
    if(!isObj(objA) || !isObj(objB)) 
    {
    	console.log("类型不符");
    	return false; //判断类型是否正确
    }
    if(getLength(objA) != getLength(objB)) 
    {
    	console.log("长度不符");
    	return false; //判断长度是否一致
    }
    return CompareObj(objA, objB, true); //默认为true
}

function CompareObj(objA, objB, flag) {
    for(var key in objA) {
        if(!flag) //跳出整个循环
            break;
        if(!objB.hasOwnProperty(key)) {
            flag = false;
            break;
        }
        if(!isArray(objA[key])) { //子级不是数组时,比较属性值
            if(objB[key] != objA[key]) {
                flag = false;
                break;
            }
        } else {
            if(!isArray(objB[key])) {
                flag = false;
                break;
            }
            var oA = objA[key],
                oB = objB[key];
            if(oA.length != oB.length) {
                flag = false;
                break;
            }
            for(var k in oA) {
                if(!flag) //这里跳出循环是为了不让递归继续
                    break;
                flag = CompareObj(oA[k], oB[k], flag);
            }
        }
    }
    return flag;
}
</script>

<SCRIPT type="text/javascript" >
	/********************** zTree设置与接口**********************************/
	
	//右键点击所在的zTreeNode：用于右键菜单相关的操作:rename, remove, 新建,上传,下载
	var curRightClickedTreeNode = null;
	var gCopiedNodes = null;	//右键复制操作选中的节点
	var gParentNodeForUpload = null; //用于保存右键选择上传的父节点
	
	//zTree's setting
	var setting = {
		//异步加载的工作原理
		async : {  
    		enable : true,//设置 zTree 是否开启异步加载模式  
            url : "/DocSystem/Repos/getSubDocList.do",
            type : "post",
    		autoParam : ["id","level","path","name"],	//zTree会自动根据用户双击的节点设置参数为id=treeId，自动传递的参数必须符合zTree的规则，这也是为什么不得不把后台参数名parentId改为id的原因
    		otherParam:{"vid":gReposId}, //这里设置的参数是固定的，如果需要修改的话需要修改配置文件，我就是这么做的，详见getReposInfo函数	
    		dataFilter: asyncDataFilter, 
		},
	   	//可编辑功能设置
		edit: {
               enable: true,
               removeTitle : "删除",
               renameTitle : "改名",
               showRemoveBtn : false,
               showRenameBtn : false,
               drag: {
                   autoExpandTrigger: true,
                   prev: dropPrev,
                   inner: dropInner,
                   next: dropNext,
               },
           },
           //zTree数据格式
	   	data: {
	   			//使用简单数据模式
	            simpleData: {
	                enable: true,
	            },
	            //不允许修改leaf node and parent node的isParent属性
	            keep: {
	            	leaf: true,
	            	parent: true,
	            },
	    },
	    //zTree各种操作的回调函数定义
	    callback: {
	            beforeAsync: zTreeBeforeAsync, //异步加载前的回调函数， 可以用来判断是否需要异步加载
                onAsyncSuccess: zTreeOnAsyncSuccess, //异步加载完成后的回调
	            beforeDrag: zTreeBeforeDrag,
	            beforeDrop: zTreeBeforeDrop,
	            onDrag : zTreeOnDrag,
	            onDrop : zTreeOnDrop,
	            onChange: zTreeOnChange,
	            onClick: zTreeOnClick,
	            beforeRightClick: zTreeBeforeRightClick
	            //onRightClick: zTreeOnRightClick, //定义该回调将会屏蔽系统右击事件
	    },
	};


	function asyncDataFilter(treeId, parentNode, responseData) {
		console.log("asyncDataFilter");
		var docList = responseData.data;
		//遍历jason_arry, convert the node type to isParent flag
      	for(var i=0; i<docList.length; i++)
      	{
           var jsonObj = docList[i];
           jsonObj.id = jsonObj.docId;
           jsonObj.pId = jsonObj.pid != 0? jsonObj.pid : "root",
           jsonObj.isParent = jsonObj.type == 1? false: true;
       }
       console.log(docList);
	   return docList;
	}
	
    function zTreeBeforeAsync(treeId, treeNode) {  
    	console.log("zTreeBeforeAsync treeId:"+ treeId, treeNode);
    }  
      
    function zTreeOnAsyncSuccess(event, treeId, treeNode, msg) {
    	console.log("zTreeOnAsyncSuccess treeId:" + treeId);
    }

	//This function was used to get the rightClick treeNode,it will be used for contextjs
	function zTreeBeforeRightClick(treeId, treeNode) {
		//alert(treeNode ? treeNode.tId + ", " + treeNode.name : "isRoot");
		curRightClickedTreeNode = treeNode;
    	return true;	
	};
		
	//This function will replace all righot click, so i did not use it
	function zTreeOnRightClick(event, treeId, treeNode) {
    	alert(treeNode ? treeNode.tId + ", " + treeNode.name : "isRoot");
	};
		
	//Drag and Drop Implementation Start: curDragNhodes was used to remember DragNodes
    var className = "dark", curDragNodes, autoExpandNode;        
    //拖动前的检查 
    function zTreeBeforeDrag(treeId, treeNodes) {
        console.log("zTreeBeforeDrag");
        className = (className === "dark" ? "":"dark");
        for (var i=0,l=treeNodes.length; i<l; i++) {
            if (treeNodes[i].drag === false) {	//Current node can not drag
                curDragNodes = null;
                return false;
            } else if (treeNodes[i].parentTId && treeNodes[i].getParentNode().childDrag === false) { //Parent's child can not drag
                curDragNodes = null;
                return false;
            }
        }
        curDragNodes = treeNodes;
        return true;
    }
        
    function zTreeBeforeDragOpen(treeId, treeNode) {
        console.log("zTreeBeforeDragOpen");
        autoExpandNode = treeNode;
        return true;
    }
    
    //zTree拖动处理接口
    function zTreeOnDrag()
    {
    	console.log("zTreeOnDrag");
     	//updateMenu();
    }
        
    //dropPre Next and Inner was use to check if it was allowed to drop
	function dropPrev(treeId, nodes, targetNode) {
		console.log("dropPrev");
           var pNode = targetNode.getParentNode();
           if (pNode && pNode.dropInner === false) {
               return false;
           } else {
           	//当前被拖动的节点和目标节点如果在同一个目录不变化；不同目录，但所在目录子节点不允许移动则不变化
           	var l=curDragNodes.length;
               for (var i=0; i<l; i++) {
                   var curPNode = curDragNodes[i].getParentNode();
                   if (curPNode && curPNode !== targetNode.getParentNode() && curPNode.childOuter === false) {
                       return false;
                   }
               }
           }
           return true;
    }
    function dropInner(treeId, nodes, targetNode) {
      	  console.log("dropInner");
          if (targetNode && targetNode.dropInner === false) {
              return false;
          }
          else {
              //if the curDragNodes was in the same directory with TargetNode do nothing
              for (var i=0,l=curDragNodes.length; i<l; i++) {
                  if (!targetNode && curDragNodes[i].dropRoot === false) {
                      return false;
                  } else if (curDragNodes[i].parentTId && curDragNodes[i].getParentNode() !== targetNode && curDragNodes[i].getParentNode().childOuter === false) {
                      return false;
                  }
              }
          }
          return true;
      }
      function dropNext(treeId, nodes, targetNode) {
      	console.log("dropNext");
          var pNode = targetNode.getParentNode();
          if (pNode && pNode.dropInner === false) {
              return false;
          } else {
              for (var i=0,l=curDragNodes.length; i<l; i++) {
                  var curPNode = curDragNodes[i].getParentNode();
                  if (curPNode && curPNode !== targetNode.getParentNode() && curPNode.childOuter === false) {
                      return false;
                  }
              }
          }
          return true;
      }
		
	  //drop前检查函数
      function zTreeBeforeDrop(treeId, treeNodes, targetNode, moveType, isCopy) {
          console.log("zTreeBeforeDrop");
          
          //move this confirm to dropInner, it will be better
          //if (targetNode && targetNode.isParent !== true) { //leaf node can not drop
          //	console.log("can not drop to leaf node");
          //	return false;
          //}
		            
          if(targetNode.drop === false)
          {
          	console.log("drop was not allowed for this node");
          	return false;
          }
          
          	//get targe parentNode
      		var parentNode = targetNode;
      		if(targetNode)
      		{
      			if(moveType == "prev" || moveType == "next")	//如果拖到节点的前面或后面，则表示要放到上一层目录,leaf的inner属性是通过setting来控制的
      			{
      				parentNode = targetNode.getParentNode();
      			}
      			else
      			{
	      			parentNode = targetNode;
      			}
      		}
      		else
      		{
      			showErrorMessage("targetNode is null,理论上不该出现");
      			return;
      		}
           
          	className = (className === "dark" ? "":"dark");
          	return true;
      }
      
      //Drop处理函数
      function zTreeOnDrop(event, treeId, treeNodes, targetNode, moveType, isCopy)
      {
      		console.log("zTreeOnDrop");
      		
      		if(moveType == null)	//无效拖放，不处理
			{
				//alert("Invalid drag and drop!");
				return;
			}
      		
      		//get targe parentNode
      		var parentNode = targetNode;
      		if(targetNode)
      		{
      			//对于leaf node, prev next inner都是指放到其父节点下
      			if(targetNode.isParent == false)
 				{
 					parentNode = targetNode.getParentNode();
 	 			}
 	 			else
 	 			{
 	 				if(moveType == "prev" || moveType == "next")	//如果拖到节点的前面或后面，则表示要放到上一层目录
      				{
      					parentNode = targetNode.getParentNode();
      				}
      				else
      				{
	      				parentNode = targetNode;
      				}
 	 			}
      		}
      		else
      		{
      			showErrorMessage("targetNode is null,理论上不该出现");
      			return;
      		}
			
			var vid = gReposId;
 	 		
 	 		//确定是copy还是move,如果是move调用后台move操作，否则调用后台copy操作
	      	if(isCopy == true) //copy: 复制文件，并新建doc记录
	      	{
				DocCopy.copyDocs(treeNodes,parentNode,vid);
	      	}
	      	else	//move: 移动文件，并修改doc的parenID和path
	      	{
	      		DocMove.moveDocs(treeNodes,parentNode,vid); 
	      	}
      }
      //Drag and Drop Implementation End
      
      //zTree API没有onChange事件定义啊，汗，大概就zTree发送变化时的处理函数
      function zTreeOnChange()
      {
       	console.log("zTreeOnChange");
      }
        
      //为了能够让外部接口能够调用zTree的callback，需要记录当前treeNode等变量
      function zTreeOnClick(event, treeId, treeNode) 
      {
          if(gDocId != treeNode.id)
          {
        	 if(gEdit)
             {
              	//exitEdit then showVirtualDoc
              	exitEdit(gDocId,treeNode.id);
             }
             else
             {              
            	 gDocId = treeNode.id;

              	 //showDocList
            	 var parentNode = getParentNodeByNode(treeNode);
              	 showDocList(parentNode);
           	     
              	 //显示预览或备注
             	 showVirtualDoc(treeNode,false);
             }
          }
      }
      
      //Double Click 对于文件应该是编辑，对于目录应该是打开

	//判断当前目录下名字为 name的Node是否已经存在，parentNode是null表示根目录
	function isNodeExist(name,parentNode)
	{
		var parentId = null;
		if(parentNode && parentNode.id) 
		{
			parentId =  parentNode.id;
		}
		
		var treeObj = $.fn.zTree.getZTreeObj("doctree");
		var nodes = treeObj.getNodesByParam("name", name, parentNode);
		for (var i=0,l=nodes.length; i<l; i++)
		{
			if(nodes[i].pId == parentId)
			{	
				//alert(name + " 已存在");
				return true;
			}
		}
		return false;
	}
	
	//get the treeNode under parentNode with name
	function getNodeByName(name,parentNode)
	{
		var parentId = null;
		if(parentNode && parentNode.id) 
		{
			parentId =  parentNode.id;
		}
		
		var treeObj = $.fn.zTree.getZTreeObj("doctree");
		var nodes = treeObj.getNodesByParam("name", name, parentNode);
		for (var i=0,l=nodes.length; i<l; i++)
		{
			if(nodes[i].pId == parentId)
			{	
				return nodes[i];
			}
		}
		return null;
	}
	
	//获取Node的路径
	function getNodePath(treeNode)
	{
		var path = "";
		if(treeNode)
		{
			var nodes = treeNode.getPath();	//获取当前节点的所有父节
			console.log("getNodePath() nodes ",nodes);	
			for( var i = 0 ; i < nodes.length-1; i++ )
			{
				path = path + nodes[i].name + "/"; 
			}
		}
		return path;
	}

    //该接口是为了避免新增Node时触发的异步加载导致出现多个Node
	function addTreeNode(node)
	{
		console.log("addTreeNode() node:",node);

		if(!node || node == null)
		{
			console.log("addTreeNode() node is null");
			return;
		}
		
		var docId = node.docId;
		var pid = node.pid;
		var path = node.path;
		var name = node.name;
		var type = node.type;
		var latestEditTime = node.latestEditTime;
		
		var isParent = false;
		if(type == 2)
		{
			isParent = true;
		}

		var pId = pid;
		if(pid == 0)
		{
			pId = "root"; //zTree root id is root -__-!
		}
		
		var parentNode = undefined;	
		if(pid != 0)
		{
			parentNode = getNodeById(pid);
			if(parentNode == null || parentNode.open == false)
			{
				console.log("addTreeNode() parentNode is null or not exists");
				return;
			}
		}
		else
		{
			parentNode = null;	//parentNode is rootNode
		}

		
		//Add zTree Node
		//parentNode处于展开状态时，需要手动addTreeNode以保证与后台同步，否则只要触发异步加载即可
		if(parentNode == null || parentNode.open == true)
		{
			console.log("addTreeNode() parentNode is open");
			
			//add the treeNode
			var treeObj = $.fn.zTree.getZTreeObj("doctree");
			var treeNode = getNodeByNodeId(docId);
			if(treeNode == null)
			{
	      		var newNode = {id : docId, pid: pid, path: path, name: name, type: type,  isParent: isParent, pId: pId};
	      		newNodes = treeObj.addNodes(parentNode, newNode);
			}
		}
		else
		{
			console.log("addTreeNode() parentNode is closed, do not addTreeNode");

			//open the parentNode
			//var treeObj = $.fn.zTree.getZTreeObj("doctree");
			//treeObj.expandNode(parentNode, true, false, true);
		}
		
		//Add DocList Node
		console.log("addTreeNode pid:" + pid + " DocListParentDocId:" + DocListParentDocId );
		if(pid == DocListParentDocId)
		{
			if(DocList.isNodeExists(docId) == false)
			{
				DocList.addNode(docId, pid, type, path, name, latestEditTime);
			}
		}
	}
	
	//zTree初始化接口:根据data和setting生成zTree
	function zTreeInit(data) {
	    console.log("zTreeInit");
	    //console.log(setting);
	
	    var doctree = zTree.init($("#doctree"), setting, data);
	    //doctree.expandAll(true); //考虑只自动展开根目录下目录
	}
	
	//PageInit
	var login_user = "";	//用来保存刚注册的用户、或刚才登录的用户
	function SysInit()
	{
		console.log("SysInit");
    	
		//Set the event handler for keydown
		document.onkeydown=function(event)
		{
			//浏览器兼容性处理
			var e = event || window.event || arguments.callee.caller.arguments[0];
			EnterKeyListenerForSearchDoc(e);	
		}
		
    	//确定当前登录用户是否已登录e
    	$.ajax({
            url : "/DocSystem/getLoginUser.do",
            type : "post",
            dataType : "json",
            data : {},
            success : function (ret) {
                if( "ok" == ret.status )
                {
                	var user = ret.data;
                	login_user = user;
                	//显示用户信息
                	ShowUserInfo(user);
                	
                	//获取仓库信息
            		getReposInfo(InitMenu);
                }
                else 
                {
                	console.log(ret.msgInfo);
                	alert(ret.msgInfo);
                	//Jump to index.html
                    //window.location.href = "index.html";
                    
                	//Show Login Dialog
                    //showLoginPanel();
                }
            },
            error : function () {
            	showErrorMessage("服务器异常:获取用户信息失败");
            }
        });		
	}
	
	//将后台Menu,同步回前台
	function InitMenu()
	{
		console.log("InitMenu");
	    getInitMenu(gDocId, gParentPath, gDocName);
	}
	
	//将后台Menu,同步回前台
	function syncUpMenu()
	{
		console.log("syncUpMenu");
	    getInitMenu(gDocId, gParentPath, gDocName);
	}
	
	function reDrawMenu(data)
	{
		if( window.menu != data ){
	        console.log("同步菜单");
	        drawMenu(data);
	    }else{
	        console.log("重新绘制菜单，因为当前菜单数据与zTree不一致");
	        drawMenu(data);
	    }
	}
	
	//绘制zTree with the data:强制绘制，判断的东西不应该放在这里
	function drawMenu(data) {
		console.log("drawMenu");
		window.menu = data;
	    //data = JSON.parse('"' + data + '"'); //We need to use JSON parse one more time here  
	    //var menu = JSON.parse(data);
	    var menu = data;
	    //遍历jason_arry
      	for(var i=0; i<menu.length; i++)
      	{
           var jsonObj = menu[i];
           jsonObj.id = jsonObj.docId;
           jsonObj.pId = jsonObj.pid != 0? jsonObj.pid : "root",
           jsonObj.isParent = jsonObj.type == 1? false: true;
       }
	   //console.log(menu);
	   zTreeInit(menu);
	}
	
	//DocList类
	var DocListState = 0;
	var DocListParentDocId = 0;
	var DocList = (function () {    	
    	//Draw DocList
    	function showList(data){
     	 	var str="";
           	for(var i=0; i<data.length; i++)
     	    {
     	           var iconType = data[i].type===1?'<i class="type2 icons"></i>':'<i class="type1 icons"></i>';
     	           var docId = data[i].docId;
     	           var pid = data[i].pid;
     	           var docType = data[i].type;
     	           var path = data[i].path;
     	           var docName = data[i].name;
     	           if(data[i].state && data[i].state != 0)
     	           {
     	        		str+='<li dataId='+ docId + ' dataPid='+ pid +' dataType='+docType +' dataPath="'+ path + '" dataName="'+docName+'"'+' class="second-listBox" onmousedown="docListOnMouseDown(this,event)"><div onclick="secondGetDoc(this)" class="filename pull-left" style="color:red">'+iconType + docName+'</div><div class="filedate pull-right">'+formatDate(data[i].latestEditTime)+'</div><div class="handle pull-right"><i class="glyphicon glyphicon-new-window" onclick="fx(this,event)"></i><i class="glyphicon glyphicon-download-alt" onclick="xz(this,event)"></i><i onclick="sc(this,event)" class="glyphicon glyphicon-trash"></i><i onclick="showContextMenu(this,event)" class="glyphicon glyphicon-list"></i></div></li>';   
     	           }
     	           else
     	           {
     	           	    str+='<li dataId='+ docId + ' dataPid='+ pid +' dataType='+docType +' dataPath="'+ path + '" dataName="'+docName+'"'+' class="second-listBox" onmousedown="docListOnMouseDown(this,event)"><div onclick="secondGetDoc(this)" class="filename pull-left">'+iconType + docName+'</div><div class="filedate pull-right">'+formatDate(data[i].latestEditTime)+'</div><div class="handle pull-right"><i class="glyphicon glyphicon-new-window" onclick="fx(this,event)"></i><i class="glyphicon glyphicon-download-alt" onclick="xz(this,event)"></i><i onclick="sc(this,event)" class="glyphicon glyphicon-trash"></i><i onclick="showContextMenu(this,event)" class="glyphicon glyphicon-list"></i></div></li>';
     	           }	 
     	    }
           	$("#secondList").html(str);
     	}
    	
    	//Check if node exists
		function isNodeExists(docId)
		{
			if($("[dataId='"+ docId +"']").length > 0)
			{
				return true;
			}
			return false;
		}
    	
    	//Add Node
		function addNode(docId, pid, docType, path, docName, latestEditTime)
		{
	        var iconType = docType===1?'<i class="type2 icons"></i>':'<i class="type1 icons"></i>';
         	var nodeStr='<li dataId='+ docId + ' dataPid='+ pid +' dataType='+docType +' dataPath="'+ path + '" dataName="'+docName+'"'+' class="second-listBox" onmousedown="docListOnMouseDown(this,event)"><div onclick="secondGetDoc(this)" class="filename pull-left">'+iconType + docName+'</div><div class="filedate pull-right">'+formatDate(latestEditTime)+'</div><div class="handle pull-right"><i class="glyphicon glyphicon-new-window" onclick="fx(this,event)"></i><i class="glyphicon glyphicon-download-alt" onclick="xz(this,event)"></i><i onclick="sc(this,event)" class="glyphicon glyphicon-trash"></i><i onclick="showContextMenu(this,event)" class="glyphicon glyphicon-list"></i></div></li>';
         	$("#secondList").append(nodeStr);
		}

    	//Delete Node
		function deleteNode(docId)
		{
    		var obj = $("[dataId='"+ docId +"']");
    		if(obj)
    		{
    			obj.remove();
    		}
		}
    	
    	//Rename Node
		function renameNode(docId, newDocId, newName)
		{
    		var obj = $("[dataId='"+ docId +"']");
    		if(obj)
    		{
    			obj.attr("dataId", newDocId);
	    		obj.attr("dataName",newName);
				var domObj = obj.children("div").get(0);
				var firstDivObj = $(domObj);
				firstDivObj.text(newName);
    		}
		}
		
		//Delete Node
		function focusNode(docId)
		{
			var obj = $("[dataId='"+ docId +"']");
			if(obj)
			{
				obj.focus();
			}
		}

    	//开放给外部的调用接口
        return {
        	showList: function(data){
        		showList(data);
            },
    		isNodeExists: function (docId)
    		{
    			return isNodeExists(docId);	
    		},
    		addNode: function(docId, pid, docType, path, docName, latestEditTime){
        		addNode(docId, pid, docType, path, docName, latestEditTime);
            },
            deleteNode: function(docId){
            	deleteNode(docId);
            },
            renameNode: function(docId, newDocId, newName){
            	renameNode(docId, newDocId, newName);
            },
            focusNode: function(docId){
            	focusNode(docId);
            },
        };
    })();		
      		
	var curRightClickedDocListNode = null;
    function docListOnMouseDown(obj,ev)
    {
   	 	var docId = $(obj).attr('dataId');
   	 	var pid = $(obj).attr('dataPid');
   	 	var path = $(obj).attr('dataPath');
   	 	var name = $(obj).attr('dataName');
   	 	var type = $(obj).attr('dataType');
   	 	var latestEditTime = $(obj).attr('latestEditTime');
	 	
   	 	var node = {};
   	 	node.vid = gReposId;
   	 	node.id = docId;
   	 	node.pid = pid;
   		node.path = path;
   		node.name = name;
   		node.type = type;
   		node.latestEditTime = latestEditTime;
   		
   		curRightClickedDocListNode = node;
	 	console.log("docListOnMouseDown on doc:",curRightClickedDocListNode);
    }
	
 	function secondGetDoc(obj){
   	 	var docId = $(obj).attr('dataId');
   	 	var pid = $(obj).attr('dataPid');
   	 	var path = $(obj).attr('dataPath');
   	 	var name = $(obj).attr('dataName');
   	 	var type = $(obj).attr('dataType');
   	 	var latestEditTime = $(obj).attr('latestEditTime');
	 	
   	 	var node = {};
   	 	node.vid = gReposId;
   	 	node.id = docId;
   	 	node.pid = pid;
   		node.path = path;
   		node.name = name;
   		node.type = type;
   		node.latestEditTime = latestEditTime;
 		
 		console.log("secondGetDoc node:", node);
 		
 		if(gDocId != docId)
 		{
	 		//Change curent gDocId to docId
		 	gDocId = docId;
 		}
		
 		var treeNode = getNodeByNodeId(docId);
		if(treeNode == null)
		{
			console.log("node was not exists in current zTree, syncUpMenu" + gDocId);
			syncUpMenu();
	 		showDocList(null);
		}
		else
		{
			var zTree = $.fn.zTree.getZTreeObj("doctree");
			//select this node in zTree
		 	zTree.selectNode(treeNode);
				
			if(type == 1)	//For File, show RightDiv
		 	{
		 		showRightDiv();
		 	}
		 	else
		 	{
		 		//Open the dir in zTree
				zTree.reAsyncChildNodes(treeNode, "refresh",true);
		      		
		 		//show DocList under this dir
		 		showDocList(treeNode);
		 	}
		
			//显示预览或备注
			showVirtualDoc(treeNode,false);
		}		
  	}
 	
 	function fx(obj,event){
 		var id = $(obj).parents('li').attr('dataId');
 		//alert('分享'+id);
 		
 		var vid = gReposId;
 		var href = "/DocSystem/web/project.html?vid="+vid+"&doc="+id;
 		console.log(href);
 		var host = window.location.host;	//域名带端口
 		var url = host+href;
 		console.log(url);
 		var obj=document.getElementById("copiedText");
 		obj.value=url;	//修改其中的值
 		obj.select(); // 选择对象
 		document.execCommand("Copy"); // 执行浏览器复制命令
 	    // 普通消息提示条
 		bootstrapQ.msg({
 			msg : '链接已复制！',
 			type : 'success',
 			time : 1000,
 		});
 		
 		event.stopPropagation();
 	}
 	
 	function xz(obj,event){
   	 	var docId = $(obj).attr('dataId');
   	 	var pid = $(obj).attr('dataPid');
   	 	var path = $(obj).attr('dataPath');
   	 	var name = $(obj).attr('dataName');
   	 	var type = $(obj).attr('dataType');
	 	
   	 	var node = {};
   	 	node.vid = gReposId;
   	 	node.id = docId;
   	 	node.pid = pid;
   		node.path = path;
   		node.name = name;
   		node.type = type;
   		
 		downloadDoc(node,true);
 		event.stopPropagation();
 	}
 	
 	function sc(obj,event){
   	 	var docId = $(obj).attr('dataId');
   	 	var pid = $(obj).attr('dataPid');
   	 	var path = $(obj).attr('dataPath');
   	 	var name = $(obj).attr('dataName');
   	 	var type = $(obj).attr('dataType');
	 	
   	 	var node = {};
   	 	node.vid = gReposId;
   	 	node.id = docId;
   	 	node.pid = pid;
   		node.path = path;
   		node.name = name;
   		node.type = type;
 		
		var deleteNodes = [];
		deleteNodes.push(node);
		DoDelete(deleteNodes);
		event.stopPropagation();
 	}
 	
 	function showContextMenu(obj,event){
 		event.stopPropagation();
 		var xOffset = 0;
 		if(gIsPC == false)
 		{
 			xOffset = -120;	
 		}
 		context.show('#secondList',event,xOffset);
 	}
 	
 	function formatDate(date) {
 		var now = new Date(date);
 		var year=now.getFullYear(); 
 		var month=now.getMonth()+1;
 		var date=now.getDate(); 
 		return year+"-"+month+"-"+date; 
 	}
 	
 	function formatTime(time){
 		var now = new Date(time);
 		var year=now.getFullYear(); 
 		var month=now.getMonth()+1;
 		var date=now.getDate(); 
 		var hh=now.getHours(); 
 		var mm=now.getMinutes(); 
 		var ss=now.getSeconds(); 
 		
 		return year+"-"+month+"-"+date + " " + hh+":"+mm+":"+ss; 
 	}
 	
 	//ShowDoc 需要在zTree初始化完之后才能调用
	function showDoc(docId)
	{
		console.log("showDoc docId:" + docId);
		if(docId && docId != null)
		{
			 //select the zTreeNode with gDocId
			 var zTree = $.fn.zTree.getZTreeObj("doctree");
			 var node = zTree.getNodeByParam("id",docId);
			 if(node != null)
			 {
				 zTree.selectNode(node);
			
				//showDocList
				var parentNode = node.getParentNode();
				showDocList(parentNode);
			 
				//获取DocContent并显示
				showVirtualDoc(node,gEdit);
			 }
			 else
			 {
				 showDocList(null);
			 }
	   	}
		else
		{
			 showDocList(null);
		}
	}
	
	function showDocList(parentNode)
	{
		console.log("showDocList() parentNode:", parentNode);
		var pid = 0;
		var level = 0;
		var path = "";
		var name = "";
    
		if(parentNode &&  parentNode != null)
		{
	    	pid = parentNode.id;
	    	level = parentNode.level;
	    	path = parentNode.path;
	    	name = parentNode.name;
	    }
	    	
		//Set DocListState and DocListParentDocId
	    DocListState = 0;
	    DocListParentDocId = pid;
			
		$.ajax({
            url : "/DocSystem/Repos/getSubDocList.do",
            type : "post",
            dataType : "json",
            data : {
                vid: gReposId,
                docId: pid,
                level: level,
                path: path,
                name: name,
            },
            success : function (ret) {
         		console.log("showDocList ret:", ret)
         		if(ret.status == "ok")
            	{
         			DocList.showList(ret.data);
                }
                else
                {
                	showErrorMessage("获取子目录错误:" + ret.msgInfo);
                }
            },
            error : function () {
            	showErrorMessage('服务器异常: 获取子目录异常');
            }
        });
	}
	
	function backToParentDoc()
	{
		console.log("backToParentDoc() gDocId:" + gDocId);
		var zTree = $.fn.zTree.getZTreeObj("doctree");
		var node = zTree.getNodeByParam("id",gDocId);
		
		//current Doc not exists, update gDocId and URL and showDocList under root dir
		if(node == null)
		{
			console.log("backToParentDoc node not exist:" + gDocId);
			gDocId = undefined;
			//Show DocList
			showDocList(null);
		}
		else
		{
			var parentNode = node.getParentNode();
			console.log("backToParentDoc parentNode:" + parentNode);
			if(parentNode && parentNode.id)
			{
				zTree.selectNode(parentNode);
				gDocId = parentNode.id;
				showDocList(parentNode);
			}
			else
			{
				zTree.cancelSelectedNode(node);
				gDocId = undefined;
				
				var searchWord = $("#searchWord").val();
				console.log("backToParentDoc searchWord:" + searchWord);
				if(!searchWord || searchWord == "")
				{
					//如果searchBox is empty
					showDocList(null);
				}
				else
				{
					searchDoc();
				}
			}
		}
		
		//update URL
		updateUrl(gReposId,gDocId);

		//Update doc preview zone
		showVirtualDoc(parentNode,false);
		return;
   	}         
	
	//回车键监听函数，该event已经过兼容性处理 
	function EnterKeyListenerForSearchDoc(event){
		console.log("enter key listener for SearchDoc");
		if (event.keyCode == 13){  
			var isFocus=$("#searchWord").is(":focus");  
			if(isFocus)
			{
				searchDoc();
			}
	 	}  
	}
	
	function searchDoc()
	{
		var searchWord = $("#searchWord").val();
		var sort = "";
	
		var pDocId = 0;
		var parentPath = "";
		var node = getParentNodeByNodeId(gDocId);
		if(node != null)
		{
			pDocId = node.id;
			parentPath = node.path + node.name;
		}
		
		//当前默认总是根目录下
		pDocId = 0;
		parentPath = "";
		
       	$.ajax({
               url : "/DocSystem/Doc/searchDoc.do",
               type : "post",
               dataType : "json",
               data : {
                   searchWord:searchWord,
                   sort:sort,
                   reposId: gReposId,
                   pid: pDocId,
         		   path: parentPath,
               },
               success : function (ret) {
            		console.log("searchDoc ret:", ret)
            		if(ret.status == "ok")
               		{
            			//Set it as search result
            			DocListState = 1;
            			DocListParentDocId = -1;
            			DocList.showList(ret.data);
               			console.log("文件搜索成功");
                   	}
                   	else
                   	{
                   		showErrorMessage("文件搜索出错:" + ret.msgInfo);
                   	}
               },
               error : function () {
                   alert('服务器异常: 搜索文件异常');
               }
           });
	}
	
	function previewDoc()
	{
		console.log("previewDoc gDocId:" + gDocId);
		if(gDocId)
		{
			var node = getNodeByNodeId(docId);
			doPreviewDoc(node);
		}
	}
	
	function doPreviewDoc(node)
	{
		if(!node || node == null)
		{
			showErrorMessage("请选择文件!");
			return;
		}
		
		var docId = node.id;
		var pid = node.pid;
		var path = node.path;
		var name = node.name;
		
		//Convert doc to PDF and return the link, then show the pdf 
	    $.ajax({
	        url : "/DocSystem/Doc/DocToPDF.do",
	        type : "post",
	        dataType : "json",
	        data : {
	        	reposId: gReposId,
	            docId : docId,
	            pid: pid,
	            path: path,
	            name: name,
	        },
	        success : function (ret) {
	            if( "ok" == ret.status ){
	                var fileLink = ret.data;
	                console.log("fileLink" + fileLink);
	    			//在新的页面打开
	    			window.open("/DocSystem/web/viewDoc.html?fileLink=" + fileLink); 
	            }
	            else
	            {
	            	showErrorMessage("文件预览失败：" + ret.msgInfo);              	
	            }
	        },
	        error : function () {
	            showErrorMessage("文件预览失败：服务器异常");
	        }
	    });
	}
	
	function WikiEditBtnCtrl(edit)
	{
		 if(edit)
	   	 {
	      	$("#btnExitEdit").show();
	      	$("#btnSaveWiki").show();  
	      	$("#btnEditWiki").hide();
	      	//$("#btnViewDoc").hide();
	     }
	     else
	     {
		    $("#btnExitEdit").hide();
	      	$("#btnSaveWiki").hide(); 
	      	$("#btnEditWiki").show();
	      	//$("#btnViewDoc").show();
	     }
	}
	/************************** contextMenu 接口***************************/	
	//Get Node by NodeId
	function getNodeByNodeId(nodeId)
	{
		var zTree = $.fn.zTree.getZTreeObj("doctree");
		var node = zTree.getNodeByParam("id",nodeId);
		return node;
	}
	
	//Get NodeId by Node
	function getNodeIdByNode(node)
	{
		if(node && node.id)
		{
			return node.id;
		}
		return 0;
	}
	
	//Get ParentNode of Node(zTree)
	function getParentNodeByNode(node)
	{
		console.log("getParentNodeByNode",node);
     	//Get ParentNode
		var parentNode = node;
		if(node && node.isParent === false)
		{
			parentNode = node.getParentNode();
		}
		return parentNode;
	}
	
	//Get ParentNode of NodeId(zTree)
	function getParentNodeByNodeId(nodeId)
	{
		console.log("getParentNodeByNodeId" + nodeId);
		var node = getNodeByNodeId(nodeId);
     	return getParentNodeByNode(node);
	}
	
	//Get ParentNodeId of Node(zTree)
	function getParentNodeIdByNode(node)
	{
		var parentNode = getParentNodeByNode(node);
     	return getNodeIdByNode(parentNode);
	}
	
	//Get ParentNodeId of NodeId(zTree)
	function getParentNodeIdByNodeId(nodeId)
	{
		console.log("getParentNodeByNodeId" + nodeId);
		var node = getNodeByNodeId(nodeId);
     	var parentNode = getParentNodeByNode(node);
     	return getNodeIdByNode(parentNode);
	}
	
	//add a new Doc
	function newDocEx(type)
	{
		var parentNode = getParentNodeByNodeId(gDocId);
		newDoc(type,parentNode);
	}
	
	//add a new Doc: type 1: 文件  2:目录
    function newDoc(type,parentNode) {         
		//计算 parentId remoteDir
		var parentId = 0;
		if(parentNode && parentNode.id)
		{
			parentId = parentNode.id;
		}
		var remoteDir = gReposName+ "::" + getNodePath(parentNode); //only for display
        
        //对话框 title
        var title = "新建文件";
        if(type == 2)
        {
        	title = "新建目录";
        }
          
        //显示新建对话框
        qiao.bs.dialog({
              id: "dialog-new-doc",
              url: '#new-doc',
              title: title,
              okbtn: "确定",
              qubtn: "取消",
              callback: function () {
                      $("#dialog-new-doc input[name='name']").focus();
                      $("#dialog-new-doc input[name='remoteDir']").val(remoteDir);                
              }
        },function () {

              var name = $("#dialog-new-doc input[name='name']").val();
              var content = $("#dialog-new-doc input[name='content']").val();
			  //检查当前目录下是否有同名文件
			  if(isNodeExist(name,parentNode) == true)
			  {	
				showErrorMessage(name + " 已存在");
			  	return false;
			  }
			  var vid = gReposId;
			  
			  //发送新建文件请求到后台
              if( name ){
            	  if(content && content != "")
            	  {
            		  content = "#" + content; 
            	  }
                  addDoc(name,type,content,parentNode,parentId,vid);
                  return true;
              }else{
              	  alert("文件名不能为空");
                  return false;
              }
          });
   	}
	
	//显示文件详情
	function showDocDetail(node)
	{
		if(!node || node == null)
		{
			showErrorMessage("请选择文件！");
			return;
		}
		
        //To get DocInfo
    	$.ajax({
            url : "/DocSystem/Doc/getDoc.do",
            type : "post",
            dataType : "json",
            data : {
            	reposId: gReposId,
                docId : node.id,
                pid: node.pid,
                path: node.path,
                name: node.name,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                	var doc = ret.data;
                	
                    //对话框 title
                    var title = "详细信息";
                              
                    var createTime = formatTime(doc.createTime);  
                    var lastEditTime = formatTime(doc.latestEditTime);  
                    
                    //显示新建对话框
                    qiao.bs.dialog({
                          id: "dialog-doc-detail",
                          url: '#doc-detail',
                          title: title,
                          okbtn: "确定",
                          callback: function () {
                                  $("#dialog-doc-detail input[name='name']").val(doc.name);
                                  $("#dialog-doc-detail input[name='size']").val(doc.size);               
                                  $("#dialog-doc-detail input[name='position']").val(doc.path);                
                                  $("#dialog-doc-detail input[name='createTime']").val(createTime);                
                                  $("#dialog-doc-detail input[name='latestEditTime']").val(lastEditTime);                
                          }
                    },function(){
                    	return true;
                    });		                    
                }
                else
                {
                	showErrorMessage("获取文件信息失败：" + ret.msgInfo);              	
                }
            },
            error : function () {
                showErrorMessage("获取文件信息失败：服务器异常");
                $btn.button('reset');
            }
        });
	}	
    
    //ShowCenter: hide left and right
    function showCenterDiv(){
    	if(gIsPC)
    	{
    		return;
    	}
    	
        var oDiv=document.getElementById('line');
        oDiv.style.left=0;	//设置Line的位置
        $(".manual-left")[0].style.width=0;
        $(".manual-left")[0].style.display="none";
        $(".second-table").css("left",$("#line").width());
        $(".second-table")[0].style.width=372+'px';
        $(".second-line").css("left",$(".manual-left").width()+$(".second-table").width()+$("#line").width());
        $(".manual-right")[0].style.left=$(".manual-left").width()+$(".second-table").width()+3+'px';
    }
    
    //ShowRight
	function showRightDiv(){
    	if(gIsPC)
    	{
    		return;
    	}
    	
    	$(".second-table")[0].style.width=0;
        //$(".second-table")[0].style.display="none";
        $(".second-line").css("left",0);
        $(".manual-right")[0].style.left=2+'px';
    }
    
	//Confirm if it is PC
	var gIsPC = true;
	function isPC() {
	    var userAgentInfo = navigator.userAgent;
	    var Agents = ["Android", "iPhone",
	                "SymbianOS", "Windows Phone",
	                "iPad", "iPod"];

	    for (var v = 0; v < Agents.length; v++) {
	        if (userAgentInfo.indexOf(Agents[v]) > 0) {
	            return false;
	        }
	    }
	   	return true;
	}
    
    function isWeiXin(){ 
        var ua = navigator.userAgent.toLowerCase(); 
        if(ua.indexOf('micromessenger') != -1) { 
            return true; 
        } else { 
            return false; 
        } 
    }
    
	//LockDoc and Download it
	function checkOut(node)
	{
		console.log("checkOut()", node);
		if(!node || node == null)
		{
			showErrorMessage("请选择文件！");
			return;
		}
		
		var docId = node.id;
		var pid = node.pid;
		var path = node.path;
		var name = node.name;
		$.ajax({
			url : "/DocSystem/Doc/lockDoc.do",
			type : "post",
			dataType : "json",
			data : {
				lockType : 1, //lockType: CheckOut
				reposId : vid, 
				docId : docId,
				pid: pid,
				path: path,
				name: name,
			},
			success : function (ret) {
				if( "ok" == ret.status){
					console.log(ret.data);
					$("[dataId='"+ docId +"']").children("div:first-child").css("color","red");
				    downloadDoc(node,false);
				    return;
 				}
				else
				{
					showErrorMessage("checkOut Error:" + ret.msgInfo);
					return;
				}
			},
			error : function () 
			{
				showErrorMessage("checkOut 异常");
				return;
			}
		});
	}
	
	//UnlockDoc and Upload doc
	var curCheckInDoc = [];
	function checkIn(docId,docName)
	{
		console.log("checkIn()" + docId);
		curCheckInDoc.id = docId;
		curCheckInDoc.name = docName;
		
		gParentNodeForUpload = getParentNodeByNodeId(docId);
		checkInFile();
		return;
 	}
    
	//目录列表区域拖放功能：预览区和子目录区域需要一起变化
    var oDiv=document.getElementById('line');
    oDiv.onmousedown=function(ev){
      var disX=ev.clientX-oDiv.offsetLeft;
      var disY=ev.clientY-oDiv.offsetTop;

      document.onmousemove=function(ev){
          var l=ev.clientX-disX;	//计算Line的位置
          oDiv.style.left=l+'px';	//设置Line的位置
          
     	  $(".manual-left")[0].style.width=ev.clientX+'px';
       	  $(".manual-right")[0].style.left=ev.clientX+$(".second-table").width()+3+'px';
       	  $(".second-table").css("left",$(".manual-left").width()+$("#line").width());
       	  $(".second-line").css("left",ev.clientX+$(".second-table").width()+$("#line").width());
   	  };
      
      document.onmouseup=function(ev){
   	  	//$(".manual-left")[0].style.width=ev.clientX+'px';
   	 	//$(".manual-right")[0].style.left=ev.clientX+'px';
   	 	document.onmousemove=null;
   	  	document.onmouseup=null;
      };
    };
    
    var oDiv2=document.getElementById('second-line');
    oDiv2.onmousedown=function(ev){
        var disX=ev.clientX-oDiv2.offsetLeft;
        var disY=ev.clientY-oDiv2.offsetTop;
   
       document.onmousemove=function(ev){
       		var l=ev.clientX-disX;	//计算Line的位置
           oDiv2.style.left=l+'px';	//设置Line的位置
           $('.second-table').width($(".second-line").position().left-$('.manual-left').width());
           $(".manual-right").css("left",$(".second-table").width()+$('.manual-left').width()+3);
           return false;
   	  };
    	  document.onmouseup=function(ev){
    	 	document.onmousemove=null;
    	  	document.onmouseup=null;
        };
    };
    //页面加载完成处理函数    
    $(document).ready(function(){
        //Confirm if it is PC
    	if(true == isPC())
        {	
        	gIsPC = true;
    	    console.log("It is PC");
        }
        else
        {
        	gIsPC = false;
    	    console.log("It is MP");
    	    showCenterDiv();
        }
    	
    	//初始化全局变量
    	gReposId = getQueryString("vid");
		gDocId = getQueryString("doc");
		gParentPath = getQueryString("path");
		gDocName = getQueryString("name");
		gEdit = getQueryString("edit");
		if(!gEdit)
		{
			gEdit = false;
		}
		
		console.log("before decode gParentPath:" + gParentPath + " gDocName:" + gDocName);
		
		if(gParentPath && gParentPath != null)
		{
			gParentPath = Base64.decode(gParentPath);
		}
		else
		{
			gParentPath = "";
		}
		if(gDocName && gDocName != null)
		{
			gDocName = Base64.decode(gDocName);
		}
		else
		{
			gDocName = "";
		}
		
		console.log("after decode gParentPath:" + gParentPath + " gDocName:" + gDocName);
    	
		
    	console.log("ready() gReposId:" + gReposId  + " gDocId:"+gDocId + " gParentPath:" + gParentPath + " gDocName:" + gDocName + " gEdit:" + gEdit);
    	
    	//处于编辑状态下，需要禁用删除和改名等所有编辑操作，避免出错
        if( gEdit ){
            var edit = {};
            setting.edit = edit;
        }
        //设置异步加载的参数
        var async =  {  
    		enable : true,//设置 zTree 是否开启异步加载模式  
            url : "/DocSystem/Repos/getSubDocList.do",
            type : "post",
    		autoParam : ["id","level","path","name"],//异步加载时需要自动提交父节点属性的参数  
    		otherParam:{
    			"vid":gReposId,
    		},
    		dataFilter: asyncDataFilter, 
		};
		setting.async = async;
        
      	//拖拽上传:目录树区域
    	var uuz = document.getElementById("uuz");  
    	uuz.ondragenter = function(e){  
            e.preventDefault();  
        };  
        uuz.ondragover = function(e){  
            e.preventDefault();
            //判断现在所在的zTree Node并选中它
            if(e.target.tagName=="SPAN"){
            	e.target.parentNode.click();
            }
        };  
        uuz.ondrop = function(e){   
            console.log("uuz.ondrop() event:",e);
        	e.preventDefault();
    	  	
        	//If File drop on the zTree Item, trigger the click event on it
    	  	console.log("uuz.ondrop() e.target:",e.target);
            if(e.target.tagName=="SPAN"){
            	e.target.parentNode.click();
            }
            
            //Choose the selectNode as the place for upload
    	  	var treeObj = $.fn.zTree.getZTreeObj("doctree");
    		var selectedNode = treeObj.getSelectedNodes()[0];
    		console.log("uuz.ondrop() selectedNode",selectedNode);
    		var parentNode = selectedNode;
    		if(selectedNode && selectedNode.isParent === false)
    		{	
    			console.log("uuz.ondrop() selectedNode:" + selectedNode.name);
    			parentNode = selectedNode.getParentNode();
    		}
    		console.log("uuz.ondrop() parentNode:" + parentNode);
            dragUploadConfirm(e,parentNode);
        };
        
    	//拖拽上传:子目录区域
    	//目标目录是当前选中的Doc
    	var docListZone = document.getElementById("secondDropZone");  
    	docListZone.ondragenter = function(e){  
            e.preventDefault();  
        };  
        docListZone.ondragover = function(e){  
            e.preventDefault();
        };  
        docListZone.ondrop = function(e){   
            e.preventDefault();
    	  	//get the parentNode
    	  	var treeObj = $.fn.zTree.getZTreeObj("doctree");
    		var selectedNode = treeObj.getSelectedNodes()[0];
    		console.log(selectedNode);
    		var parentNode = selectedNode;
    		if(selectedNode && selectedNode.isParent === false)
    		{	
    			console.log("selectedNode:" + selectedNode.name);
    			parentNode = selectedNode.getParentNode();
    		}
            dragUploadConfirm(e,parentNode);
        };
        
        //文件预览区的拖拽上传
        var docZone =  document.getElementById("doc");  
        docZone.ondragenter = function(e){  
            e.preventDefault();  
        };  
        docZone.ondragover = function(e){  
            e.preventDefault();  
        };  
        docZone.ondrop = function(e){   
            e.preventDefault();
    	  	//get the parentNode
    	  	var treeObj = $.fn.zTree.getZTreeObj("doctree");
    		var selectedNode = treeObj.getSelectedNodes()[0];
    		console.log(selectedNode);
    		var parentNode = selectedNode;
    		if(selectedNode && selectedNode.isParent === false)
    		{	
    			console.log("selectedNode:" + selectedNode.name);
    			parentNode = selectedNode.getParentNode();
    		}
            dragUploadConfirm(e,parentNode);
        };

		//set the vid in upload form
		$("#reposId").val(gReposId);
        
		//系统初始化
		SysInit();
		
		//右键菜单实现：contextMenu Start
		context.init({preventDoubleContext: true});
		
		//zTree外部的右键菜单
		context.attach('#treeBody', [
			{text: '新建', subMenu: [
				{text: '文件',  action: function(e){
						e.preventDefault();
						curRightClickedTreeNode = null; 
						var parentNode = getParentNodeByNode(null);
	        			newDoc(1,parentNode);
					}
				},
				{text: '文件夹',  action: function(e){
						e.preventDefault();
	        			curRightClickedTreeNode = null;
	        			var parentNode = getParentNodeByNode(null);
	        			newDoc(2,parentNode);
					}
				},
				]
			},
			{text: '上传', subMenu: [
				{text: '文件',  action: function(e){
						e.preventDefault();
						curRightClickedTreeNode = null;
					    gParentNodeForUpload = null;	//uploadFiles is the trigger, so need to save the destination dir to gVar
					  	uploadFiles();
					}
				},
				{text: '文件夹',  action: function(e){
						e.preventDefault();
						curRightClickedTreeNode = null; 
					    gParentNodeForUpload = null;	//uploadFiles is the trigger, so need to save the destination dir to gVar
						uploadDir();
					}
				},	
				]
			},
			{divider: true},
			{text: '粘贴', action: function(e){
						e.preventDefault();
						curRightClickedTreeNode = null; 
						DoPaste(gCopiedNodes,null);
					}
			},
			{divider: true},
			{text: '更多...', subMenu: [
						{text: '查看仓库历史', action: function(e){
									e.preventDefault();
									curRightClickedTreeNode = null; 
				        			showDocHistory(null,0);
								}
						},
						{text: '查看备注历史', action: function(e){
							e.preventDefault();
							curRightClickedTreeNode = null; 
		        			showDocHistory(null,1);
						}
				},
   				]
   			},
			]
		);
		//zTree上的右键菜单
		context.attach('#tree', [
			{text: '新建', subMenu: [
				{text: '文件',  action: function(e){
						e.preventDefault();
						var parentNode = getParentNodeByNode(curRightClickedTreeNode);
						newDoc(1,parentNode);
					}
				},
				{text: '文件夹',  action: function(e){
						e.preventDefault();
						var parentNode = getParentNodeByNode(curRightClickedTreeNode);
						newDoc(2,parentNode);
					}
				},
				]
			},
			{text: '上传', subMenu: [
				{text: '文件',  action: function(e){
						e.preventDefault();
						gParentNodeForUpload = getParentNodeByNode(curRightClickedTreeNode);	//uploadFiles is the trigger, so need to save the destination dir to gVar
						uploadFiles();
					}
				},
				{text: '文件夹',  action: function(e){
						e.preventDefault();
						gParentNodeForUpload = getParentNodeByNode(curRightClickedTreeNode);	//uploadFiles is the trigger, so need to save the destination dir to gVar
						uploadDir();
					}
				},	
				]
			},
			{divider: true},
			{text: '复制', action: function(e){
						e.preventDefault();
						gCopiedNodes = getCopiedNodes();
						console.log("gCopiedNodes",gCopiedNodes);
					}
			},
			{text: '粘贴', action: function(e){
						e.preventDefault();
						var parentNode = getParentNodeByNode(curRightClickedTreeNode);
						DoPaste(gCopiedNodes,parentNode);
					}
			},
			{divider: true},
			{text: '重命名', action: function(e){
						e.preventDefault();
						 var treeObj = $.fn.zTree.getZTreeObj("doctree");
						if(curRightClickedTreeNode !== null)
						{
							showRenameDialog(curRightClickedTreeNode);
							//treeObj.editName(curRightClickedTreeNode);
							curRightClickedTreeNode = null;
	        			}
					}
			},
			{text: '删除', action: function(e){
						e.preventDefault();
						var treeObj = $.fn.zTree.getZTreeObj("doctree");
						var deleteNodes = getDeleteNodes();
						DoDelete(deleteNodes);
					}
			},
			{divider: true},
			{text: '预览', action: function(e){
					e.preventDefault();
					doPreviewDoc(curRightClickedTreeNode);
				}
			},
			{text: '下载', action: function(e){
						e.preventDefault();
						downloadDoc(curRightClickedTreeNode,true);
					}
			},
			{text: '详细信息', action: function(e){
					e.preventDefault();
					if(curRightClickedTreeNode == null)
					{
						bootstrapQ.alert("请选择需要文件或目录");
						return false;
					}
					showDocDetail(curRightClickedTreeNode);
				}
			},
//			{text: '备注', action: function(e){
//					e.preventDefault();
//					var docId = curRightClickedTreeNode.id;
//					var docName = curRightClickedTreeNode.name;
//		 			showVirtualDoc(docId,false);
//		 			showRightDiv();
//				}
//			},
			{divider: true},
			{text: '更多...', subMenu: [
			           	{text: '复制名字', action: function(e){
									e.preventDefault();
				        			copyDocName(curRightClickedTreeNode);
								}
						},
						{text: '复制路径', action: function(e){
									e.preventDefault();
				        			copyDocPath(curRightClickedTreeNode);
								}
						},
						{text: '复制链接', action: function(e){
									e.preventDefault();
				        			copyUrl(curRightClickedTreeNode);
								}
						},	
						{divider: true},
						{text: 'CheckOut', action: function(e){
								e.preventDefault();
								var docType = curRightClickedDocListNode.type;
								if(docType == 1)
								{							
									var docId = curRightClickedTreeNode.id;
									var docName = curRightClickedTreeNode.name;
									checkOut(docId,docName);
								}
							}
						},
						{text: 'CheckIn', action: function(e){
								e.preventDefault();
								var docId = curRightClickedTreeNode.id;
								var docName = curRightClickedTreeNode.name;
					 			checkIn(docId,docName);
							}
						},
						{divider: true},
						{text: '查看历史', action: function(e){
									e.preventDefault();
				        			showDocHistory(curRightClickedTreeNode,0);
								}
						},
						{text: '查看备注历史', action: function(e){
								e.preventDefault();
		        				showDocHistory(curRightClickedTreeNode,1);
							}
						},
   				]
   			},
		]);
		
		//secondList上的右键菜单
		context.attach('#secondList', [
			{text: '新建', subMenu: [
				{text: '文件',  action: function(e){
						e.preventDefault();
						var parentNode = getParentNodeByNodeId(gDocId);
	        			newDoc(1,parentNode);
					}
				},
				{text: '文件夹',  action: function(e){
						e.preventDefault();
						var parentNode = getParentNodeByNodeId(gDocId);
	        			newDoc(2,parentNode);
					}
				},
				]
			},
			{text: '上传', subMenu: [
				{text: '文件',  action: function(e){
						e.preventDefault();
						var node = getNodeByNodeId(gDocId);
						gParentNodeForUpload = getParentNodeByNode(node);
	        			uploadFiles();
					}
				},
				{text: '文件夹',  action: function(e){
						e.preventDefault();
						var node = getNodeByNodeId(gDocId);
						gParentNodeForUpload = getParentNodeByNode(node);
	        			uploadDir();
					}
				},	
				]
			},
			{divider: true},
			{text: '复制', action: function(e){
						e.preventDefault();
						var docId = curRightClickedDocListNode.docId;
						var node = getNodeByNodeId(docId);
						gCopiedNodes = [];
						if(node != null)
						{
							gCopiedNodes.push(node);
						}
						console.log("gCopiedNodes",gCopiedNodes);
					}
			},
			{text: '粘贴', action: function(e){
						e.preventDefault();
						var node = getNodeByNodeId(gDocId);
						DoPaste(gCopiedNodes,node);
					}
			},
			{divider: true},
			{text: '重命名', action: function(e){
						e.preventDefault();
						var docId = curRightClickedDocListNode.docId;
						var node = getNodeByNodeId(docId);
						if(node !== null)
						{
							showRenameDialog(node);
	        			}
					}
			},
			{text: '删除', action: function(e){
						e.preventDefault();
						console.log(e);
						var deleteNodes = [];
						deleteNodes.push(curRightClickedDocListNode);
						DoDelete(deleteNodes);
					}
			},
			{divider: true},
			{text: '预览', action: function(e){
						e.preventDefault();
						doPreviewDoc(curRightClickedDocListNode);
					}
			},
			{text: '下载', action: function(e){
					e.preventDefault();
					downloadDoc(curRightClickedDocListNode,true);
				}
			},
			{text: '详细信息', action: function(e){
					e.preventDefault();
					showDocDetail(curRightClickedDocListNode);
				}
			},
			{divider: true},
			{text: '备注', action: function(e){
					e.preventDefault();
		 			showVirtualDoc(curRightClickedDocListNode,false);
		 			showRightDiv();
				}
			},
			{divider: true},
			{text: '更多...', subMenu: [
			           	{text: '复制名字', action: function(e){
									e.preventDefault();
									var docId = curRightClickedDocListNode.docId;
									var node = getNodeByNodeId(docId);
				        			copyDocName(node);
								}
						},
						{text: '复制路径', action: function(e){
									e.preventDefault();
									var docId = curRightClickedDocListNode.docId;
									var node = getNodeByNodeId(docId);
				        			copyDocPath(node);
								}
						},
						{text: '复制链接', action: function(e){
									e.preventDefault();
									var docId = curRightClickedDocListNode.docId;
									var node = getNodeByNodeId(docId);
				        			copyUrl(node);
								}
						},	
						{divider: true},
						{text: 'CheckOut', action: function(e){
								e.preventDefault();
								var docType = curRightClickedDocListNode.type;
								if(docType == 1)
								{							
									var docId = curRightClickedDocListNode.docId;
									var docName = curRightClickedDocListNode.docName;
									checkOut(docId,docName);
								}
							}
						},
						{text: 'CheckIn', action: function(e){
								e.preventDefault();
								var docId = curRightClickedDocListNode.docId;
								var docName = curRightClickedDocListNode.docName;
					 			checkIn(docId,docName);
							}
						},
						{divider: true},
						{text: '查看历史', action: function(e){
									e.preventDefault();
									var docId = curRightClickedDocListNode.docId;
									var node = getNodeByNodeId(docId);
								    showDocHistory(node,0);
								}
						},
						{text: '查看备注历史', action: function(e){
								e.preventDefault();
								var docId = curRightClickedDocListNode.docId;
								var node = getNodeByNodeId(docId);
							    showDocHistory(node,1);
							}
						},
   				]
   			},
		]);
		
		context.settings({compress: true});
		
		$(document).on('mouseover', '.me-codesta', function(){
		$('.finale h1:first').css({opacity:0});
		$('.finale h1:last').css({opacity:1});
		});
	
		$(document).on('mouseout', '.me-codesta', function(){
			$('.finale h1:last').css({opacity:0});
			$('.finale h1:first').css({opacity:1});
		});
		//右键菜单实现：contextMenu End
    });
</SCRIPT>
</body>
</html>
