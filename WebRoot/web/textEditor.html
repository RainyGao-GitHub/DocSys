<script src="static/ace-builds/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css" media="screen">
  body {
      overflow: hidden;
  }

  #editor {
      margin: 39px 0 0 0;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
  }
</style>
<div id="textEditor">
	<div id="textEditorToolBar" style="height:40px;">
		<div class="editormd-toolbar" style="display: block;">
			<div class="editormd-toolbar-container">
				<ul id="toolBarMenu" class="editormd-menu" style="display:none;">
					<li><a href="javascript:;" onclick="TextEditor.saveDoc();" title="保存（Ctrl+S）" unselectable="on"><i class="fa fa-save" name="save" unselectable="on"></i></a></li>
					<li class="divider" unselectable="on">|</li>
					<li><a href="javascript:;" title="撤销（Ctrl+Z）" unselectable="on"><i class="fa fa-undo" name="undo" unselectable="on"></i></a></li>
					<li><a href="javascript:;" title="反撤销（Ctrl+Y）" unselectable="on"><i class="fa fa-repeat" name="redo" unselectable="on"></i></a></li>
					<li class="divider" unselectable="on">|</li>
				</ul>
				<ul id="switchEditMode" class="editormd-menu" style="position:absolute; right:5px;">
					<li id="textEditorCloseBtn" style="display:none;">
						<a href="javascript:;" onclick="TextEditor.exitEdit()" title="退出编辑" unselectable="on">
							<i class="fa fa-close" name="exitEdit" unselectable="on"></i>
						</a>
					</li>
					<li id="textEditorEditBtn" style="display:none;">
						<a href="javascript:;" onclick="TextEditor.enableEdit()" title="编辑" unselectable="on">
							<i class="fa fa-edit" name="edit" unselectable="on"></i>
						</a>
					</li>
				</ul>				
			</div>
		</div>
	</div>
	<div class="textEditorContent" style="min-height: 600px;">
		<pre id="editor">
		</pre>
	</div>
</div>

<script type="text/javascript">
var editor = ace.edit("editor");
editor.setTheme("ace/theme/Chrome");
editor.session.setMode("ace/mode/Plain");
editor.setReadOnly(true); // false to make it editable
	
var TextEditor = (function () {
    var docInfo = {};
	var docText = "";
	var tmpSavedDocText = "";
	var isContentChanged = false;
	
	function textEditorPageInit(Input_doc, Input_docText, Input_tmpSavedDocText)
	{
		console.log("textEditorPageInit InputDoc:", Input_doc);
		console.log("textEditorPageInit Input_docText:", Input_docText);
		docInfo = Input_doc;		
		docText = Input_docText;
		tmpSavedDocText = Input_tmpSavedDocText;		

		checkAndSetFileShowMode(docInfo);
		
		checkAndSetEditBtn(docInfo);
		
		showText(docText);
		
		editor.getSession().on('change', function(e) {
			isContentChanged = true;
		});
  	}
    
	function showText(content)
	{
		editor.setValue(docText);
	}
	    
    function saveDoc()
	{
    	console.log("saveDoc docInfo.docId:" + docInfo.docId);
		
    	if(isContentChanged == false)
    	{
    	   	console.log("saveDoc there is no change");
    		return;
    	}
    	
		var content = editor.getValue();
		$.ajax({
            url : "/DocSystem/Doc/updateDocContent.do",
            type : "post",
            dataType : "json",
            data : {
                reposId: gReposInfo.id,
            	docId : docInfo.docId,
            	path: docInfo.path,
                name: docInfo.name,
            	content : content,
            	docType: 1, //RealDoc
                shareId: gShareId,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                    console.log("保存成功 : " , (new Date()).toLocaleDateString());
                    docText = content;
                    isContentChanged = false;

                    bootstrapQ.msg({
								msg : "保存成功 :" + (new Date()).toLocaleDateString(),
								type : 'success',
								time : 1000,
					});
				}else {
                    bootstrapQ.alert("保存失败:"+ret.msgInfo);
                }
            },
            error : function () {
                bootstrapQ.alert("保存失败:服务器异常");
            }
        });
    }

    function enableEdit()
    {
		console.log("enableEdit()");
		if(!docInfo.docId || docInfo.docId == 0)
		{
			showErrorMessage("请选择文件!");
			return;
		}

		$.ajax({
			url : "/DocSystem/Doc/lockDoc.do",
			type : "post",
			dataType : "json",
			data : {
				lockType : 3, //LockType: Online Edit
				reposId : gReposInfo.id, 
				docId : docInfo.docId,
				path: docInfo.path,
				name: docInfo.name,
				docType: 1,
                shareId: gShareId,
			},
			success : function (ret) {
				if( "ok" == ret.status)
				{
					console.log("enableEdit() ret.data",ret.data);
					$("[dataId='"+ docInfo.docId +"']").children("div:first-child").css("color","red");

					//显示工具条和退出编辑按键
					switchEditMode(true);
					return;
 				}
				else
				{
					showErrorMessage("lockDoc Error:" + ret.msgInfo);
					return;
				}
			},
			error : function () 
			{
				showErrorMessage("lockDoc 异常");
				return;
			}
		});
    }
    
	//退出文件编辑状态
    function exitEdit() {   	
		console.log("exitEdit()  docInfo.docId:" + docInfo.docId);
		if(!docInfo.docId || docInfo.docId == 0)
		{
			showErrorMessage("文件不存在");
			switchEditMode(false);
			return;
		}
		
		$.ajax({
			url : "/DocSystem/Doc/lockDoc.do",
			type : "post",
			dataType : "json",
			data : {
				lockType : 0, //unlock the doc
				reposId : gReposInfo.id, 
				docId : docInfo.docId,
				path: docInfo.path,
				name: docInfo.name,
				docType: 1,
                shareId: gShareId,
			},
			success : function (ret) {
				if( "ok" == ret.status)
				{
					console.log("exitEdit() ret:",ret.data);
					$("[dataId='"+ docInfo.docId +"']").children("div:first-child").css("color","black");
					switchEditMode(false);
					return;
 				}
				else
				{
					showErrorMessage("exitEdit() unlockDoc Error:" + ret.msgInfo);
					return;
				}
			},
			error : function () 
			{
				showErrorMessage("exitEdit() unlockDoc 异常");
				return;
			}
		});
	}

	function switchEditMode(edit)
	{
		if(edit == true)
		{
			//显示工具条
			$("#toolBarMenu").show();
			
			//显示退出编辑按键
			$("#textEditorCloseBtn").show();
			
			//隐藏编辑按键
			$("#textEditorEditBtn").hide();

			//Enable Edit
			editor.setReadOnly(false);
		}
		else
		{
			//隐藏工具条
			$("#toolBarMenu").hide();
			
			//隐藏退出编辑按键
			$("#textEditorCloseBtn").hide();
		
			//显示编辑按键
			$("#textEditorEditBtn").show();			
			
			//Disable Edit
			editor.setReadOnly(true);
		}
	}
	
	function checkAndSetEditBtn(docInfo)
	{
		if(docInfo.fileSuffix)
		{
			switch(docInfo.fileSuffix)
			{
			case "md":
	    	case "cpp":
	    	case "hpp":
	    	case "c":
	    	case "h":
	    	case "java":
	    	case "py":
	    	case "go":
	    	case "js":
	    	case "css":
	    	case "html":
	    	case "json":
	    	case "sql":
	    	case "xml":
	    	case "php":
	    	case "sh":
	    	case "txt":
				$("#textEditorEditBtn").show();
	    		break;
			}
		}
	}
	
	function checkAndSetFileShowMode(docInfo)
	{
		var showMode = getFileShowMode(docInfo.name, docInfo.fileSuffix);
		editor.session.setMode("ace/mode/" + showMode);
	}

	function getFileShowMode(name, suffix)
	{	
        var showMode = fileIconTypeMap[name];
		if (undefined == showMode)
		{
			showMode = fileIconTypeMap[suffix];
			if(undefined == showMode)
			{
				return "Plain";
			}
		}
		
		return showMode;
	}
	
	
	
	var fileShowModeMap = {
			abap	:	"ABAP",
			abc		:	"ABC",
			as		:	"ActionScript",
			ada		:	"ADA",
			adb		:	"ADA",
    		htaccess:	"Apache_Conf",
    		htpasswd:	"Apache_Conf",
    		conf	:	"Apache_Conf",
    		htaccess:	"Apache_Conf",
    		htgroups:	"Apache_Conf",
    		htpasswd:	"Apache_Conf",
    		asciidoc:	"AsciiDoc",
    		adoc	:	"AsciiDoc",
    		dsl		:	"ASL",
    		asl		:	"ASL",
    		asm		:	"Assembly_x86",
    		ahk		:	"AutoHotKey",
    		apex	:	"Apex",
    		cls		:	"Apex",
    		trigger	:	"Apex",
    		tgr		:	"Apex",
    		aql		:	"AQL",
    		cmd		:	"BatchFile",
    		bat		:	"BatchFile",
    		cpp		:	"C_Cpp",
    		c		:	"C_Cpp",
    		cc		:	"C_Cpp",
    		cxx		:	"C_Cpp",
    		h		:	"C_Cpp",
    		hh		:	"C_Cpp",
    		hpp		:	"C_Cpp",
    		ino		:	"C_Cpp",
    		c9search_results	:	"C9Search",
    		cr		:	"Cirru",
    		cirru	:	"Cirru",
    		clj		:	"Clojure",		
    		cljs	:	"Clojure",		
    		CBL		:	"Cobol",		
    		COB		:	"Cobol",		
    		coffee	:	"coffee",		
    		cf	:	"coffee",		
    		cson	:	"coffee",		
    		Cakefile:	"coffee",		
    		cfm		:	"ColdFusion",		
    		cs		:	"CSharp",		
    		csd		:	"Csound_Document",		
    		orc		:	"Csound_Orchestra",		
    		sco		:	"Csound_Score",		
    		css		:	"CSS",		
    		curly	:	"Curly",		
    		d		:	"D",		
    		di		:	"D",		
    		dart	:	"Dart",		
    		diff	:	"Diff",		
    		patch	:	"Diff",		
    		Dockerfile		:	"Dockerfile",		
    		dot		:	"Dot",		
    		drl		:	"Drools",		
    		edi		:	"Edifact",		
    		e		:	"Eiffel",		
    		ge		:	"Eiffel",		
    		ejs		:	"EJS",		
    		ex		:	"Elixir",		
    		exs		:	"Elixir",		
    		elm		:	"Elm",		
    		erl		:	"Erlang",	
    		hrl		:	"Erlang",	
    		frt		:	"Forth",		
    		fs		:	"Forth",		
    		ldr		:	"Forth",		
    		fth		:	"Forth",		
    		4th		:	"Forth",		
    		f		:	"Fortran",		
    		f90		:	"Fortran",		
    		fsi		:	"FSharp",		
    		fs		:	"FSharp",		
    		ml		:	"FSharp",		
    		mli		:	"FSharp",		
    		fsx		:	"FSharp",		
    		fsscript	:	"FSharp",		
    		fsl		:	"FSL",		
    		ftl		:	"FTL",		
    		gcode	:	"Gcode",
    		feature	:	"Gherkin",
    		gitignore		:	"Gitignore",
    		glsl	:	"Glsl",
    		frag	:	"Glsl",
    		vert	:	"Glsl",
    		gbs		:	"Gobstones",
    		go		:	"golang",
    		ggl		:	"GraphQLSchema",
    		groovy	:	"Groovy",
    		haml	:	"HAML",
    		hbs		:	"Handlebars",
    		handlebars		:	"Handlebars",
    		tpl		:	"Handlebars",
    		mustache		:	"Handlebars",
    		hs		:	"Haskell",
    		cabal	:	"Haskell_Cabal",
    		hx		:	"haXe",
    		hjson		:	"Hjson",
    		html		:	"HTML",
    		htm		:	"HTML",
    		xhtml		:	"HTML",
    		vue		:	"HTML",
    		we		:	"HTML",
    		wpy		:	"HTML",
    		eex		:	"HTML_Elixir",
    		erb		:	"HTML_Ruby",
    		rhtml		:	"HTML_Ruby",
    		ini		:	"INI",
    		conf	:	"INI",
    		cfg		:	"INI",
    		prefs	:	"INI",
    		io		:	"Io",
    		jack	:	"Jack",
    		jade	:	"Jade",
    		pug		:	"Jade",
    		java	:	"Java",
    		js		:	"JavaScript",
    		jsm		:	"JavaScript",
    		jsx		:	"JavaScript",
    		json5	:	"JSON5",
    		jq		:	"JSONiq",
    		jsp		:	"JSP",
    		jssm	:	"JSSM",
    		jssm_state	:	"JSSM",
    		jsx		:	"JSX",
    		jl		:	"Julia",
    		kt		:	"Kotlin",
    		kts		:	"Kotlin",
    		tex		:	"LaTeX",
    		latex	:	"LaTeX",
    		ltx		:	"LaTeX",
    		bib		:	"LaTeX",
    		less	:	"LESS",
    		liquid		:	"Liquid",
    		lisp		:	"Lisp",
    		logic		:	"LiveScript",
    		lql			:	"LiveScript",
    		lsl			:	"LSL",
    		lua			:	"Lua",
    		lp			:	"LuaPage",
    		lucene		:	"Lucene",
    		Makefile		:	"Makefile",
    		GNUmakefile		:	"Makefile",
    		makefile		:	"Makefile",
    		OCamlMakefile	:	"Makefile",
    		make			:	"Makefile",
	        md		:	"Markdown",
	        markdown:	"Markdown",
	        mask	:	"Mask",
	        matlab 	:	"MATLAB",
	        php 	: 	"PHP",
	        inc 	: 	"PHP",
	        phtml 	: 	"PHP",
	        shtml 	: 	"PHP",
	        php3 	: 	"PHP",
	        php4 	: 	"PHP",
	        php5	: 	"PHP",
	        phps 	: 	"PHP",
	        phpt 	: 	"PHP",
	        aw	 	: 	"PHP",
	        ctp 	: 	"PHP",
	        module 	: 	"PHP",
	        py		:   "Python",
	        txt		:	"Text",
	        vbs		:    "VBScript",
	        v		:    "Verilog",
	        vh		:    "Verilog",
	        sv		:    "Verilog",
	        svh		:    "Verilog",
	        vhd		:    "VHDL",
	        vhdl	:    "VHDL",
	        xml		:    "XML",
	        rdf		:    "XML",
	        rss		:    "XML",
	        wsdl	:    "XML",
	        xslt	:    "XML",
	        atom	:    "XML",
	        mathml	:    "XML",
	        mml		:    "XML",
	        xul		:    "XML",
	        xbl		:    "XML",
	        xaml	:    "XML",
	        xq		:    "XQuery",
	        yaml	:    "YAML",
	        yml		:    "YAML",
	        xq		:    "XQuery",
	        zeek	:    "Zeek",
	        bro		:    "Zeek",
	};

    //开放给外部的接口
    return {
        textEditorPageInit: function(docInfo, content, tmpSavedContent){
        	textEditorPageInit(docInfo, content, tmpSavedContent);
        },
        saveDoc: function(){
        	saveDoc();
        },
        enableEdit: function(){
        	enableEdit();
        },
        exitEdit: function(){
        	exitEdit();
        },
    };
})();

</script>


