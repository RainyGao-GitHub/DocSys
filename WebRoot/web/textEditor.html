<script src="static/ace-builds/src/ace.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css" media="screen">
  body {
      overflow: hidden;
  }

  #editor {
      margin: 39px 0 0 0;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
  }
</style>
<div id="textEditor">
	<div id="textEditorToolBar" style="height:40px;">
		<div class="editormd-toolbar" style="display: block;">
			<div class="editormd-toolbar-container">
				<ul class="editormd-menu">
					<li><a href="javascript:;" onclick="TextEditor.saveDoc();" title="保存（Ctrl+S）" unselectable="on"><i class="fa fa-save" name="save" unselectable="on"></i></a></li>
					<li class="divider" unselectable="on">|</li>
					<li><a href="javascript:;" title="撤销（Ctrl+Z）" unselectable="on"><i class="fa fa-undo" name="undo" unselectable="on"></i></a></li>
					<li><a href="javascript:;" title="反撤销（Ctrl+Y）" unselectable="on"><i class="fa fa-repeat" name="redo" unselectable="on"></i></a>
					</li><li class="divider" unselectable="on">|</li>
				</ul>
			</div>
		</div>
	</div>
	<div class="textEditorContent" style="min-height: 600px;">
		<pre id="editor">
		</pre>
	</div>
</div>

<script type="text/javascript">
var editor = ace.edit("editor");
editor.setTheme("ace/theme/twilight");
editor.session.setMode("ace/mode/javascript");

var TextEditor = (function () {
    var docInfo = {};
	var docText = "";
	var tmpSavedDocText = "";
	
	function textEditorPageInit(Input_doc, Input_docText, Input_tmpSavedDocText)
	{
		console.log("textEditorPageInit InputDoc:", Input_doc);
		console.log("textEditorPageInit Input_docText:", Input_docText);
		docInfo = Input_doc;		
		docText = Input_docText;
		tmpSavedDocText = Input_tmpSavedDocText;
		
		showText(docText);
  	}
    
	function showText(content)
	{
		editor.setValue(docText);
	}
	    
    function saveDoc()
	{
		var content = editor.getValue();
		console.log("saveDoc docInfo.docId:" + docInfo.docId, content);
		$.ajax({
            url : "/DocSystem/Doc/updateDocContent.do",
            type : "post",
            dataType : "json",
            data : {
                reposId: gReposInfo.id,
            	docId : docInfo.docId,
            	path: docInfo.path,
                name: docInfo.name,
            	content : content,
            	docType: 1, //RealDoc
                shareId: gShareId,
            },
            success : function (ret) {
                if( "ok" == ret.status ){
                    console.log("保存成功 : " , (new Date()).toLocaleDateString());
                    docText = content;

                    bootstrapQ.msg({
								msg : "保存成功 :" + (new Date()).toLocaleDateString(),
								type : 'success',
								time : 1000,
					});
				}else {
                    bootstrapQ.alert("保存失败:"+ret.msgInfo);
                }
            },
            error : function () {
                bootstrapQ.alert("保存失败:服务器异常");
            }
        });
    }

    //开放给外部的接口
    return {
        textEditorPageInit: function(docInfo, content, tmpSavedContent){
        	textEditorPageInit(docInfo, content, tmpSavedContent);
        },
        saveDoc: function(){
        	saveDoc();
        },
    };
})();

</script>


